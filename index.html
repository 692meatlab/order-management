<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë°œì£¼ì„œ ë³€í™˜ ë° ì†¡ì¥ ë“±ë¡ ì‹œìŠ¤í…œ</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    <style>
        :root {
            --primary-color: #3498db;
            --success-color: #27ae60;
            --warning-color: #f39c12;
            --danger-color: #e74c3c;
            --text-color: #2c3e50;
            --text-light: #7f8c8d;
            --border-color: #e9ecef;
            --bg-color: #f5f7fa;
            --sidebar-width: 240px;
            --sidebar-bg: #2c3e50;
            --sidebar-hover: #34495e;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Malgun Gothic', 'Apple SD Gothic Neo', sans-serif;
            background: var(--bg-color);
            min-height: 100vh;
            display: flex;
        }

        /* ì‚¬ì´ë“œë°” */
        .sidebar {
            width: var(--sidebar-width);
            background: var(--sidebar-bg);
            height: 100vh;
            position: fixed;
            left: 0;
            top: 0;
            z-index: 100;
            overflow-y: auto;
            overflow-x: hidden;
        }

        .sidebar::-webkit-scrollbar {
            width: 6px;
        }

        .sidebar::-webkit-scrollbar-track {
            background: transparent;
        }

        .sidebar::-webkit-scrollbar-thumb {
            background: rgba(255,255,255,0.2);
            border-radius: 3px;
        }

        .sidebar::-webkit-scrollbar-thumb:hover {
            background: rgba(255,255,255,0.3);
        }

        .sidebar-header {
            padding: 20px;
            color: white;
            font-size: 16px;
            font-weight: 600;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .sidebar-menu {
            padding: 10px 0;
        }

        .menu-group {
            margin-bottom: 10px;
        }

        .menu-group-title {
            padding: 12px 20px 8px;
            color: #95a5a6;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .menu-item {
            display: flex;
            align-items: center;
            padding: 12px 20px;
            color: #bdc3c7;
            cursor: pointer;
            transition: all 0.2s;
            border-left: 3px solid transparent;
        }

        .menu-item:hover {
            background: var(--sidebar-hover);
            color: white;
        }

        .menu-item.active {
            background: var(--sidebar-hover);
            color: white;
            border-left-color: var(--primary-color);
        }

        .menu-item .icon {
            margin-right: 12px;
            font-size: 16px;
        }

        .menu-item .badge {
            margin-left: auto;
            background: var(--danger-color);
            color: white;
            font-size: 11px;
            font-weight: 700;
            padding: 2px 8px;
            border-radius: 10px;
        }

        /* ì‚¬ìš©ì ë“œë¡­ë‹¤ìš´ ë©”ë‰´ */
        .user-dropdown {
            margin-bottom: 5px;
        }

        .user-dropdown-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 20px;
            color: #ecf0f1;
            cursor: pointer;
            transition: all 0.2s;
            background: rgba(255,255,255,0.05);
            border-left: 3px solid transparent;
        }

        .user-dropdown-header:hover {
            background: var(--sidebar-hover);
        }

        .user-dropdown-header.active {
            background: var(--sidebar-hover);
            border-left-color: var(--success-color);
        }

        .user-dropdown-header .user-name {
            display: flex;
            align-items: center;
            font-weight: 600;
        }

        .user-dropdown-header .user-name .icon {
            margin-right: 10px;
        }

        .user-dropdown-header .arrow {
            transition: transform 0.2s;
        }

        .user-dropdown-header.expanded .arrow {
            transform: rotate(180deg);
        }

        .user-dropdown-menu {
            display: none;
            background: rgba(0,0,0,0.15);
        }

        .user-dropdown-menu.show {
            display: block;
        }

        .user-dropdown-menu .menu-item {
            padding-left: 48px;
            font-size: 13px;
        }

        .user-dropdown-menu .menu-item .icon {
            font-size: 14px;
        }

        /* ì‚¬ìš©ì ê´€ë¦¬ ë²„íŠ¼ */
        .user-management {
            padding: 10px 20px;
            border-top: 1px solid rgba(255,255,255,0.1);
            margin-top: 10px;
        }

        .btn-add-user {
            width: 100%;
            padding: 8px;
            background: rgba(255,255,255,0.1);
            border: 1px dashed rgba(255,255,255,0.3);
            color: #95a5a6;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s;
        }

        .btn-add-user:hover {
            background: rgba(255,255,255,0.15);
            color: #bdc3c7;
        }

        /* ì—°ê²° ìƒíƒœ í‘œì‹œ */
        .connection-status {
            padding: 8px 20px;
            font-size: 11px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .connection-status .dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #e74c3c;
        }

        .connection-status.connected .dot {
            background: #27ae60;
        }

        .connection-status .text {
            color: #7f8c8d;
        }

        /* ë©”ì¸ ì»¨í…ì¸  */
        .main-content {
            margin-left: var(--sidebar-width);
            flex: 1;
            padding: 20px;
            min-height: 100vh;
        }

        .page-header {
            margin-bottom: 24px;
        }

        .page-header h1 {
            color: var(--text-color);
            font-size: 24px;
            font-weight: 600;
        }

        .page-header p {
            color: var(--text-light);
            margin-top: 4px;
        }

        .card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.08);
            padding: 24px;
            margin-bottom: 20px;
        }

        .card-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-color);
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 2px solid var(--primary-color);
        }

        /* í˜ì´ì§€ ì»¨í…ì¸  */
        .page-content {
            display: none;
        }

        .page-content.active {
            display: block;
        }

        /* ì…ë ¥ í¼ */
        .form-row {
            display: flex;
            gap: 20px;
            align-items: flex-end;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        .form-group {
            flex: 1;
            min-width: 200px;
        }

        .form-group label {
            display: block;
            font-weight: 500;
            color: var(--text-color);
            margin-bottom: 8px;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 12px 14px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        /* íŒŒì¼ ì—…ë¡œë“œ */
        .upload-area {
            border: 3px dashed #bdc3c7;
            border-radius: 12px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: #fafbfc;
        }

        .upload-area:hover, .upload-area.dragover {
            border-color: var(--primary-color);
            background: #ebf5fb;
        }

        .upload-area input {
            display: none;
        }

        .upload-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }

        .upload-text {
            color: var(--text-light);
            font-size: 16px;
        }

        .file-info {
            margin-top: 16px;
            padding: 12px;
            background: #d4edda;
            border-radius: 8px;
            color: #155724;
            display: none;
        }

        .file-info.show {
            display: block;
        }

        /* ë²„íŠ¼ */
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background: #2980b9;
        }

        .btn-success {
            background: var(--success-color);
            color: white;
        }

        .btn-success:hover {
            background: #219a52;
        }

        .btn-warning {
            background: var(--warning-color);
            color: white;
        }

        .btn-warning:hover {
            background: #d68910;
        }

        .btn-info {
            background: #17a2b8;
            color: white;
        }

        .btn-info:hover {
            background: #138496;
        }

        .btn-danger {
            background: var(--danger-color);
            color: white;
        }

        .btn-danger:hover {
            background: #c0392b;
        }

        .btn-secondary {
            background: #95a5a6;
            color: white;
        }

        .btn-secondary:hover {
            background: #7f8c8d;
        }

        .btn-large {
            padding: 16px 48px;
            font-size: 16px;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 12px;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn-group {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            margin-top: 20px;
        }

        .convert-section {
            text-align: center;
            margin-top: 30px;
        }

        /* í…Œì´ë¸” */
        .table-container {
            overflow-x: auto;
            margin-top: 16px;
            max-height: 500px;
            overflow-y: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
            table-layout: auto;
        }

        th, td {
            padding: 10px 8px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        th {
            background: #f8f9fa;
            font-weight: 600;
            color: var(--text-color);
            position: sticky;
            top: 0;
            z-index: 10;
        }

        /* í•„í„°/ì •ë ¬ í—¤ë” ìŠ¤íƒ€ì¼ */
        .th-filter {
            position: relative;
            cursor: default;
            user-select: none;
        }

        .th-filter-wrapper {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .th-filter:hover .th-content {
            background: #e9ecef;
        }

        .th-content {
            display: flex;
            align-items: center;
            gap: 4px;
            flex: 1;
            cursor: pointer;
            padding: 2px 4px;
            border-radius: 4px;
        }

        .th-title {
            flex: 1;
        }

        .th-sort-icons {
            display: flex;
            align-items: center;
            gap: 1px;
            font-size: 10px;
            color: #888;
        }

        .th-sort-icons .sort-icon {
            opacity: 0.3;
        }

        .th-sort-icons .sort-icon.active {
            opacity: 1;
            color: var(--primary-color);
        }

        .filter-icon-btn {
            cursor: pointer;
            font-size: 10px;
            color: #888;
            padding: 2px 4px;
            border-radius: 3px;
            opacity: 0.5;
            flex-shrink: 0;
        }

        .filter-icon-btn:hover {
            background: #e3f2fd;
            opacity: 1;
            color: var(--primary-color);
        }

        .filter-icon-btn.active {
            opacity: 1;
            color: #e74c3c;
            background: #ffebee;
        }

        /* í•„í„° ë“œë¡­ë‹¤ìš´ */
        .filter-dropdown {
            position: fixed;
            min-width: 220px;
            max-width: 320px;
            max-height: 350px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 9999;
            display: none;
            overflow: hidden;
        }

        .filter-dropdown.show {
            display: block;
        }

        .filter-header {
            padding: 10px 12px;
            border-bottom: 1px solid #eee;
            display: flex;
            gap: 8px;
        }

        .filter-header input {
            flex: 1;
            padding: 6px 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 12px;
        }

        .filter-actions {
            padding: 8px 12px;
            border-bottom: 1px solid #eee;
            display: flex;
            gap: 8px;
        }

        .filter-actions button {
            flex: 1;
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            font-size: 11px;
            cursor: pointer;
        }

        .filter-actions .btn-sort-asc {
            background: #e3f2fd;
            color: #1565c0;
        }

        .filter-actions .btn-sort-desc {
            background: #fce4ec;
            color: #c62828;
        }

        .filter-actions .btn-clear {
            background: #f5f5f5;
            color: #666;
        }

        .filter-select-actions {
            padding: 8px 12px;
            border-bottom: 1px solid #eee;
            display: flex;
            gap: 6px;
        }

        .filter-select-actions button {
            flex: 1;
            padding: 6px 8px;
            border: none;
            border-radius: 4px;
            font-size: 11px;
            cursor: pointer;
            font-weight: 500;
        }

        .filter-select-actions .btn-select-all {
            background: #e8f5e9;
            color: #2e7d32;
        }

        .filter-select-actions .btn-deselect-all {
            background: #ffebee;
            color: #c62828;
        }

        .filter-select-actions .btn-apply-filter {
            background: #1976d2;
            color: white;
        }

        .filter-select-actions .btn-apply-filter:hover {
            background: #1565c0;
        }

        .filter-list {
            max-height: 200px;
            overflow-y: auto;
            padding: 8px 0;
        }

        .filter-item {
            padding: 6px 12px;
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            font-size: 12px;
        }

        .filter-item:hover {
            background: #f5f5f5;
        }

        .filter-item input[type="checkbox"] {
            margin: 0;
        }

        .filter-item-label {
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .filter-item-count {
            color: #888;
            font-size: 11px;
        }

        /* ìˆ˜ì • ê°€ëŠ¥í•œ ì…ë ¥ í•„ë“œ */
        .editable-date {
            padding: 4px 6px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 12px;
            width: 120px;
            background: #fff;
        }

        .editable-date:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
        }

        .editable-note {
            padding: 4px 6px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 12px;
            width: 100%;
            min-width: 80px;
            background: #fff;
        }

        .editable-note:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
        }

        .editable-note::placeholder {
            color: #bbb;
            font-size: 11px;
        }

        /* ì¼ê´„ ë‚ ì§œ ì§€ì • */
        .batch-date-group {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-left: auto;
            padding: 6px 12px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }

        .batch-label {
            font-size: 13px;
            font-weight: 500;
            color: #495057;
            white-space: nowrap;
        }

        .batch-date-input {
            padding: 6px 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 13px;
        }

        .batch-date-input:focus {
            outline: none;
        }

        /* ì „ì²´ì£¼ë¬¸ê´€ë¦¬ ìƒíƒœ ë°°ì§€ */
        .status-badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 500;
        }

        .status-badge.shipped {
            background: #e8f5e9;
            color: #2e7d32;
        }

        .status-badge.not-shipped {
            background: #fff3e0;
            color: #e65100;
        }

        .status-badge.paid {
            background: #e3f2fd;
            color: #1565c0;
        }

        .status-badge.not-paid {
            background: #fce4ec;
            color: #c62828;
        }

        .status-badge.issued {
            background: #f3e5f5;
            color: #7b1fa2;
        }

        .status-badge.not-issued {
            background: #efebe9;
            color: #5d4037;
            border-color: var(--primary-color);
        }

        tr:hover {
            background: #f8f9fa;
        }

        td input[type="text"] {
            width: 100%;
            min-width: 60px;
            padding: 5px 6px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 12px;
        }

        td input[type="text"]:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .checkbox-cell {
            width: 36px;
            text-align: center;
        }

        .checkbox-cell input {
            width: 16px;
            height: 16px;
            cursor: pointer;
        }

        .row-num {
            width: 40px;
            color: #95a5a6;
            font-size: 11px;
            text-align: center;
        }

        /* ìƒíƒœ ë©”ì‹œì§€ */
        .status {
            padding: 12px 16px;
            border-radius: 8px;
            margin-top: 16px;
            display: none;
        }

        .status.show {
            display: block;
        }

        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        /* ê²°ê³¼ ìš”ì•½ */
        .result-summary {
            display: flex;
            gap: 16px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .summary-item {
            background: #f8f9fa;
            padding: 14px 20px;
            border-radius: 8px;
            text-align: center;
            min-width: 100px;
        }

        .summary-item .number {
            font-size: 28px;
            font-weight: 700;
            color: var(--primary-color);
        }

        .summary-item .label {
            color: var(--text-light);
            font-size: 13px;
            margin-top: 4px;
        }

        /* ì„¤ì • ê·¸ë¦¬ë“œ */
        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 16px;
        }

        /* ë¡œë”© */
        .loading {
            display: none;
            text-align: center;
            padding: 40px;
        }

        .loading.show {
            display: block;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 16px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* ë¹ˆ ìƒíƒœ */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-light);
        }

        .empty-state .icon {
            font-size: 64px;
            margin-bottom: 16px;
        }

        /* ë°œì£¼ì²˜ íƒœê·¸ */
        .vendor-tag {
            display: inline-block;
            padding: 3px 8px;
            background: #e3f2fd;
            color: #1976d2;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
        }

        /* ì›ë³¸íŒŒì¼ëª… */
        .source-file {
            display: inline-block;
            max-width: 150px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            font-size: 10px;
            color: #95a5a6;
            cursor: help;
        }

        /* SKU ê´€ë¦¬ ë ˆì´ì•„ì›ƒ */
        .sku-management {
            display: flex;
            gap: 24px;
        }

        .sku-vendor-list {
            width: 250px;
            flex-shrink: 0;
        }

        .sku-product-list {
            flex: 1;
        }

        .vendor-list-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 16px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .vendor-list-item:hover {
            border-color: var(--primary-color);
        }

        .vendor-list-item.active {
            border-color: var(--primary-color);
            background: #ebf5fb;
        }

        .vendor-list-item .vendor-name {
            font-weight: 500;
        }

        .vendor-list-item .vendor-count {
            font-size: 12px;
            color: var(--text-light);
        }

        .vendor-list-item .vendor-actions {
            opacity: 0;
            transition: opacity 0.2s;
        }

        .vendor-list-item:hover .vendor-actions {
            opacity: 1;
        }

        .vendor-list-item.active .vendor-actions {
            opacity: 1;
        }

        .add-vendor-form {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
        }

        .add-vendor-form input {
            flex: 1;
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }

        .sku-table-actions {
            display: flex;
            gap: 12px;
            margin-bottom: 16px;
            flex-wrap: wrap;
        }

        .sku-search {
            flex: 1;
            min-width: 200px;
        }

        .sku-search input {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }

        /* SKU ë§¤ì¹­ í‘œì‹œ */
        .sku-matched {
            background: #e8f5e9;
            color: #2e7d32;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 10px;
            margin-left: 4px;
        }

        .sku-unmatched {
            background: #ffebee;
            color: #c62828;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 10px;
            white-space: nowrap;
        }

        /* ë‹¨ìœ„ ë°°ì§€ */
        .unit-badge {
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 500;
        }

        .unit-weight {
            background: #e3f2fd;
            color: #1565c0;
        }

        .unit-unit {
            background: #f3e5f5;
            color: #7b1fa2;
        }

        /* ì†¡ì¥ ë“±ë¡ ìƒíƒœ */
        .invoice-registered {
            background: #e8f5e9;
            color: #2e7d32;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
        }

        .invoice-pending {
            background: #fff3e0;
            color: #e65100;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
        }

        .sku-original {
            font-size: 10px;
            color: #95a5a6;
            display: block;
            margin-top: 2px;
        }

        /* êµ¬ì„±í’ˆ ì•„ì´í…œ */
        .composition-item {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr auto;
            gap: 12px;
            margin-bottom: 12px;
            padding: 16px;
            background: #f8f9fa;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            align-items: end;
        }

        .composition-item .comp-field {
            display: flex;
            flex-direction: column;
        }

        .composition-item .comp-field label {
            font-size: 12px;
            margin-bottom: 6px;
            color: var(--text-light);
            font-weight: 500;
        }

        .composition-item .comp-field input,
        .composition-item .comp-field select {
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }

        .composition-item .btn-danger {
            padding: 10px 16px;
        }

        /* ì›ê°€ ì •ë³´ ë°•ìŠ¤ */
        .cost-info-box {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            margin-top: 20px;
        }

        .cost-info-box h4 {
            margin-bottom: 12px;
            font-size: 16px;
        }

        .cost-info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 16px;
        }

        .cost-info-item {
            text-align: center;
        }

        .cost-info-item .value {
            font-size: 24px;
            font-weight: 700;
        }

        .cost-info-item .label {
            font-size: 12px;
            opacity: 0.9;
            margin-top: 4px;
        }

        /* ëª¨ë‹¬ */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-overlay.show {
            display: flex;
        }

        .modal {
            background: white;
            border-radius: 12px;
            padding: 24px;
            max-width: 700px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-header h3 {
            font-size: 18px;
            color: var(--text-color);
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--text-light);
        }

        /* ì›ê°€ê´€ë¦¬ ê·¸ë¦¬ë“œ */
        .cost-management-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
        }

        @media (max-width: 1024px) {
            .cost-management-grid {
                grid-template-columns: 1fr;
            }
        }

        /* ë‹¬ë ¥ */
        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 12px;
        }

        .calendar-header h2 {
            margin: 0;
            font-size: 1.5em;
        }

        .calendar-nav {
            display: flex;
            gap: 10px;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 8px;
        }

        .calendar-day-header {
            text-align: center;
            font-weight: 600;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 8px;
            color: var(--text-color);
        }

        .calendar-day-header.sunday { color: #dc3545; }
        .calendar-day-header.saturday { color: #0d6efd; }

        .calendar-day {
            min-height: 100px;
            padding: 10px;
            background: white;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .calendar-day:hover {
            border-color: var(--primary-color);
            box-shadow: 0 4px 12px rgba(52, 152, 219, 0.2);
        }

        .calendar-day.other-month {
            background: #f8f9fa;
            opacity: 0.5;
        }

        .calendar-day.today {
            border-color: var(--primary-color);
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
        }

        .calendar-day-number {
            font-weight: 600;
            font-size: 1.1em;
            margin-bottom: 6px;
            color: var(--text-color);
        }

        .calendar-day.sunday .calendar-day-number { color: #dc3545; }
        .calendar-day.saturday .calendar-day-number { color: #0d6efd; }

        .calendar-day-orders {
            font-size: 11px;
            color: var(--text-light);
        }

        .calendar-order-item {
            background: #e3f2fd;
            color: #1976d2;
            padding: 3px 6px;
            margin: 2px 0;
            border-radius: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            font-size: 10px;
        }

        .calendar-order-item.shipped {
            background: #e8f5e9;
            color: #2e7d32;
        }

        .calendar-order-item.pending {
            background: #fff3e0;
            color: #e65100;
        }

        .calendar-order-count {
            background: var(--primary-color);
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 11px;
            font-weight: 600;
        }

        /* ë°œì£¼ëŸ‰ ê²°ê³¼ ë°•ìŠ¤ */
        .result-box {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 24px;
            border-radius: 12px;
            margin-top: 20px;
        }

        .result-box h3 {
            margin-bottom: 16px;
            font-size: 1.3em;
        }

        .result-box h4 {
            margin-top: 16px;
            margin-bottom: 10px;
            font-size: 1.1em;
            border-bottom: 1px solid rgba(255,255,255,0.3);
            padding-bottom: 8px;
        }

        .result-item {
            padding: 6px 0;
            border-bottom: 1px solid rgba(255,255,255,0.15);
            font-size: 0.95em;
        }

        .result-item:last-child {
            border-bottom: none;
        }

        .result-item strong {
            display: inline-block;
            min-width: 150px;
        }

        .result-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 16px;
        }

        .result-section {
            background: rgba(255,255,255,0.1);
            padding: 16px;
            border-radius: 8px;
        }

        .result-section h4 {
            margin-top: 0;
            border-bottom: none;
        }

        /* ë‚ ì§œ ëª¨ë‹¬ */
        .day-modal-orders {
            max-height: 300px;
            overflow-y: auto;
        }

        .day-order-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 8px;
        }

        .day-order-item .order-info {
            flex: 1;
        }

        .day-order-item .order-name {
            font-weight: 600;
            color: var(--text-color);
        }

        .day-order-item .order-sku {
            font-size: 12px;
            color: var(--text-light);
        }

        .day-order-item .order-qty {
            font-size: 18px;
            font-weight: 700;
            color: var(--primary-color);
            margin: 0 16px;
        }

        /* ë°˜ì‘í˜• */
        @media (max-width: 1024px) {
            .sku-management {
                flex-direction: column;
            }

            .sku-vendor-list {
                width: 100%;
            }

            .composition-item {
                grid-template-columns: 1fr 1fr;
            }
        }

        @media (max-width: 768px) {
            .sidebar {
                width: 60px;
            }

            .sidebar-header span,
            .menu-group-title,
            .menu-item span:not(.icon):not(.badge) {
                display: none;
            }

            .menu-item {
                justify-content: center;
                padding: 16px;
            }

            .menu-item .icon {
                margin-right: 0;
            }

            .main-content {
                margin-left: 60px;
            }

            .form-row {
                flex-direction: column;
            }

            .btn-group {
                flex-direction: column;
            }

            .btn {
                width: 100%;
                justify-content: center;
            }

            .composition-item {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- ì‚¬ì´ë“œë°” -->
    <aside class="sidebar">
        <div class="sidebar-header">
            <span>ì£¼ë¬¸ê´€ë¦¬ ì‹œìŠ¤í…œ</span>
        </div>
        <div class="connection-status" id="connection-status">
            <span class="dot"></span>
            <span class="text">ì—°ê²° ì¤‘...</span>
        </div>
        <nav class="sidebar-menu">
            <div class="menu-group">
                <div class="menu-group-title">ê³µí†µ</div>
                <div class="menu-item active" data-page="dashboard">
                    <span class="icon">ğŸ“Š</span>
                    <span>ëŒ€ì‹œë³´ë“œ</span>
                </div>
                <div class="menu-item" data-page="integrated-view">
                    <span class="icon">ğŸ“‘</span>
                    <span>í†µí•©ì¡°íšŒ</span>
                </div>
            </div>
            <div class="menu-group">
                <div class="menu-group-title">ì„¤ì •</div>
                <div class="menu-item" data-page="cost-management">
                    <span class="icon">ğŸ’°</span>
                    <span>ì›ê°€ê´€ë¦¬</span>
                </div>
                <div class="menu-item" data-page="sku-products">
                    <span class="icon">ğŸ·ï¸</span>
                    <span>SKUìƒí’ˆê´€ë¦¬</span>
                </div>
                <div class="menu-item" data-page="vendor-mapping">
                    <span class="icon">ğŸ”—</span>
                    <span>ê±°ë˜ì²˜ë³„ ìƒí’ˆê´€ë¦¬</span>
                </div>
                <div class="menu-item" data-page="settings">
                    <span class="icon">ğŸšš</span>
                    <span>ê±°ë˜ì²˜ë³„ íƒë°°ê´€ë¦¬</span>
                </div>
            </div>

            <!-- ì‚¬ìš©ìë³„ ë©”ë‰´ (ë™ì  ìƒì„±) -->
            <div class="menu-group" id="user-menus-container">
                <div class="menu-group-title">ì‚¬ìš©ì</div>
                <!-- ì‚¬ìš©ì ë“œë¡­ë‹¤ìš´ë“¤ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë¨ -->
            </div>

            <!-- ì‚¬ìš©ì ì¶”ê°€ ë²„íŠ¼ -->
            <div class="user-management">
                <button class="btn-add-user" id="btn-add-user">+ ì‚¬ìš©ì ì¶”ê°€</button>
            </div>
        </nav>
    </aside>

    <!-- ë©”ì¸ ì»¨í…ì¸  -->
    <main class="main-content">
        <!-- ëŒ€ì‹œë³´ë“œ í˜ì´ì§€ -->
        <div id="dashboard" class="page-content active">
            <div class="page-header">
                <h1>ëŒ€ì‹œë³´ë“œ</h1>
                <p>ë°°ì†¡ ì¼ì • ê´€ë¦¬ ë° ë°œì£¼ëŸ‰ ê³„ì‚°</p>
            </div>

            <!-- ë‹¬ë ¥ í—¤ë” -->
            <div class="card">
                <div class="calendar-header">
                    <div class="calendar-nav">
                        <button class="btn btn-secondary" onclick="changeMonth(-1)">â—€ ì´ì „</button>
                    </div>
                    <h2 id="calendar-title">2025ë…„ 1ì›”</h2>
                    <div class="calendar-nav">
                        <button class="btn btn-secondary" onclick="changeMonth(1)">ë‹¤ìŒ â–¶</button>
                        <button class="btn btn-primary" onclick="goToToday()">ì˜¤ëŠ˜</button>
                    </div>
                </div>

                <div class="calendar-grid" id="calendar-grid"></div>
            </div>

            <!-- ê¸°ê°„ë³„ ë°œì£¼ëŸ‰ ê³„ì‚° -->
            <div class="card">
                <div class="card-title">ê¸°ê°„ë³„ ë°œì£¼ëŸ‰ ê³„ì‚°</div>
                <div class="form-row">
                    <div class="form-group">
                        <label>ì‹œì‘ì¼</label>
                        <input type="date" id="range-start">
                    </div>
                    <div class="form-group">
                        <label>ì¢…ë£Œì¼</label>
                        <input type="date" id="range-end">
                    </div>
                    <div class="form-group" style="flex: 0;">
                        <label>&nbsp;</label>
                        <button class="btn btn-success" onclick="calculateRangeOrder()">ë°œì£¼ëŸ‰ ê³„ì‚°</button>
                    </div>
                </div>
                <div id="range-result" style="overflow-x: auto;"></div>
            </div>
        </div>

        <!-- í†µí•©ì¡°íšŒ í˜ì´ì§€ -->
        <div id="integrated-view" class="page-content">
            <div class="page-header">
                <h1>í†µí•©ì¡°íšŒ</h1>
                <p>ëª¨ë“  ì‚¬ìš©ìì˜ ì£¼ë¬¸ ë°ì´í„°ë¥¼ í†µí•©í•˜ì—¬ ì¡°íšŒí•©ë‹ˆë‹¤</p>
            </div>

            <div class="card">
                <div class="card-title" style="display: flex; justify-content: space-between; align-items: center;">
                    <span>ì „ì²´ ì£¼ë¬¸ í˜„í™©</span>
                    <button class="btn btn-primary" onclick="refreshIntegratedView()">ìƒˆë¡œê³ ì¹¨</button>
                </div>

                <!-- í•„í„° ì˜ì—­ -->
                <div style="display: flex; gap: 12px; margin-bottom: 16px; flex-wrap: wrap;">
                    <div class="form-group" style="margin: 0;">
                        <label style="font-size: 12px;">ì‚¬ìš©ì</label>
                        <select id="integrated-user-filter" style="padding: 6px 10px;">
                            <option value="">ì „ì²´</option>
                        </select>
                    </div>
                    <div class="form-group" style="margin: 0;">
                        <label style="font-size: 12px;">ê¸°ê°„</label>
                        <div style="display: flex; gap: 4px; align-items: center;">
                            <input type="date" id="integrated-date-from" style="padding: 5px;">
                            <span>~</span>
                            <input type="date" id="integrated-date-to" style="padding: 5px;">
                        </div>
                    </div>
                    <div class="form-group" style="margin: 0;">
                        <label style="font-size: 12px;">ìƒíƒœ</label>
                        <select id="integrated-status-filter" style="padding: 6px 10px;">
                            <option value="">ì „ì²´</option>
                            <option value="pending">ë¯¸ì¶œê³ </option>
                            <option value="shipped">ì¶œê³ ì™„ë£Œ</option>
                        </select>
                    </div>
                    <div style="display: flex; align-items: flex-end;">
                        <button class="btn btn-secondary" onclick="applyIntegratedFilters()">í•„í„° ì ìš©</button>
                    </div>
                </div>

                <!-- ìš”ì•½ ì •ë³´ -->
                <div class="result-summary" id="integrated-summary"></div>

                <!-- í†µí•© í…Œì´ë¸” -->
                <div class="table-container" id="integrated-table" style="max-height: 600px; overflow-y: auto;"></div>

                <!-- ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ -->
                <div class="btn-group" style="margin-top: 16px;">
                    <button class="btn btn-success" onclick="downloadIntegratedExcel()">ì—‘ì…€ ë‹¤ìš´ë¡œë“œ</button>
                    <button class="btn btn-info" onclick="aggregateIntegratedView()">í†µí•© ì§‘ê³„</button>
                </div>
            </div>
        </div>

        <!-- ë°œì£¼ì„œ ë³€í™˜ í˜ì´ì§€ -->
        <div id="convert" class="page-content">
            <div class="page-header">
                <h1>ë°œì£¼ì„œ ë³€í™˜</h1>
                <p>ì—‘ì…€ ë°œì£¼ì„œë¥¼ ì—…ë¡œë“œí•˜ì—¬ í‘œì¤€ í˜•ì‹ìœ¼ë¡œ ë³€í™˜í•©ë‹ˆë‹¤</p>
            </div>

            <div class="card">
                <div class="upload-area" id="upload-area">
                    <input type="file" id="file-input" accept=".xlsx,.xls" multiple>
                    <div class="upload-icon">ğŸ“</div>
                    <div class="upload-text">í´ë¦­í•˜ê±°ë‚˜ ì—‘ì…€ íŒŒì¼ì„ ë“œë˜ê·¸í•˜ì„¸ìš”<br>ì—¬ëŸ¬ íŒŒì¼ ë™ì‹œ ì„ íƒ ê°€ëŠ¥ (.xlsx, .xls)</div>
                </div>

                <div style="text-align: center; margin-top: 12px;">
                    <button type="button" id="btn-download-template" style="background: none; border: none; color: var(--primary-color); font-size: 14px; cursor: pointer; padding: 8px 16px;">
                        <span style="margin-right: 4px;">ğŸ“¥</span>ë°œì£¼ì„œ ì–‘ì‹ ë‹¤ìš´ë¡œë“œ
                    </button>
                </div>

                <div class="file-info" id="file-info"></div>

                <div class="form-row" style="margin-top: 16px;">
                    <div class="form-group">
                        <label>ë°œì£¼ì²˜ ì´ë¦„ <span style="color: #e74c3c;">*</span></label>
                        <div style="display: flex; gap: 8px; align-items: center;">
                            <select id="vendor-name" required style="flex: 1;">
                                <option value="">ë°œì£¼ì²˜ ì„ íƒ (í•„ìˆ˜)...</option>
                            </select>
                            <button type="button" class="btn btn-secondary" id="btn-toggle-vendor-add" style="white-space: nowrap; padding: 8px 12px;" title="ìƒˆ ë°œì£¼ì²˜ ì¶”ê°€">+ ì¶”ê°€</button>
                        </div>
                        <div id="vendor-quick-add" style="display: none; margin-top: 8px;">
                            <div style="display: flex; gap: 8px; align-items: center;">
                                <input type="text" id="vendor-quick-input" placeholder="ìƒˆ ë°œì£¼ì²˜ ì´ë¦„ ì…ë ¥" style="flex: 1;">
                                <button type="button" class="btn btn-success" id="btn-vendor-quick-save" style="white-space: nowrap;">ì €ì¥</button>
                                <button type="button" class="btn btn-secondary" id="btn-vendor-quick-cancel" style="white-space: nowrap;">ì·¨ì†Œ</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="convert-section">
                    <button class="btn btn-success btn-large" id="btn-convert" disabled>ë³€í™˜í•˜ê¸°</button>
                </div>

                <div class="status" id="status-msg"></div>
            </div>
        </div>

        <!-- ë³€í™˜ì™„ë£Œ í˜ì´ì§€ -->
        <div id="result" class="page-content">
            <div class="page-header">
                <h1>ë³€í™˜ì™„ë£Œ</h1>
                <p>ë³€í™˜ëœ ë°ì´í„°ë¥¼ í™•ì¸í•˜ê³  í™•ì • ëª©ë¡ì— ì¶”ê°€í•©ë‹ˆë‹¤</p>
            </div>

            <div class="card">
                <div id="result-content">
                    <div class="empty-state">
                        <div class="icon">ğŸ“‹</div>
                        <div>ë³€í™˜ëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.<br>ë°œì£¼ì„œ ë³€í™˜ ë©”ë‰´ì—ì„œ íŒŒì¼ì„ ì—…ë¡œë“œí•˜ê³  ë³€í™˜í•´ì£¼ì„¸ìš”.</div>
                    </div>
                </div>

                <div id="result-data" style="display: none;">
                    <div class="result-summary" id="result-summary"></div>

                    <div class="btn-group" style="margin-top: 0; margin-bottom: 16px;">
                        <button class="btn btn-primary" id="btn-select-all">ì „ì²´ ì„ íƒ</button>
                        <button class="btn btn-warning" id="btn-deselect-all">ì „ì²´ í•´ì œ</button>
                        <button class="btn btn-secondary" id="btn-bulk-edit">ì„ íƒí•­ëª© ì¼ê´„ì…ë ¥</button>
                        <button class="btn btn-success" id="btn-add-to-confirmed">ì„ íƒí•­ëª© â†’ ë³€í™˜í™•ì •</button>
                    </div>

                    <div class="table-container" id="result-table"></div>
                </div>

                <div class="status" id="result-status"></div>
            </div>
        </div>

        <!-- ë³€í™˜í™•ì • í˜ì´ì§€ -->
        <div id="confirmed" class="page-content">
            <div class="page-header">
                <h1>ë³€í™˜í™•ì •</h1>
                <p>í™•ì •ëœ ì£¼ë¬¸ ë°ì´í„°ë¥¼ ê´€ë¦¬í•˜ê³  ì†¡ì¥ì„ ë“±ë¡í•©ë‹ˆë‹¤</p>
            </div>

            <div class="card">
                <div id="confirmed-content">
                    <div class="empty-state">
                        <div class="icon">âœ…</div>
                        <div>í™•ì •ëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.<br>ë³€í™˜ì™„ë£Œ ë©”ë‰´ì—ì„œ ë°ì´í„°ë¥¼ ì„ íƒí•˜ê³  "ë³€í™˜í™•ì •"ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.</div>
                    </div>
                </div>

                <div id="confirmed-data" style="display: none;">
                    <div class="result-summary" id="confirmed-summary"></div>

                    <div class="btn-group" style="margin-top: 0; margin-bottom: 16px;">
                        <button class="btn btn-primary" id="btn-confirmed-select-all">ì „ì²´ ì„ íƒ</button>
                        <button class="btn btn-warning" id="btn-confirmed-deselect-all">ì „ì²´ í•´ì œ</button>
                        <button class="btn btn-info" id="btn-confirmed-calculate">ë°œì£¼ëŸ‰ ê³„ì‚°</button>
                        <button class="btn btn-danger" id="btn-remove-selected">ì„ íƒí•­ëª© ì‚­ì œ</button>
                        <button class="btn btn-danger" id="btn-clear-all">ì „ì²´ ì‚­ì œ</button>
                        <button class="btn btn-secondary" id="btn-reset-filters" onclick="window.resetAllFilters()" style="display: none;">í•„í„° ì´ˆê¸°í™”</button>
                    </div>

                    <div class="table-container" id="confirmed-table"></div>

                    <div class="btn-group" style="flex-wrap: wrap; gap: 10px; align-items: center; justify-content: flex-start;">
                        <div class="batch-date-group">
                            <span class="batch-label">ì¶œê³ ìš”ì²­ì¼ ì¼ê´„ì§€ì •:</span>
                            <input type="date" id="batch-release-date" class="batch-date-input">
                            <button class="btn btn-success" onclick="window.applyBatchReleaseDate()">ì„ íƒí•­ëª© ì ìš©</button>
                        </div>
                        <button class="btn btn-success btn-large" id="btn-download">ì—‘ì…€ ë‹¤ìš´ë¡œë“œ</button>
                        <button class="btn btn-primary btn-large" id="btn-register">Bíƒ€ì… ì¼ê´„ë“±ë¡</button>
                    </div>
                </div>

                <div class="status" id="confirmed-status"></div>
            </div>
        </div>

        <!-- ì „ì²´ì£¼ë¬¸ê´€ë¦¬ í˜ì´ì§€ -->
        <div id="order-management" class="page-content">
            <div class="page-header">
                <h1>ì „ì²´ì£¼ë¬¸ê´€ë¦¬</h1>
                <p>ì¶œê³ , ì†¡ì¥, ê²°ì œ, ê³„ì‚°ì„œ ë°œí–‰ í˜„í™©ì„ í†µí•© ê´€ë¦¬í•©ë‹ˆë‹¤</p>
            </div>

            <div class="card">
                <div id="order-management-content">
                    <div class="empty-state">
                        <div class="icon">ğŸ“¦</div>
                        <div>ë“±ë¡ëœ ì£¼ë¬¸ì´ ì—†ìŠµë‹ˆë‹¤.<br>ë³€í™˜í™•ì •ì—ì„œ "Bíƒ€ì… ì¼ê´„ë“±ë¡"ì„ í†µí•´ ì£¼ë¬¸ì„ ë“±ë¡í•˜ì„¸ìš”.</div>
                    </div>
                </div>

                <div id="order-management-data" style="display: none;">
                    <!-- ë‚ ì§œ í•„í„° ì˜ì—­ -->
                    <div style="display: flex; gap: 12px; margin-bottom: 16px; flex-wrap: wrap; align-items: flex-end;">
                        <div class="form-group" style="margin: 0;">
                            <label style="font-size: 12px;">ì¶œê³ ìš”ì²­ì¼ ê¸°ê°„</label>
                            <div style="display: flex; gap: 4px; align-items: center;">
                                <input type="date" id="order-date-from" style="padding: 5px;">
                                <span>~</span>
                                <input type="date" id="order-date-to" style="padding: 5px;">
                            </div>
                        </div>
                        <div class="form-group" style="margin: 0;">
                            <label style="font-size: 12px;">ìƒíƒœ</label>
                            <select id="order-status-filter" style="padding: 6px 10px;">
                                <option value="">ì „ì²´</option>
                                <option value="pending">ë¯¸ì¶œê³ </option>
                                <option value="shipped">ì¶œê³ ì™„ë£Œ</option>
                            </select>
                        </div>
                        <button class="btn btn-secondary" onclick="applyOrderDateFilter()">í•„í„° ì ìš©</button>
                        <button class="btn btn-secondary" onclick="clearOrderDateFilter()" style="background: #95a5a6;">í•„í„° ì´ˆê¸°í™”</button>
                    </div>

                    <div class="result-summary" id="order-management-summary"></div>

                    <div class="btn-group" style="margin-top: 0; margin-bottom: 16px;">
                        <button class="btn btn-primary" id="btn-order-select-all">ì „ì²´ ì„ íƒ</button>
                        <button class="btn btn-warning" id="btn-order-deselect-all">ì „ì²´ í•´ì œ</button>
                        <button class="btn btn-secondary" id="btn-order-bulk-edit">ì„ íƒí•­ëª© ì¼ê´„ìˆ˜ì •</button>
                        <button class="btn btn-danger" id="btn-order-delete-selected">ì„ íƒí•­ëª© ì‚­ì œ</button>
                        <button class="btn btn-primary" id="btn-order-calculate">ë°œì£¼ëŸ‰ ê³„ì‚°</button>
                        <button class="btn btn-info" id="btn-order-aggregate">ì§‘ê³„</button>
                        <button class="btn btn-success" id="btn-order-mark-shipped">ì¶œê³ ì™„ë£Œ ì²˜ë¦¬</button>
                        <button class="btn btn-info" id="btn-order-mark-paid">ê²°ì œì™„ë£Œ ì²˜ë¦¬</button>
                        <button class="btn btn-secondary" id="btn-order-mark-invoice-issued">ê³„ì‚°ì„œë°œí–‰ ì²˜ë¦¬</button>
                        <button class="btn btn-secondary" id="btn-order-reset-filters" style="display: none;">í•„í„° ì´ˆê¸°í™”</button>
                    </div>

                    <div class="table-container" id="order-management-table"></div>

                    <div class="btn-group" style="justify-content: flex-start; gap: 10px; align-items: center;">
                        <button class="btn btn-success btn-large" id="btn-order-download">ì—‘ì…€ ë‹¤ìš´ë¡œë“œ</button>
                        <button class="btn btn-warning btn-large" id="btn-order-btype-download">Bíƒ€ì… ë‹¤ìš´ë¡œë“œ</button>
                        <button class="btn btn-info btn-large" id="btn-order-vendor-download">ë°œì£¼ì²˜ë³„ ë‹¤ìš´ë¡œë“œ</button>
                        <div style="display: flex; flex-direction: column; align-items: flex-start;">
                            <button class="btn btn-primary btn-large" id="btn-upload-invoice">ì†¡ì¥ë²ˆí˜¸ ì—…ë¡œë“œ</button>
                            <span style="font-size: 11px; color: #666; margin-top: 2px;">ì£¼ë¬¸ì‹¤ì ì¡°íšŒ íŒŒì¼ ì—…ë¡œë“œ</span>
                        </div>
                        <input type="file" id="invoice-file-input" accept=".xlsx,.xls" style="display: none;">
                    </div>
                </div>

                <div class="status" id="order-management-status"></div>
            </div>
        </div>

        <!-- ì›ê°€ê´€ë¦¬ í˜ì´ì§€ -->
        <div id="cost-management" class="page-content">
            <div class="page-header">
                <h1>ì›ê°€ê´€ë¦¬</h1>
                <p>ë¶€ìœ„ë³„ ì›ê°€ì™€ í¬ì¥ë¹„ë¥¼ ë“±ë¡í•˜ì—¬ SKU ìƒí’ˆì˜ ì›ê°€ë¥¼ ìë™ ê³„ì‚°í•©ë‹ˆë‹¤</p>
            </div>

            <div class="cost-management-grid">
                <!-- ë¶€ìœ„ ê´€ë¦¬ -->
                <div class="card">
                    <div class="card-title">ë¶€ìœ„/í’ˆëª© ê´€ë¦¬</div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>í’ˆëª©ëª…</label>
                            <input type="text" id="part-name" placeholder="ì˜ˆ: ë“±ì‹¬, ì•ˆì‹¬, ì†ŒìŠ¤">
                        </div>
                        <div class="form-group">
                            <label>ë‹¨ìœ„</label>
                            <select id="part-type">
                                <option value="weight">ì¤‘ëŸ‰ (100gë‹¹)</option>
                                <option value="unit">ê°œìˆ˜ (1ê°œë‹¹)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>ë‹¨ê°€ (ì›)</label>
                            <input type="number" id="part-price" placeholder="ì˜ˆ: 9000">
                        </div>
                    </div>
                    <button class="btn btn-success" id="btn-add-part">í’ˆëª© ì¶”ê°€</button>

                    <div class="table-container" style="max-height: 300px;">
                        <table id="parts-table">
                            <thead>
                                <tr>
                                    <th>í’ˆëª©ëª…</th>
                                    <th>ë‹¨ìœ„</th>
                                    <th>ë‹¨ê°€</th>
                                    <th style="width: 100px;">ê´€ë¦¬</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>

                <!-- í¬ì¥ë°©ë²• ê´€ë¦¬ -->
                <div class="card">
                    <div class="card-title">í¬ì¥ë°©ë²• ê´€ë¦¬</div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>í¬ì¥ë°©ë²•ëª…</label>
                            <input type="text" id="packaging-name" placeholder="ì˜ˆ: ë°•ìŠ¤í¬ì¥, ë³´ëƒ‰ë°±">
                        </div>
                        <div class="form-group">
                            <label>í¬ì¥ë¹„ (ì›)</label>
                            <input type="number" id="packaging-price" placeholder="ì˜ˆ: 5000">
                        </div>
                    </div>
                    <button class="btn btn-success" id="btn-add-packaging">í¬ì¥ë°©ë²• ì¶”ê°€</button>

                    <div class="table-container" style="max-height: 300px;">
                        <table id="packaging-table">
                            <thead>
                                <tr>
                                    <th>í¬ì¥ë°©ë²•</th>
                                    <th>í¬ì¥ë¹„</th>
                                    <th style="width: 100px;">ê´€ë¦¬</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="status" id="cost-status"></div>
        </div>

        <!-- SKUìƒí’ˆê´€ë¦¬ í˜ì´ì§€ -->
        <div id="sku-products" class="page-content">
            <div class="page-header">
                <h1>SKUìƒí’ˆê´€ë¦¬</h1>
                <p>ì†¡ì¥ì— í‘œì‹œí•  SKU ìƒí’ˆì„ ë“±ë¡í•˜ê³  êµ¬ì„±í’ˆê³¼ ì›ê°€ë¥¼ ê´€ë¦¬í•©ë‹ˆë‹¤</p>
            </div>

            <div class="card">
                <div class="sku-table-actions">
                    <div class="sku-search">
                        <input type="text" id="sku-product-search" placeholder="SKU ìƒí’ˆ ê²€ìƒ‰...">
                    </div>
                    <button class="btn btn-success" id="btn-add-sku-product">SKU ìƒí’ˆ ì¶”ê°€</button>
                </div>

                <div class="table-container" id="sku-products-table"></div>

                <div class="status" id="sku-products-status"></div>
            </div>
        </div>

        <!-- ê±°ë˜ì²˜ë³„ ìƒí’ˆê´€ë¦¬ í˜ì´ì§€ -->
        <div id="vendor-mapping" class="page-content">
            <div class="page-header">
                <h1>ê±°ë˜ì²˜ë³„ ìƒí’ˆê´€ë¦¬</h1>
                <p>ê±°ë˜ì²˜ì˜ ìƒí’ˆì½”ë“œë¥¼ SKU ìƒí’ˆê³¼ ë§¤ì¹­í•©ë‹ˆë‹¤</p>
            </div>

            <div class="card">
                <div class="sku-management">
                    <!-- ê±°ë˜ì²˜ ëª©ë¡ -->
                    <div class="sku-vendor-list">
                        <div class="card-title">ê±°ë˜ì²˜ ëª©ë¡</div>
                        <div class="add-vendor-form">
                            <input type="text" id="new-vendor-name" placeholder="ìƒˆ ê±°ë˜ì²˜ ì´ë¦„">
                            <button class="btn btn-primary btn-small" id="btn-add-vendor">ì¶”ê°€</button>
                        </div>
                        <div id="vendor-list"></div>
                    </div>

                    <!-- ë§¤ì¹­ ëª©ë¡ -->
                    <div class="sku-product-list">
                        <div class="card-title">ìƒí’ˆì½”ë“œ ë§¤ì¹­ <span id="selected-vendor-name"></span></div>

                        <div id="mapping-empty-state" class="empty-state">
                            <div class="icon">ğŸ”—</div>
                            <div>ì™¼ìª½ì—ì„œ ê±°ë˜ì²˜ë¥¼ ì„ íƒí•˜ì„¸ìš”.</div>
                        </div>

                        <div id="mapping-content" style="display: none;">
                            <div class="sku-table-actions">
                                <div class="sku-search">
                                    <input type="text" id="mapping-search-input" placeholder="ìƒí’ˆì½”ë“œ ê²€ìƒ‰...">
                                </div>
                                <button class="btn btn-success" id="btn-add-mapping">ë§¤ì¹­ ì¶”ê°€</button>
                                <button class="btn btn-primary" id="btn-import-mapping">ì—‘ì…€ ê°€ì ¸ì˜¤ê¸°</button>
                                <button class="btn btn-secondary" id="btn-export-mapping">ì—‘ì…€ ë‚´ë³´ë‚´ê¸°</button>
                            </div>

                            <div class="table-container" id="mapping-table"></div>
                        </div>
                    </div>
                </div>

                <div class="status" id="mapping-status"></div>
            </div>
        </div>

        <!-- ê±°ë˜ì²˜ë³„ íƒë°°ê´€ë¦¬ í˜ì´ì§€ -->
        <div id="settings" class="page-content">
            <div class="page-header">
                <h1>ê±°ë˜ì²˜ë³„ íƒë°°ê´€ë¦¬</h1>
                <p>ë°œì£¼ì²˜ë³„ ì—‘ì…€ ë‹¤ìš´ë¡œë“œ ì–‘ì‹ì„ ì„¤ì •í•©ë‹ˆë‹¤</p>
            </div>

            <div class="card">
                <div class="card-title">ë°œì£¼ì²˜ë³„ ì—‘ì…€ ì–‘ì‹ ì„¤ì •</div>
                <p style="color: #666; margin-bottom: 16px;">ë°œì£¼ì²˜ë§ˆë‹¤ ë‹¤ë¥¸ ì—‘ì…€ ì–‘ì‹ì„ ì„¤ì •í•˜ì—¬ ë‹¤ìš´ë¡œë“œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>

                <div class="form-row" style="margin-bottom: 16px;">
                    <div class="form-group" style="flex: 1;">
                        <label>ë°œì£¼ì²˜ ì„ íƒ</label>
                        <select id="template-vendor-select" style="width: 100%;">
                            <option value="">ë°œì£¼ì²˜ë¥¼ ì„ íƒí•˜ì„¸ìš”...</option>
                        </select>
                    </div>
                    <div class="form-group" style="flex: 0;">
                        <label>&nbsp;</label>
                        <button class="btn btn-primary" id="btn-load-template">ë¶ˆëŸ¬ì˜¤ê¸°</button>
                    </div>
                </div>

                <div id="template-editor" style="display: none;">
                    <div class="form-group" style="margin-bottom: 16px;">
                        <label>íŒŒì¼ëª… (í™•ì¥ì ì œì™¸)</label>
                        <input type="text" id="template-filename" placeholder="ì˜ˆ: ê±°ë˜ì²˜A_ë°œì£¼ì„œ">
                    </div>

                    <div style="margin-bottom: 12px;">
                        <label style="font-weight: 600;">ì—‘ì…€ ì»¬ëŸ¼ ì„¤ì •</label>
                        <p style="font-size: 12px; color: #888; margin-top: 4px;">ë“œë˜ê·¸í•˜ì—¬ ìˆœì„œë¥¼ ë³€ê²½í•˜ê±°ë‚˜, ì²´í¬ë°•ìŠ¤ë¡œ í¬í•¨ ì—¬ë¶€ë¥¼ ì„ íƒí•˜ì„¸ìš”.</p>
                    </div>

                    <div id="template-columns" style="border: 1px solid #ddd; border-radius: 8px; padding: 12px; background: #fafafa; max-height: 300px; overflow-y: auto;">
                        <!-- ì»¬ëŸ¼ ëª©ë¡ì´ ì—¬ê¸° ë Œë”ë§ë¨ -->
                    </div>

                    <div class="btn-group" style="margin-top: 16px;">
                        <button class="btn btn-success" id="btn-save-template">í…œí”Œë¦¿ ì €ì¥</button>
                        <button class="btn btn-danger" id="btn-delete-template">í…œí”Œë¦¿ ì‚­ì œ</button>
                    </div>
                </div>

                <div class="status" id="template-status"></div>
            </div>
        </div>

        <!-- ë¡œë”© -->
        <div class="loading" id="loading">
            <div class="spinner"></div>
            <div>ì²˜ë¦¬ ì¤‘ì…ë‹ˆë‹¤...</div>
        </div>
    </main>

    <!-- SKU ìƒí’ˆ ì¶”ê°€/ìˆ˜ì • ëª¨ë‹¬ -->
    <div class="modal-overlay" id="sku-product-modal">
        <div class="modal">
            <div class="modal-header">
                <h3 id="sku-product-modal-title">SKU ìƒí’ˆ ì¶”ê°€</h3>
                <button class="modal-close" id="sku-product-modal-close">&times;</button>
            </div>

            <div class="form-group">
                <label>SKUìƒí’ˆëª…</label>
                <input type="text" id="sku-product-name" placeholder="ì†¡ì¥ì— í‘œì‹œí•  SKUìƒí’ˆëª…">
            </div>

            <div class="form-group" style="margin-top: 16px;">
                <label>í¬ì¥ë°©ë²•</label>
                <select id="sku-packaging">
                    <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                </select>
            </div>

            <div style="margin-top: 20px;">
                <label style="display: block; font-weight: 500; color: var(--text-color); margin-bottom: 12px;">
                    êµ¬ì„±í’ˆ (ë¶€ìœ„ + ì¤‘ëŸ‰)
                </label>
                <div id="sku-composition-container"></div>
                <button class="btn btn-secondary btn-small" id="btn-add-composition" style="margin-top: 8px;">+ êµ¬ì„±í’ˆ ì¶”ê°€</button>
            </div>

            <div class="cost-info-box" id="sku-cost-info" style="display: none;">
                <h4>ì›ê°€ ì •ë³´</h4>
                <div class="cost-info-grid">
                    <div class="cost-info-item">
                        <div class="value" id="cost-parts">0ì›</div>
                        <div class="label">ë¶€ìœ„ ì›ê°€</div>
                    </div>
                    <div class="cost-info-item">
                        <div class="value" id="cost-packaging">0ì›</div>
                        <div class="label">í¬ì¥ë¹„</div>
                    </div>
                    <div class="cost-info-item">
                        <div class="value" id="cost-total">0ì›</div>
                        <div class="label">ì´ ì›ê°€</div>
                    </div>
                </div>
            </div>

            <div class="btn-group" style="margin-top: 24px;">
                <button class="btn btn-success" id="btn-save-sku-product">ì €ì¥</button>
                <button class="btn btn-secondary" id="btn-cancel-sku-product">ì·¨ì†Œ</button>
            </div>
        </div>
    </div>

    <!-- ê±°ë˜ì²˜ë³„ ìƒí’ˆì½”ë“œ ë§¤ì¹­ ëª¨ë‹¬ -->
    <div class="modal-overlay" id="mapping-modal">
        <div class="modal">
            <div class="modal-header">
                <h3 id="mapping-modal-title">ìƒí’ˆì½”ë“œ ë§¤ì¹­ ì¶”ê°€</h3>
                <button class="modal-close" id="mapping-modal-close">&times;</button>
            </div>

            <div class="form-group">
                <label>ìƒí’ˆì½”ë“œ</label>
                <input type="text" id="mapping-product-code" placeholder="ê±°ë˜ì²˜ì—ì„œ ì‚¬ìš©í•˜ëŠ” ìƒí’ˆì½”ë“œ">
            </div>

            <div class="form-group" style="margin-top: 16px;">
                <label>SKU ìƒí’ˆ ì„ íƒ</label>
                <select id="mapping-sku-select" onchange="updateMappingCostInfo()">
                    <option value="">SKU ìƒí’ˆì„ ì„ íƒí•˜ì„¸ìš”</option>
                </select>
            </div>

            <div class="form-group" style="margin-top: 16px;">
                <label>íŒë§¤ê°€ (ì›)</label>
                <input type="number" id="mapping-selling-price" placeholder="ì´ ê±°ë˜ì²˜ì— ì ìš©í•  íŒë§¤ê°€" oninput="updateMappingCostInfo()">
            </div>

            <div class="cost-info-box" id="mapping-cost-info" style="display: none;">
                <h4>ì†ìµ ì •ë³´</h4>
                <div class="cost-info-grid">
                    <div class="cost-info-item">
                        <div class="value" id="mapping-cost-total">0ì›</div>
                        <div class="label">ì›ê°€</div>
                    </div>
                    <div class="cost-info-item">
                        <div class="value" id="mapping-selling">0ì›</div>
                        <div class="label">íŒë§¤ê°€</div>
                    </div>
                    <div class="cost-info-item">
                        <div class="value" id="mapping-profit">0ì›</div>
                        <div class="label">ì†ìµ</div>
                    </div>
                    <div class="cost-info-item">
                        <div class="value" id="mapping-profit-rate">0%</div>
                        <div class="label">ì†ìµë¥ </div>
                    </div>
                </div>
            </div>

            <div class="btn-group" style="margin-top: 24px;">
                <button class="btn btn-success" id="btn-save-mapping">ì €ì¥</button>
                <button class="btn btn-secondary" id="btn-cancel-mapping">ì·¨ì†Œ</button>
            </div>
        </div>
    </div>

    <!-- ë§¤ì¹­ ì—‘ì…€ ê°€ì ¸ì˜¤ê¸° ëª¨ë‹¬ -->
    <div class="modal-overlay" id="import-mapping-modal">
        <div class="modal">
            <div class="modal-header">
                <h3>ìƒí’ˆì½”ë“œ ë§¤ì¹­ ì—‘ì…€ ê°€ì ¸ì˜¤ê¸°</h3>
                <button class="modal-close" id="import-mapping-modal-close">&times;</button>
            </div>
            <div style="margin-bottom: 16px; color: #555; line-height: 1.6;">
                <p>ì—‘ì…€ íŒŒì¼ í˜•ì‹:</p>
                <ul style="margin-left: 20px; margin-top: 8px;">
                    <li>1ì—´: ìƒí’ˆì½”ë“œ</li>
                    <li>2ì—´: SKUìƒí’ˆëª… (ë“±ë¡ëœ SKU ìƒí’ˆëª…ê³¼ ì¼ì¹˜í•´ì•¼ í•¨)</li>
                    <li>3ì—´: íŒë§¤ê°€ (ì„ íƒ)</li>
                </ul>
            </div>
            <div class="upload-area" id="import-mapping-upload-area" style="padding: 30px;">
                <input type="file" id="import-mapping-file-input" accept=".xlsx,.xls">
                <div class="upload-icon">ğŸ“</div>
                <div class="upload-text">ì—‘ì…€ íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”</div>
            </div>
            <div class="btn-group" style="margin-top: 16px;">
                <button class="btn btn-secondary" id="btn-cancel-import-mapping">ì·¨ì†Œ</button>
            </div>
        </div>
    </div>

    <!-- ë‚ ì§œë³„ ì£¼ë¬¸ ëª¨ë‹¬ -->
    <div class="modal-overlay" id="day-modal">
        <div class="modal" style="width: auto; min-width: 400px; max-width: 95vw;">
            <div class="modal-header">
                <h3 id="day-modal-title">2025ë…„ 1ì›” 1ì¼</h3>
                <button class="modal-close" id="day-modal-close">&times;</button>
            </div>

            <div class="card" style="padding: 16px;">
                <h4 style="margin-bottom: 12px; font-size: 14px; color: var(--text-color);">ë°°ì†¡ ëª©ë¡</h4>
                <div class="day-modal-orders" id="day-orders-list">
                    <div class="empty-state" style="padding: 20px;">
                        <div>ë“±ë¡ëœ ë°°ì†¡ì´ ì—†ìŠµë‹ˆë‹¤.</div>
                    </div>
                </div>
            </div>

            <div id="day-calculation-result" style="overflow-x: auto;"></div>

            <div class="btn-group" style="margin-top: 16px;">
                <button class="btn btn-primary" onclick="calculateDayOrder()">ë°œì£¼ëŸ‰ ê³„ì‚°</button>
                <button class="btn btn-secondary" onclick="closeDayModal()">ë‹«ê¸°</button>
            </div>
        </div>
    </div>

    <!-- ë¹ ë¥¸ ë§¤ì¹­ ëª¨ë‹¬ -->
    <div class="modal-overlay" id="quick-match-modal">
        <div class="modal">
            <div class="modal-header">
                <h3>ë¹ ë¥¸ SKU ë§¤ì¹­</h3>
                <button class="modal-close" onclick="closeQuickMatchModal()">&times;</button>
            </div>

            <div style="background: #f8f9fa; padding: 12px; border-radius: 8px; margin-bottom: 16px;">
                <div style="font-size: 12px; color: #666; margin-bottom: 4px;">ë§¤ì¹­ ëŒ€ìƒ ì •ë³´</div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                    <div>
                        <span style="font-size: 11px; color: #888;">ë°œì£¼ì²˜:</span>
                        <strong id="quick-match-vendor"></strong>
                    </div>
                    <div>
                        <span style="font-size: 11px; color: #888;">ìƒí’ˆì½”ë“œ:</span>
                        <strong id="quick-match-product-code"></strong>
                    </div>
                    <div style="grid-column: span 2;">
                        <span style="font-size: 11px; color: #888;">ìƒí’ˆëª…:</span>
                        <strong id="quick-match-product-name"></strong>
                    </div>
                </div>
            </div>

            <div class="form-group">
                <label>SKU ìƒí’ˆ ì„ íƒ</label>
                <div style="display: flex; gap: 8px; align-items: center;">
                    <select id="quick-match-sku-select" onchange="updateQuickMatchInfo(true)" style="flex: 1;">
                        <option value="">SKU ìƒí’ˆì„ ì„ íƒí•˜ì„¸ìš”</option>
                    </select>
                    <button type="button" class="btn btn-secondary" id="btn-toggle-quick-sku-add" style="white-space: nowrap; padding: 8px 12px;" title="ìƒˆ SKU ìƒí’ˆ ë“±ë¡">+ ì‹ ê·œ</button>
                </div>
            </div>

            <!-- SKU ê°„í¸ë“±ë¡ ì„¹ì…˜ -->
            <div id="quick-sku-add-section" style="display: none; margin-top: 12px; padding: 12px; background: #e8f5e9; border-radius: 8px; border: 1px solid #c8e6c9;">
                <div style="font-size: 13px; font-weight: 600; color: #2e7d32; margin-bottom: 12px;">SKU ìƒí’ˆ ê°„í¸ë“±ë¡</div>
                <div class="form-group">
                    <label>SKU ìƒí’ˆëª… <span style="color: #e74c3c;">*</span></label>
                    <input type="text" id="quick-sku-name" placeholder="ì˜ˆ: í•œìš°êµ¬ì´ì„¸íŠ¸1í˜¸">
                </div>
                <div class="form-group" style="margin-top: 8px;">
                    <label>í¬ì¥ë°©ë²•</label>
                    <select id="quick-sku-packaging">
                        <option value="">ì„ íƒì•ˆí•¨</option>
                    </select>
                </div>
                <div class="form-group" style="margin-top: 8px;">
                    <label style="display: flex; justify-content: space-between; align-items: center;">
                        êµ¬ì„±í’ˆ
                        <button type="button" class="btn btn-secondary" id="btn-quick-sku-add-part" style="padding: 2px 8px; font-size: 11px;">+ ë¶€ìœ„ ì¶”ê°€</button>
                    </label>
                    <div id="quick-sku-composition-list" style="display: flex; flex-direction: column; gap: 6px; margin-top: 6px;">
                        <!-- ë™ì ìœ¼ë¡œ ì¶”ê°€ë˜ëŠ” êµ¬ì„±í’ˆ í–‰ -->
                    </div>
                    <div style="font-size: 11px; color: #666; margin-top: 4px;">â€» ë¶€ìœ„/í’ˆëª©ê³¼ ì¤‘ëŸ‰(g) ë˜ëŠ” ìˆ˜ëŸ‰ì„ ì…ë ¥í•˜ì„¸ìš”</div>
                </div>
                <div class="btn-group" style="margin-top: 12px;">
                    <button type="button" class="btn btn-success" id="btn-quick-sku-save" style="padding: 6px 16px;">ë“±ë¡ í›„ ì„ íƒ</button>
                    <button type="button" class="btn btn-secondary" id="btn-quick-sku-cancel" style="padding: 6px 16px;">ì·¨ì†Œ</button>
                </div>
            </div>

            <div class="form-group" style="margin-top: 16px;">
                <label>íŒë§¤ê°€ (ì›)</label>
                <input type="number" id="quick-match-selling-price" placeholder="ì´ ê±°ë˜ì²˜ì— ì ìš©í•  íŒë§¤ê°€" oninput="updateQuickMatchInfo()">
            </div>

            <div class="cost-info-box" id="quick-match-cost-info" style="display: none;">
                <h4>ì†ìµ ì •ë³´</h4>
                <div class="cost-info-grid">
                    <div class="cost-info-item">
                        <div class="value" id="quick-match-cost">0ì›</div>
                        <div class="label">ì›ê°€</div>
                    </div>
                    <div class="cost-info-item">
                        <div class="value" id="quick-match-selling">0ì›</div>
                        <div class="label">íŒë§¤ê°€</div>
                    </div>
                    <div class="cost-info-item">
                        <div class="value" id="quick-match-profit">0ì›</div>
                        <div class="label">ì†ìµ</div>
                    </div>
                </div>
            </div>

            <div style="margin-top: 16px;">
                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                    <input type="checkbox" id="quick-match-save-mapping" checked>
                    <span style="font-size: 13px;">ì´ ë§¤ì¹­ì„ ê±°ë˜ì²˜ë³„ ìƒí’ˆê´€ë¦¬ì— ì €ì¥ (ë™ì¼ ìƒí’ˆì½”ë“œ ìë™ ë§¤ì¹­)</span>
                </label>
            </div>

            <div class="btn-group" style="margin-top: 24px;">
                <button class="btn btn-success" onclick="handleQuickMatch()">ë§¤ì¹­ ì ìš©</button>
                <button class="btn btn-secondary" onclick="closeQuickMatchModal()">ì·¨ì†Œ</button>
            </div>
        </div>
    </div>

    <!-- ë°œì£¼ëŸ‰ ê³„ì‚° ê²°ê³¼ ëª¨ë‹¬ -->
    <div class="modal-overlay" id="calculation-modal">
        <div class="modal" style="width: auto; min-width: 400px; max-width: 95vw;">
            <div class="modal-header">
                <h3 id="calculation-modal-title">ë°œì£¼ëŸ‰ ê³„ì‚° ê²°ê³¼</h3>
                <button class="modal-close" onclick="closeCalculationModal()">&times;</button>
            </div>
            <div id="calculation-modal-content" style="max-height: 70vh; overflow-y: auto; overflow-x: auto;">
                <!-- ê³„ì‚° ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë¨ -->
            </div>
            <div class="btn-group" style="margin-top: 16px;">
                <button class="btn btn-secondary" onclick="closeCalculationModal()">ë‹«ê¸°</button>
            </div>
        </div>
    </div>

    <!-- ì§‘ê³„ ê²°ê³¼ ëª¨ë‹¬ -->
    <div class="modal-overlay" id="aggregate-modal">
        <div class="modal" style="width: auto; min-width: 600px; max-width: 95vw;">
            <div class="modal-header">
                <h3 id="aggregate-modal-title">ì§‘ê³„ ê²°ê³¼</h3>
                <button class="modal-close" onclick="closeAggregateModal()">&times;</button>
            </div>
            <div id="aggregate-modal-content" style="max-height: 70vh; overflow-y: auto; overflow-x: auto;">
                <!-- ì§‘ê³„ ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë¨ -->
            </div>
            <div class="btn-group" style="margin-top: 16px;">
                <button class="btn btn-success" onclick="downloadAggregateExcel()">ì—‘ì…€ ë‹¤ìš´ë¡œë“œ</button>
                <button class="btn btn-secondary" onclick="closeAggregateModal()">ë‹«ê¸°</button>
            </div>
        </div>
    </div>

    <!-- ì¼ê´„ì…ë ¥ ëª¨ë‹¬ -->
    <div class="modal-overlay" id="bulk-edit-modal">
        <div class="modal" style="max-width: 500px;">
            <div class="modal-header">
                <h3>ì„ íƒí•­ëª© ì¼ê´„ì…ë ¥</h3>
                <button class="modal-close" id="bulk-edit-modal-close">&times;</button>
            </div>

            <p style="font-size: 13px; color: #666; margin-bottom: 16px;">
                ì…ë ¥í•œ ê°’ì´ ì„ íƒëœ <strong id="bulk-edit-count">0</strong>ê±´ì— ì ìš©ë©ë‹ˆë‹¤.<br>
                <span style="color: #e74c3c;">ë¹„ì›Œë‘ë©´ í•´ë‹¹ í•„ë“œëŠ” ë³€ê²½ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</span>
            </p>

            <div class="form-group">
                <label>ìƒí’ˆëª…</label>
                <input type="text" id="bulk-edit-product-name" placeholder="ìƒí’ˆëª… ì…ë ¥ (ë¹„ì›Œë‘ë©´ ë³€ê²½ ì•ˆí•¨)">
            </div>

            <div class="form-group" style="margin-top: 12px;">
                <label>ìˆ˜ëŸ‰</label>
                <input type="number" id="bulk-edit-quantity" placeholder="ìˆ˜ëŸ‰ ì…ë ¥ (ë¹„ì›Œë‘ë©´ ë³€ê²½ ì•ˆí•¨)" min="1">
            </div>

            <div class="form-group" style="margin-top: 12px;">
                <label>ë°œì†¡ì¸</label>
                <input type="text" id="bulk-edit-sender-name" placeholder="ë°œì†¡ì¸ ì…ë ¥ (ë¹„ì›Œë‘ë©´ ë³€ê²½ ì•ˆí•¨)">
            </div>

            <div class="form-group" style="margin-top: 12px;">
                <label>ë°œì†¡ì¸ ì—°ë½ì²˜</label>
                <input type="text" id="bulk-edit-sender-phone" placeholder="ë°œì†¡ì¸ ì—°ë½ì²˜ ì…ë ¥ (ë¹„ì›Œë‘ë©´ ë³€ê²½ ì•ˆí•¨)">
            </div>

            <div class="form-group" style="margin-top: 12px;">
                <label>ë°œì†¡ì¸ ì£¼ì†Œ</label>
                <input type="text" id="bulk-edit-sender-addr" placeholder="ë°œì†¡ì¸ ì£¼ì†Œ ì…ë ¥ (ë¹„ì›Œë‘ë©´ ë³€ê²½ ì•ˆí•¨)">
            </div>

            <div class="btn-group" style="margin-top: 20px;">
                <button class="btn btn-success" id="btn-bulk-edit-apply">ì ìš©</button>
                <button class="btn btn-secondary" id="btn-bulk-edit-cancel">ì·¨ì†Œ</button>
            </div>
        </div>
    </div>

    <!-- ì „ì²´ì£¼ë¬¸ê´€ë¦¬ ì¼ê´„ìˆ˜ì • ëª¨ë‹¬ -->
    <div class="modal-overlay" id="order-bulk-edit-modal">
        <div class="modal" style="max-width: 450px;">
            <div class="modal-header">
                <h3>ì„ íƒí•­ëª© ì¼ê´„ìˆ˜ì •</h3>
                <button class="modal-close" id="order-bulk-edit-modal-close">&times;</button>
            </div>

            <p style="font-size: 13px; color: #666; margin-bottom: 16px;">
                ì…ë ¥í•œ ê°’ì´ ì„ íƒëœ <strong id="order-bulk-edit-count">0</strong>ê±´ì— ì ìš©ë©ë‹ˆë‹¤.<br>
                <span style="color: #e74c3c;">ë¹„ì›Œë‘ë©´ í•´ë‹¹ í•„ë“œëŠ” ë³€ê²½ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</span>
            </p>

            <div class="form-group">
                <label>ë‹¨ê°€ (ì›)</label>
                <input type="number" id="order-bulk-edit-unit-price" placeholder="ë‹¨ê°€ ì…ë ¥ (ë¹„ì›Œë‘ë©´ ë³€ê²½ ì•ˆí•¨)" min="0">
            </div>

            <div class="form-group" style="margin-top: 12px;">
                <label>ë¹„ê³ </label>
                <input type="text" id="order-bulk-edit-note" placeholder="ë¹„ê³  ì…ë ¥ (ë¹„ì›Œë‘ë©´ ë³€ê²½ ì•ˆí•¨)">
            </div>

            <div class="btn-group" style="margin-top: 20px;">
                <button class="btn btn-success" id="btn-order-bulk-edit-apply">ì ìš©</button>
                <button class="btn btn-secondary" id="btn-order-bulk-edit-cancel">ì·¨ì†Œ</button>
            </div>
        </div>
    </div>

    <script>
        // ìƒìˆ˜ ì •ì˜ - ë³€í™˜í™•ì • íƒ­ìš©
        const TARGET_COLUMNS = [
            { key: 'convertedDate', name: 'íŒŒì¼ë³€í™˜ì¼', width: '90px' },
            { key: 'vendor', name: 'ë°œì£¼ì²˜', width: '70px' },
            { key: 'releaseDate', name: 'ì¶œê³ ìš”ì²­ì¼', width: '100px' },
            { key: 'productCode', name: 'ìƒí’ˆì½”ë“œ', width: '100px' },
            { key: 'skuName', name: 'SKUìƒí’ˆëª…', width: '150px' },
            { key: 'packagingComposition', name: 'í¬ì¥&êµ¬ì„±', width: '200px' },
            { key: 'quantity', name: 'ìˆ˜ëŸ‰', width: '50px' },
            { key: 'receiverName', name: 'ìˆ˜ë ¹ì¸', width: '70px' },
            { key: 'receiverPhone', name: 'ìˆ˜ë ¹ì¸ì—°ë½ì²˜', width: '110px' },
            { key: 'receiverAddr', name: 'ìˆ˜ë ¹ì¸ì£¼ì†Œ', width: '200px' },
            { key: 'memo', name: 'ë°°ì†¡ë©”ëª¨', width: '100px' },
            { key: 'senderName', name: 'ë°œì†¡ì¸', width: '70px' },
            { key: 'senderPhone', name: 'ë°œì†¡ì¸ì—°ë½ì²˜', width: '110px' },
            { key: 'senderAddr', name: 'ë°œì†¡ì¸ì£¼ì†Œ', width: '150px' },
            { key: 'orderNo', name: 'ì£¼ë¬¸ë²ˆí˜¸', width: '100px' },
            { key: 'deliveryNo', name: 'ë°°ì†¡ë²ˆí˜¸', width: '100px' },
            { key: 'note', name: 'ë¹„ê³ ', width: '100px' },
            { key: 'sourceFile', name: 'ì›ë³¸íŒŒì¼', width: '120px' }
        ];

        // ì „ì²´ì£¼ë¬¸ê´€ë¦¬ íƒ­ìš© ì»¬ëŸ¼
        const ORDER_MANAGEMENT_COLUMNS = [
            { key: 'registeredDate', name: 'ë“±ë¡ì¼', width: '90px' },
            { key: 'vendor', name: 'ë°œì£¼ì²˜', width: '70px' },
            { key: 'releaseDate', name: 'ì¶œê³ ìš”ì²­ì¼', width: '100px' },
            { key: 'packagingComposition', name: 'í¬ì¥&êµ¬ì„±', width: '200px' },
            { key: 'skuName', name: 'SKUìƒí’ˆëª…', width: '150px' },
            { key: 'quantity', name: 'ìˆ˜ëŸ‰', width: '50px' },
            { key: 'receiverName', name: 'ìˆ˜ë ¹ì¸', width: '70px' },
            { key: 'receiverPhone', name: 'ìˆ˜ë ¹ì¸ì—°ë½ì²˜', width: '110px' },
            { key: 'receiverAddr', name: 'ìˆ˜ë ¹ì¸ì£¼ì†Œ', width: '200px' },
            { key: 'memo', name: 'ë°°ì†¡ë©”ì„¸ì§€', width: '120px' },
            { key: 'orderNo', name: 'ì£¼ë¬¸ë²ˆí˜¸', width: '100px' },
            { key: 'deliveryNo', name: 'ë°°ì†¡ë²ˆí˜¸', width: '100px' },
            { key: 'senderName', name: 'ë°œì†¡ì¸', width: '70px' },
            { key: 'senderPhone', name: 'ë°œì†¡ì¸ì—°ë½ì²˜', width: '110px' },
            { key: 'senderAddr', name: 'ë°œì†¡ì¸ì£¼ì†Œ', width: '150px' },
            { key: 'invoiceNo', name: 'ì†¡ì¥ë²ˆí˜¸', width: '100px' },
            { key: '_shipped', name: 'ì¶œê³ ', width: '70px' },
            { key: '_paid', name: 'ê²°ì œ', width: '70px' },
            { key: '_invoiceIssued', name: 'ê³„ì‚°ì„œ', width: '70px' },
            { key: 'unitPrice', name: 'ë‹¨ê°€', width: '80px' },
            { key: 'totalPrice', name: 'ì´í•©ê³„', width: '90px' },
            { key: 'note', name: 'ë¹„ê³ ', width: '100px' }
        ];

        // ë³€í™˜ì™„ë£Œ íƒ­ìš© ì»¬ëŸ¼ (ìƒí’ˆëª… í¬í•¨, í¬ì¥&êµ¬ì„±/íŒŒì¼ë³€í™˜ì¼/ì†¡ì¥ë²ˆí˜¸ ì œì™¸)
        const RESULT_COLUMNS = [
            { key: 'vendor', name: 'ë°œì£¼ì²˜', width: '70px' },
            { key: 'releaseDate', name: 'ì¶œê³ ìš”ì²­ì¼', width: '100px' },
            { key: 'productCode', name: 'ìƒí’ˆì½”ë“œ', width: '100px' },
            { key: 'productName', name: 'ìƒí’ˆëª…', width: '150px' },
            { key: 'skuName', name: 'SKUìƒí’ˆëª…', width: '150px' },
            { key: 'quantity', name: 'ìˆ˜ëŸ‰', width: '50px' },
            { key: 'receiverName', name: 'ìˆ˜ë ¹ì¸', width: '70px' },
            { key: 'receiverPhone', name: 'ìˆ˜ë ¹ì¸ì—°ë½ì²˜', width: '110px' },
            { key: 'receiverAddr', name: 'ìˆ˜ë ¹ì¸ì£¼ì†Œ', width: '200px' },
            { key: 'memo', name: 'ë°°ì†¡ë©”ëª¨', width: '100px' },
            { key: 'senderName', name: 'ë°œì†¡ì¸', width: '70px' },
            { key: 'senderPhone', name: 'ë°œì†¡ì¸ì—°ë½ì²˜', width: '110px' },
            { key: 'senderAddr', name: 'ë°œì†¡ì¸ì£¼ì†Œ', width: '150px' },
            { key: 'orderNo', name: 'ì£¼ë¬¸ë²ˆí˜¸', width: '100px' },
            { key: 'deliveryNo', name: 'ë°°ì†¡ë²ˆí˜¸', width: '100px' },
            { key: 'note', name: 'ë¹„ê³ ', width: '100px' },
            { key: 'sourceFile', name: 'ì›ë³¸íŒŒì¼', width: '120px' }
        ];

        // ìë™ ë§¤í•‘ ê·œì¹™
        const MAPPING_RULES = {
            'orderNo': ['ì£¼ë¬¸ë²ˆí˜¸', 'ì£¼ë¬¸ì½”ë“œ', 'ì˜¤ë”ë²ˆí˜¸', 'ì˜¤ë”ì½”ë“œ', 'orderno', 'order_no', 'ordercode'],
            'deliveryNo': ['ë°°ì†¡ë²ˆí˜¸', 'ë°°ì†¡ì½”ë“œ', 'ì¶”ê°€ë°°ì†¡', 'ì¶”ê°€ì˜µì…˜', 'ì˜µì…˜ë²ˆí˜¸', 'ë°°ì†¡ìˆœë²ˆ', 'deliveryno', 'delivery_no'],
            'productCode': ['ìƒí’ˆì½”ë“œ', 'ìƒí’ˆí‚¤', 'ì œí’ˆì½”ë“œ', 'í’ˆëª©ì½”ë“œ', 'sku', 'productcode', 'product_code', 'itemcode', 'productkey', 'ì½”ë“œ', 'í’ˆë²ˆ', 'ì œí’ˆë²ˆí˜¸', 'ìƒí’ˆë²ˆí˜¸'],
            'productName': ['ìƒí’ˆëª…', 'í’ˆëª…', 'í’ˆëª©', 'í’ˆëª©ëª…', 'ë¬¼í’ˆ', 'ë¬¼í’ˆëª…', 'ì œí’ˆëª…', 'productname', 'product_name', 'itemname', 'ë‚´ìš©ë¬¼', 'ë‚´í’ˆ', 'ë¬¼ê±´', 'ìƒí’ˆ', 'ì•„ì´í…œ', 'ì œí’ˆ', 'í’ˆ'],
            'quantity': ['ìˆ˜ëŸ‰', 'ì£¼ë¬¸ìˆ˜ëŸ‰', 'ìƒí’ˆìˆ˜', 'qty', 'quantity', 'ê°œìˆ˜', 'ê°¯ìˆ˜', 'ê±´ìˆ˜', 'ë‹¨ìœ„', 'ë°•ìŠ¤', 'box', 'ì„¸íŠ¸', 'set'],
            'receiverName': ['ìˆ˜ë ¹ì¸', 'ìˆ˜ì·¨ì¸', 'ë°›ëŠ”ë¶„', 'ë°›ëŠ”ì‚¬ëŒ', 'ìˆ˜ë ¹ì', 'ë°›ëŠ”ë¶„ì„±ëª…', 'ìˆ˜ì·¨ì¸ëª…', 'ì„±ëª…', 'ì´ë¦„', 'ê³ ê°ëª…', 'ìˆ˜ì‹ ì', 'ìˆ˜ì‹ ì¸', 'ë°°ì†¡ì', 'ê³ ê°', 'ìˆ˜ë ¹ì¸ëª…', 'ë°›ëŠ”ë¶„ì´ë¦„', 'ìˆ˜ì·¨ì', 'ë°›ìœ¼ì‹œëŠ”ë¶„', 'ë°›ìœ¼ì‹¤ë¶„'],
            'receiverPhone': ['ìˆ˜ë ¹ì¸ì—°ë½ì²˜', 'ìˆ˜ë ¹ì¸íœ´ëŒ€í°', 'ìˆ˜ë ¹ì¸ì „í™”', 'ë°›ëŠ”ë¶„ì—°ë½ì²˜', 'ë°›ëŠ”ë¶„íœ´ëŒ€í°', 'ìˆ˜ì·¨ì¸ì—°ë½ì²˜', 'ìˆ˜ì·¨ì¸íœ´ëŒ€í°', 'ìˆ˜ë ¹ì¸í•¸ë“œí°', 'íœ´ëŒ€ì „í™”', 'í•¸ë“œí°', 'íœ´ëŒ€í°', 'ì—°ë½ì²˜', 'ì „í™”', 'í°ë²ˆí˜¸', 'hp', 'tel', 'ì „í™”ë²ˆí˜¸', 'í•¸ë“œí°ë²ˆí˜¸', 'íœ´ëŒ€í°ë²ˆí˜¸', 'ëª¨ë°”ì¼', 'mobile', 'phone', 'ë°›ëŠ”ë¶„ì „í™”', 'ìˆ˜ì·¨ì¸ì „í™”'],
            'receiverAddr': ['ìˆ˜ë ¹ì¸ì£¼ì†Œ', 'ë°›ëŠ”ë¶„ì£¼ì†Œ', 'ìˆ˜ì·¨ì¸ì£¼ì†Œ', 'ë°°ì†¡ì§€ì£¼ì†Œ', 'ë°°ì†¡ì£¼ì†Œ', 'ë°°ì†¡ì§€', 'ì£¼ì†Œ', 'ë„ë¡œëª…ì£¼ì†Œ', 'ì§€ë²ˆì£¼ì†Œ', 'ì „ì²´ì£¼ì†Œ', 'ë°›ëŠ”ê³³', 'ìˆ˜ë ¹ì§€', 'ìˆ˜ì·¨ì§€', 'ë„ì°©ì§€'],
            'receiverAddrDetail': ['ìƒì„¸ì£¼ì†Œ', 'ìƒì„¸', 'ì£¼ì†Œìƒì„¸', 'ë‚˜ë¨¸ì§€ì£¼ì†Œ', 'ì„¸ë¶€ì£¼ì†Œ'],
            'senderName': ['ë°œì†¡ì¸', 'ë³´ë‚´ëŠ”ë¶„', 'ë³´ë‚´ëŠ”ì‚¬ëŒ', 'ë°œì‹ ì¸', 'ë°œì†¡ì', 'ì†¡í•˜ì¸', 'ë°œì†¡ì¸ëª…', 'ë³´ë‚´ëŠ”ë¶„ì´ë¦„', 'ì†¡ì‹ ì', 'ì†¡ì‹ ì¸'],
            'senderPhone': ['ë°œì†¡ì¸ì—°ë½ì²˜', 'ë°œì†¡ì¸íœ´ëŒ€í°', 'ë°œì†¡ì¸ì „í™”', 'ë³´ë‚´ëŠ”ë¶„ì—°ë½ì²˜', 'ë³´ë‚´ëŠ”ë¶„íœ´ëŒ€í°', 'ì†¡í•˜ì¸ì—°ë½ì²˜', 'ì†¡í•˜ì¸ì „í™”', 'ë°œì‹ ì¸ì—°ë½ì²˜'],
            'senderAddr': ['ë°œì†¡ì¸ì£¼ì†Œ', 'ë³´ë‚´ëŠ”ë¶„ì£¼ì†Œ', 'ë°œì†¡ì§€ì£¼ì†Œ', 'ì†¡í•˜ì¸ì£¼ì†Œ', 'ë°œì‹ ì§€', 'ì¶œë°œì§€'],
            'ordererName': ['ì£¼ë¬¸ì', 'ì£¼ë¬¸ìëª…', 'ì£¼ë¬¸ì¸', 'êµ¬ë§¤ì', 'êµ¬ë§¤ìëª…', 'ì£¼ë¬¸ê³ ê°', 'ê²°ì œì', 'ì‹ ì²­ì¸', 'ì‹ ì²­ì'],
            'memo': ['ë°°ì†¡ë©”ëª¨', 'ë°°ì†¡ë©”ì„¸ì§€', 'ë°°ì†¡ë©”ì‹œì§€', 'íƒë°°ë©”ëª¨', 'íƒë°°ìš”ì²­', 'ì „ë‹¬ì‚¬í•­', 'ìš”ì²­ì‚¬í•­', 'ë°°ì†¡ìš”ì²­', 'ë©”ëª¨', 'íŠ¹ì´ì‚¬í•­', 'ìš”ì²­ë©”ëª¨', 'ë°°ì†¡ì‹œìš”ì²­', 'ê¸°ì‚¬ë©”ëª¨', 'ë°°ë‹¬ë©”ëª¨'],
            'invoiceNo': ['ì†¡ì¥ë²ˆí˜¸', 'ìš´ì†¡ì¥ë²ˆí˜¸', 'ìš´ì†¡ì¥', 'íƒë°°ë²ˆí˜¸', 'invoiceno', 'ì†¡ì¥', 'íƒë°°ì†¡ì¥', 'ë°°ì†¡ë²ˆí˜¸'],
            'note': ['ë¹„ê³ ', 'ë©”ëª¨', 'ì°¸ê³ ', 'ê¸°íƒ€', 'ë…¸íŠ¸', 'note', 'remark', 'íŠ¹ê¸°ì‚¬í•­', 'ì¶”ê°€ì •ë³´'],
            'releaseDate': ['ì¶œê³ ìš”ì²­ì¼', 'ì¶œê³ ì¼', 'ì¶œê³ ì˜ˆì •ì¼', 'ì¶œê³ í¬ë§ì¼', 'ë°°ì†¡ìš”ì²­ì¼', 'ë°°ì†¡í¬ë§ì¼', 'ë°œì†¡ìš”ì²­ì¼', 'ë°œì†¡í¬ë§ì¼', 'ë°œì†¡ì¼', 'ì˜ˆì•½ì¶œê³ ì¼', 'ì§€ì •ì¶œê³ ì¼', 'ì¶œí•˜ì¼', 'ì¶œí•˜ìš”ì²­ì¼', 'ë°°ì†¡ì¼', 'ë°°ì†¡ì§€ì •ì¼', 'í¬ë§ì¼', 'ìš”ì²­ì¼ì', 'ë°°ì†¡ì¼ì', 'ë°œì†¡ì¼ì']
        };

        // ë§¤í•‘ ì œì™¸ í‚¤ì›Œë“œ
        const MAPPING_EXCLUDES = {
            'receiverAddr': ['ìš°í¸ë²ˆí˜¸', 'ìš°í¸', 'zip', 'ì¼ì‹œ', 'ì¼ì', 'ë‚ ì§œ', 'ìš”ì²­', 'ì§€ì‹œ', 'ë°°ì†¡ìš”ì²­', 'ë°°ì†¡ì§€ì‹œ', 'ìš”ì²­ì¼', 'ì§€ì‹œì¼', 'ì™„ë£Œ', 'ì‹œê°„'],
            'receiverPhone': ['ì•ˆì‹¬ë²ˆí˜¸', 'ì•ˆì‹¬', 'ì „í™”ë²ˆí˜¸_', '_ì•ˆì‹¬'],
            'quantity': ['ê¸ˆì•¡', 'ê°€ê²©', 'íŒë§¤', 'ê³µê¸‰', 'ê²°ì œ'],
            'productName': ['ì½”ë“œ', 'code'],
            'memo': ['ìš”ì²­ì¼', 'ì§€ì‹œì¼', 'ì¼ì', 'ì¼ì‹œ', 'ë‚ ì§œ', 'ì¶œê³ ', 'ë°œì†¡']
        };

        // ==================== Firebase ì„¤ì • ====================
        const firebaseConfig = {
            apiKey: "AIzaSyAp4z7Ey5q0RI1ucfn3OXrj3R7idS5Bkg4",
            authDomain: "order-management-system-fa6a4.firebaseapp.com",
            databaseURL: "https://order-management-system-fa6a4-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "order-management-system-fa6a4",
            storageBucket: "order-management-system-fa6a4.firebasestorage.app",
            messagingSenderId: "59437300120",
            appId: "1:59437300120:web:0e79791950eabf134a93ed"
        };

        // Firebase ì´ˆê¸°í™”
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // ==================== ì‚¬ìš©ì ê´€ë¦¬ ë³€ìˆ˜ ====================
        let userList = []; // ì‚¬ìš©ì ëª©ë¡: ['ì‚¬ìš©ì1', 'ì‚¬ìš©ì2', ...]
        let currentUser = null; // í˜„ì¬ ì„ íƒëœ ì‚¬ìš©ì
        let allUsersData = {}; // ëª¨ë“  ì‚¬ìš©ì ë°ì´í„° ìºì‹œ: { userId: { convertedData, confirmedData, orderManagementData } }
        let firebaseListeners = {}; // Firebase ë¦¬ìŠ¤ë„ˆ ì €ì¥

        // ==================== ì „ì—­ ë³€ìˆ˜ ====================
        let workbooks = []; // ì—¬ëŸ¬ íŒŒì¼ ì§€ì›
        let convertedData = [];
        let confirmedData = [];
        let currentFileName = '';
        let skuProducts = []; // [{ id, skuName, packaging, sellingPrice, composition }]
        let vendorMappings = {}; // { vendorName: [{ productCode, skuProductId }] }
        let vendorTemplates = {}; // { vendorName: { columns: [...], fileName: '...' } }
        let skuData = {}; // ê¸°ì¡´ í˜¸í™˜ìš© (deprecated)
        let partsData = {}; // { partName: pricePerl00g }
        let packagingData = {}; // { packagingName: price }
        let selectedVendor = null;
        let editingSkuProductIndex = -1;
        let editingMappingIndex = -1;

        // ë‹¬ë ¥ ê´€ë ¨ ë³€ìˆ˜
        let currentYear = new Date().getFullYear();
        let currentMonth = new Date().getMonth();
        let selectedDate = null;

        // í•„í„°/ì •ë ¬ ìƒíƒœ (ë³€í™˜í™•ì •ìš©)
        let confirmedFilters = {}; // { columnKey: [selectedValues] }
        let confirmedSort = { key: 'releaseDate', direction: 'asc' }; // ê¸°ë³¸: ì¶œê³ ìš”ì²­ì¼ ì˜¤ë¦„ì°¨ìˆœ (ë¯¸ë“±ë¡ ìµœìƒë‹¨)
        let activeFilterDropdown = null; // í˜„ì¬ ì—´ë¦° í•„í„° ë“œë¡­ë‹¤ìš´

        // í•„í„°/ì •ë ¬ ìƒíƒœ (ì „ì²´ì£¼ë¬¸ê´€ë¦¬ìš©)
        let orderManagementFilters = {}; // { columnKey: [selectedValues] }
        let orderManagementSort = { key: null, direction: null };
        let orderDateFilter = { from: null, to: null, status: '' }; // ë‚ ì§œ/ìƒíƒœ í•„í„°

        // ì „ì²´ì£¼ë¬¸ê´€ë¦¬ ë°ì´í„°
        let orderManagementData = []; // ì „ì²´ì£¼ë¬¸ê´€ë¦¬ ë°ì´í„°
        // ì¶”ê°€ í•„ë“œ: _shipped (ì¶œê³ ì™„ë£Œ), _paid (ê²°ì œì™„ë£Œ), _invoiceIssued (ê³„ì‚°ì„œë°œí–‰), registeredDate (ë“±ë¡ì¼)

        // DOM ìš”ì†Œ
        const fileInput = document.getElementById('file-input');
        const uploadArea = document.getElementById('upload-area');
        const fileInfo = document.getElementById('file-info');
        const vendorName = document.getElementById('vendor-name');
        const btnConvert = document.getElementById('btn-convert');
        const statusMsg = document.getElementById('status-msg');
        const resultContent = document.getElementById('result-content');
        const resultData = document.getElementById('result-data');
        const resultTable = document.getElementById('result-table');
        const resultSummary = document.getElementById('result-summary');
        const resultStatus = document.getElementById('result-status');
        const confirmedContent = document.getElementById('confirmed-content');
        const confirmedDataEl = document.getElementById('confirmed-data');
        const confirmedTable = document.getElementById('confirmed-table');
        const confirmedSummary = document.getElementById('confirmed-summary');
        const confirmedStatus = document.getElementById('confirmed-status');
        const confirmedBadge = document.getElementById('confirmed-badge');
        const loading = document.getElementById('loading');
        const orderManagementContent = document.getElementById('order-management-content');
        const orderManagementDataEl = document.getElementById('order-management-data');
        const orderManagementTable = document.getElementById('order-management-table');
        const orderManagementSummary = document.getElementById('order-management-summary');
        const orderManagementStatus = document.getElementById('order-management-status');
        const orderManagementBadge = document.getElementById('order-management-badge');

        // ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', () => {
            initializeFirebase();
            setupEventListeners();
        });

        // Firebase ì—°ê²° ë° ì´ˆê¸°í™”
        async function initializeFirebase() {
            updateConnectionStatus('connecting');

            try {
                // ì—°ê²° ìƒíƒœ ëª¨ë‹ˆí„°ë§
                const connectedRef = database.ref('.info/connected');
                connectedRef.on('value', (snap) => {
                    if (snap.val() === true) {
                        updateConnectionStatus('connected');
                    } else {
                        updateConnectionStatus('disconnected');
                    }
                });

                // ê³µí†µ ì„¤ì • ë°ì´í„° ë¡œë“œ
                await loadSettingsFromFirebase();

                // ì‚¬ìš©ì ëª©ë¡ ë¡œë“œ ë° ì‹¤ì‹œê°„ êµ¬ë…
                await loadUserList();

                // UI ì´ˆê¸°í™”
                updateVendorSelect();
                renderPartsTable();
                renderPackagingTable();
                renderCalendar();

                console.log('Firebase ì´ˆê¸°í™” ì™„ë£Œ');
            } catch (error) {
                console.error('Firebase ì´ˆê¸°í™” ì˜¤ë¥˜:', error);
                updateConnectionStatus('error');
                // ì˜¤ë¥˜ ì‹œ localStorageì—ì„œ ë¡œë“œ ì‹œë„
                loadAllDataFromLocalStorage();
            }
        }

        function updateConnectionStatus(status) {
            const statusEl = document.getElementById('connection-status');
            if (!statusEl) return;

            statusEl.className = 'connection-status';
            const textEl = statusEl.querySelector('.text');

            if (status === 'connected') {
                statusEl.classList.add('connected');
                textEl.textContent = 'ì‹¤ì‹œê°„ ì—°ê²°ë¨';
            } else if (status === 'connecting') {
                textEl.textContent = 'ì—°ê²° ì¤‘...';
            } else if (status === 'disconnected') {
                textEl.textContent = 'ì—°ê²° ëŠê¹€';
            } else if (status === 'error') {
                textEl.textContent = 'ì—°ê²° ì˜¤ë¥˜';
            }
        }

        // ê³µí†µ ì„¤ì • ë°ì´í„°ë¥¼ Firebaseì—ì„œ ë¡œë“œ
        async function loadSettingsFromFirebase() {
            const settingsRef = database.ref('settings');

            // ì‹¤ì‹œê°„ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
            settingsRef.on('value', (snapshot) => {
                const data = snapshot.val() || {};

                partsData = data.partsData || {};
                packagingData = data.packagingData || {};
                skuProducts = data.skuProducts || [];
                vendorMappings = data.vendorMappings || {};
                vendorTemplates = data.vendorTemplates || {};

                // UI ê°±ì‹ 
                renderPartsTable();
                renderPackagingTable();
                renderSkuProductsTable();
                renderVendorList();
                updateVendorSelect();
            });
        }

        // ì‚¬ìš©ì ëª©ë¡ ë¡œë“œ
        async function loadUserList() {
            const userListRef = database.ref('userList');

            // ì‹¤ì‹œê°„ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
            userListRef.on('value', (snapshot) => {
                userList = snapshot.val() || [];

                // ì‚¬ìš©ìê°€ ì—†ìœ¼ë©´ ê¸°ë³¸ ì‚¬ìš©ì ìƒì„±
                if (userList.length === 0) {
                    userList = ['ì‚¬ìš©ì1'];
                    database.ref('userList').set(userList);
                }

                // í˜„ì¬ ì‚¬ìš©ìê°€ ì—†ìœ¼ë©´ ì²« ë²ˆì§¸ ì‚¬ìš©ìë¡œ ì„¤ì •
                if (!currentUser && userList.length > 0) {
                    currentUser = userList[0];
                }

                // í˜„ì¬ ì‚¬ìš©ìê°€ ëª©ë¡ì—ì„œ ì‚­ì œëœ ê²½ìš° ì²« ë²ˆì§¸ ì‚¬ìš©ìë¡œ ë³€ê²½
                if (currentUser && !userList.includes(currentUser) && userList.length > 0) {
                    currentUser = userList[0];
                }

                // ì‚¬ì´ë“œë°” ì‚¬ìš©ì ë©”ë‰´ ë Œë”ë§
                renderUserMenus();

                // í†µí•©ì¡°íšŒ ì‚¬ìš©ì í•„í„° ì—…ë°ì´íŠ¸
                updateIntegratedUserFilter();

                // ëª¨ë“  ì‚¬ìš©ì ë°ì´í„° êµ¬ë…
                subscribeToAllUsersData();
            });
        }

        // ëª¨ë“  ì‚¬ìš©ì ë°ì´í„° ì‹¤ì‹œê°„ êµ¬ë…
        function subscribeToAllUsersData() {
            // ê¸°ì¡´ ë¦¬ìŠ¤ë„ˆ ì œê±°
            Object.keys(firebaseListeners).forEach(key => {
                if (key.startsWith('user_')) {
                    database.ref(firebaseListeners[key].path).off();
                    delete firebaseListeners[key];
                }
            });

            userList.forEach(userId => {
                const userRef = database.ref(`users/${userId}`);

                userRef.on('value', (snapshot) => {
                    const userData = snapshot.val() || {};

                    allUsersData[userId] = {
                        convertedData: userData.convertedData || [],
                        confirmedData: userData.confirmedData || [],
                        orderManagementData: userData.orderManagementData || []
                    };

                    // í˜„ì¬ ì„ íƒëœ ì‚¬ìš©ìì˜ ë°ì´í„°ë©´ UI ê°±ì‹ 
                    if (currentUser === userId) {
                        convertedData = allUsersData[userId].convertedData;
                        confirmedData = allUsersData[userId].confirmedData;
                        orderManagementData = allUsersData[userId].orderManagementData;

                        renderResult();
                        renderConfirmed();
                        renderOrderManagement();
                    }

                    // ëŒ€ì‹œë³´ë“œ ê°±ì‹  (ëª¨ë“  ì‚¬ìš©ì ë°ì´í„° í†µí•©)
                    renderCalendar();

                    // ì‚¬ìš©ìë³„ ë±ƒì§€ ì—…ë°ì´íŠ¸
                    updateUserBadges(userId);
                });

                firebaseListeners[`user_${userId}`] = { path: `users/${userId}` };
            });
        }

        // ì‚¬ìš©ìë³„ ë±ƒì§€ ì—…ë°ì´íŠ¸
        function updateUserBadges(userId) {
            const userData = allUsersData[userId];
            if (!userData) return;

            const confirmedBadge = document.getElementById(`badge-confirmed-${userId}`);
            const orderBadge = document.getElementById(`badge-order-${userId}`);

            if (confirmedBadge) {
                const count = userData.confirmedData.length;
                confirmedBadge.textContent = count;
                confirmedBadge.style.display = count > 0 ? '' : 'none';
            }

            if (orderBadge) {
                const count = userData.orderManagementData.length;
                orderBadge.textContent = count;
                orderBadge.style.display = count > 0 ? '' : 'none';
            }
        }

        // localStorage í´ë°± (Firebase ì—°ê²° ì‹¤íŒ¨ ì‹œ)
        function loadAllDataFromLocalStorage() {
            loadCostData();
            loadSkuProducts();
            loadVendorMappings();
            loadVendorTemplates();
            loadConfirmedData();
            loadOrderManagementData();
            renderCalendar();

            // ê¸°ë³¸ ì‚¬ìš©ìë¡œ ì„¤ì •
            userList = ['ì‚¬ìš©ì1'];
            currentUser = 'ì‚¬ìš©ì1';
            renderUserMenus();
        }

        function loadAllData() {
            // Firebase ì‚¬ìš© ì‹œì—ëŠ” ì´ í•¨ìˆ˜ ì‚¬ìš© ì•ˆí•¨
            loadCostData();  // partsData, packagingData ë¨¼ì € ë¡œë“œ (SKU ì›ê°€ ê³„ì‚°ì— í•„ìš”)
            loadSkuProducts();  // SKU ìƒí’ˆ ë°ì´í„° ë¡œë“œ
            loadVendorMappings();  // ê±°ë˜ì²˜ë³„ ë§¤í•‘ ë¡œë“œ
            loadVendorTemplates();  // ë°œì£¼ì²˜ë³„ ì—‘ì…€ í…œí”Œë¦¿ ë¡œë“œ
            loadConfirmedData();  // ë³€í™˜í™•ì • ë°ì´í„° ë¡œë“œ (SKU, ë§¤í•‘ ë°ì´í„° í•„ìš”)
            loadOrderManagementData();  // ì „ì²´ì£¼ë¬¸ê´€ë¦¬ ë°ì´í„° ë¡œë“œ
            renderCalendar();
        }

        // ==================== ì‚¬ìš©ì ë©”ë‰´ ê´€ë¦¬ ====================

        // ì‚¬ìš©ì ë©”ë‰´ ë Œë”ë§
        function renderUserMenus() {
            const container = document.getElementById('user-menus-container');
            if (!container) return;

            let html = '<div class="menu-group-title">ì‚¬ìš©ì</div>';

            userList.forEach((userId, index) => {
                const isActive = currentUser === userId;
                const userData = allUsersData[userId] || { confirmedData: [], orderManagementData: [] };
                const confirmedCount = userData.confirmedData.length;
                const orderCount = userData.orderManagementData.length;

                html += `
                    <div class="user-dropdown" data-user="${escapeHtml(userId)}">
                        <div class="user-dropdown-header ${isActive ? 'active expanded' : ''}" onclick="toggleUserDropdown('${escapeHtml(userId)}')">
                            <span class="user-name">
                                <span class="icon">ğŸ‘¤</span>
                                ${escapeHtml(userId)}
                            </span>
                            <span class="arrow">â–¼</span>
                        </div>
                        <div class="user-dropdown-menu ${isActive ? 'show' : ''}">
                            <div class="menu-item" data-page="convert" data-user="${escapeHtml(userId)}" onclick="selectUserPage('${escapeHtml(userId)}', 'convert')">
                                <span class="icon">ğŸ“</span>
                                <span>ë°œì£¼ì„œ ë³€í™˜</span>
                            </div>
                            <div class="menu-item" data-page="result" data-user="${escapeHtml(userId)}" onclick="selectUserPage('${escapeHtml(userId)}', 'result')">
                                <span class="icon">ğŸ“‹</span>
                                <span>ë³€í™˜ì™„ë£Œ</span>
                            </div>
                            <div class="menu-item" data-page="confirmed" data-user="${escapeHtml(userId)}" onclick="selectUserPage('${escapeHtml(userId)}', 'confirmed')">
                                <span class="icon">âœ…</span>
                                <span>ë³€í™˜í™•ì •</span>
                                <span class="badge" id="badge-confirmed-${escapeHtml(userId)}" style="display:${confirmedCount > 0 ? '' : 'none'};">${confirmedCount}</span>
                            </div>
                            <div class="menu-item" data-page="order-management" data-user="${escapeHtml(userId)}" onclick="selectUserPage('${escapeHtml(userId)}', 'order-management')">
                                <span class="icon">ğŸ“¦</span>
                                <span>ì „ì²´ì£¼ë¬¸ê´€ë¦¬</span>
                                <span class="badge" id="badge-order-${escapeHtml(userId)}" style="display:${orderCount > 0 ? '' : 'none'};">${orderCount}</span>
                            </div>
                            <div class="menu-item" style="padding-left: 48px; font-size: 11px; color: #95a5a6; border-top: 1px solid rgba(255,255,255,0.05);" onclick="renameUser('${escapeHtml(userId)}')">
                                <span class="icon">âœï¸</span>
                                <span>ì´ë¦„ ë³€ê²½</span>
                            </div>
                            ${userList.length > 1 ? `
                            <div class="menu-item" style="padding-left: 48px; font-size: 11px; color: #e74c3c;" onclick="deleteUser('${escapeHtml(userId)}')">
                                <span class="icon">ğŸ—‘ï¸</span>
                                <span>ì‚­ì œ</span>
                            </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        // ì‚¬ìš©ì ë“œë¡­ë‹¤ìš´ í† ê¸€
        function toggleUserDropdown(userId) {
            const dropdown = document.querySelector(`.user-dropdown[data-user="${userId}"]`);
            if (!dropdown) return;

            const header = dropdown.querySelector('.user-dropdown-header');
            const menu = dropdown.querySelector('.user-dropdown-menu');

            header.classList.toggle('expanded');
            menu.classList.toggle('show');
        }
        window.toggleUserDropdown = toggleUserDropdown;

        // ì‚¬ìš©ì í˜ì´ì§€ ì„ íƒ
        function selectUserPage(userId, page) {
            // ì´ì „ ì‚¬ìš©ìì˜ active ìƒíƒœ ì œê±°
            document.querySelectorAll('.user-dropdown-header').forEach(h => h.classList.remove('active'));
            document.querySelectorAll('.user-dropdown-menu .menu-item').forEach(m => m.classList.remove('active'));

            // í˜„ì¬ ì‚¬ìš©ì ë° í˜ì´ì§€ ì„¤ì •
            currentUser = userId;

            // í˜„ì¬ ì‚¬ìš©ì ë°ì´í„° ë¡œë“œ
            if (allUsersData[userId]) {
                convertedData = allUsersData[userId].convertedData || [];
                confirmedData = allUsersData[userId].confirmedData || [];
                orderManagementData = allUsersData[userId].orderManagementData || [];
            } else {
                convertedData = [];
                confirmedData = [];
                orderManagementData = [];
            }

            // UI ì—…ë°ì´íŠ¸
            const dropdown = document.querySelector(`.user-dropdown[data-user="${userId}"]`);
            if (dropdown) {
                dropdown.querySelector('.user-dropdown-header').classList.add('active', 'expanded');
                dropdown.querySelector('.user-dropdown-menu').classList.add('show');
                const menuItem = dropdown.querySelector(`.menu-item[data-page="${page}"]`);
                if (menuItem) menuItem.classList.add('active');
            }

            // ê³µí†µ ë©”ë‰´ active ì œê±°
            document.querySelectorAll('.sidebar-menu > .menu-group > .menu-item').forEach(m => m.classList.remove('active'));

            // í˜ì´ì§€ ì „í™˜
            showPage(page);

            // ë°ì´í„° ë Œë”ë§
            renderResult();
            renderConfirmed();
            renderOrderManagement();
        }
        window.selectUserPage = selectUserPage;

        // ì‚¬ìš©ì ì¶”ê°€
        function addUser() {
            const newName = prompt('ìƒˆ ì‚¬ìš©ì ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”:');
            if (!newName || !newName.trim()) return;

            const trimmedName = newName.trim();
            if (userList.includes(trimmedName)) {
                alert('ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ì‚¬ìš©ì ì´ë¦„ì…ë‹ˆë‹¤.');
                return;
            }

            userList.push(trimmedName);
            database.ref('userList').set(userList);

            // ìƒˆ ì‚¬ìš©ìì˜ ë¹ˆ ë°ì´í„° ìƒì„±
            database.ref(`users/${trimmedName}`).set({
                convertedData: [],
                confirmedData: [],
                orderManagementData: []
            });
        }
        window.addUser = addUser;

        // ì‚¬ìš©ì ì´ë¦„ ë³€ê²½
        function renameUser(userId) {
            const newName = prompt('ìƒˆ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”:', userId);
            if (!newName || !newName.trim() || newName.trim() === userId) return;

            const trimmedName = newName.trim();
            if (userList.includes(trimmedName)) {
                alert('ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ì‚¬ìš©ì ì´ë¦„ì…ë‹ˆë‹¤.');
                return;
            }

            // ë°ì´í„° ë³µì‚¬
            const userData = allUsersData[userId];
            if (userData) {
                database.ref(`users/${trimmedName}`).set(userData);
            }

            // ê¸°ì¡´ ë°ì´í„° ì‚­ì œ
            database.ref(`users/${userId}`).remove();

            // ëª©ë¡ ì—…ë°ì´íŠ¸
            const index = userList.indexOf(userId);
            if (index > -1) {
                userList[index] = trimmedName;
                database.ref('userList').set(userList);
            }

            // í˜„ì¬ ì‚¬ìš©ìì˜€ìœ¼ë©´ ìƒˆ ì´ë¦„ìœ¼ë¡œ ë³€ê²½
            if (currentUser === userId) {
                currentUser = trimmedName;
            }
        }
        window.renameUser = renameUser;

        // ì‚¬ìš©ì ì‚­ì œ
        function deleteUser(userId) {
            if (userList.length <= 1) {
                alert('ìµœì†Œ 1ëª…ì˜ ì‚¬ìš©ìê°€ í•„ìš”í•©ë‹ˆë‹¤.');
                return;
            }

            if (!confirm(`"${userId}" ì‚¬ìš©ìë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\ní•´ë‹¹ ì‚¬ìš©ìì˜ ëª¨ë“  ë°ì´í„°ê°€ ì‚­ì œë©ë‹ˆë‹¤.`)) return;

            // Firebaseì—ì„œ ì‚­ì œ
            database.ref(`users/${userId}`).remove();

            // ëª©ë¡ì—ì„œ ì œê±°
            const index = userList.indexOf(userId);
            if (index > -1) {
                userList.splice(index, 1);
                database.ref('userList').set(userList);
            }

            // í˜„ì¬ ì‚¬ìš©ìì˜€ìœ¼ë©´ ì²« ë²ˆì§¸ ì‚¬ìš©ìë¡œ ë³€ê²½
            if (currentUser === userId && userList.length > 0) {
                selectUserPage(userList[0], 'convert');
            }
        }
        window.deleteUser = deleteUser;

        // í†µí•©ì¡°íšŒ ì‚¬ìš©ì í•„í„° ì—…ë°ì´íŠ¸
        function updateIntegratedUserFilter() {
            const select = document.getElementById('integrated-user-filter');
            if (!select) return;

            select.innerHTML = '<option value="">ì „ì²´</option>';
            userList.forEach(userId => {
                select.innerHTML += `<option value="${escapeHtml(userId)}">${escapeHtml(userId)}</option>`;
            });
        }

        function setupEventListeners() {
            // ì‚¬ì´ë“œë°” ë©”ë‰´ (ê³µí†µ ë©”ë‰´)
            document.querySelectorAll('.sidebar-menu > .menu-group > .menu-item').forEach(item => {
                item.addEventListener('click', () => handleMenuClick(item));
            });

            // ì‚¬ìš©ì ì¶”ê°€ ë²„íŠ¼
            document.getElementById('btn-add-user').addEventListener('click', addUser);

            // íŒŒì¼ ì—…ë¡œë“œ
            uploadArea.addEventListener('click', () => fileInput.click());
            fileInput.addEventListener('change', handleFileSelect);
            uploadArea.addEventListener('dragover', handleDragOver);
            uploadArea.addEventListener('dragleave', handleDragLeave);
            uploadArea.addEventListener('drop', handleDrop);

            // ë³€í™˜
            btnConvert.addEventListener('click', handleConvert);

            // ë°œì£¼ì²˜ ê°„í¸ì¶”ê°€
            document.getElementById('btn-toggle-vendor-add').addEventListener('click', toggleVendorQuickAdd);
            document.getElementById('btn-vendor-quick-save').addEventListener('click', saveVendorQuickAdd);
            document.getElementById('btn-vendor-quick-cancel').addEventListener('click', cancelVendorQuickAdd);
            document.getElementById('vendor-quick-input').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') saveVendorQuickAdd();
            });

            // ë°œì£¼ì„œ ì–‘ì‹ ë‹¤ìš´ë¡œë“œ
            document.getElementById('btn-download-template').addEventListener('click', handleDownloadTemplate);

            // ë³€í™˜ì™„ë£Œ ì»¨íŠ¸ë¡¤
            document.getElementById('btn-select-all').addEventListener('click', () => handleToggleAll(true));
            document.getElementById('btn-deselect-all').addEventListener('click', () => handleToggleAll(false));
            document.getElementById('btn-bulk-edit').addEventListener('click', openBulkEditModal);
            document.getElementById('btn-add-to-confirmed').addEventListener('click', handleAddToConfirmed);

            // ì¼ê´„ì…ë ¥ ëª¨ë‹¬ ì»¨íŠ¸ë¡¤
            document.getElementById('bulk-edit-modal-close').addEventListener('click', closeBulkEditModal);
            document.getElementById('btn-bulk-edit-apply').addEventListener('click', applyBulkEdit);
            document.getElementById('btn-bulk-edit-cancel').addEventListener('click', closeBulkEditModal);

            // ë¹ ë¥¸ SKU ë§¤ì¹­ - SKU ê°„í¸ë“±ë¡
            document.getElementById('btn-toggle-quick-sku-add').addEventListener('click', toggleQuickSkuAdd);
            document.getElementById('btn-quick-sku-save').addEventListener('click', saveQuickSku);
            document.getElementById('btn-quick-sku-cancel').addEventListener('click', cancelQuickSkuAdd);
            document.getElementById('quick-sku-name').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') saveQuickSku();
            });
            document.getElementById('btn-quick-sku-add-part').addEventListener('click', addQuickSkuCompositionRow);

            // ë³€í™˜í™•ì • ì»¨íŠ¸ë¡¤
            document.getElementById('btn-confirmed-select-all').addEventListener('click', () => handleConfirmedToggleAll(true));
            document.getElementById('btn-confirmed-deselect-all').addEventListener('click', () => handleConfirmedToggleAll(false));
            document.getElementById('btn-confirmed-calculate').addEventListener('click', calculateConfirmedOrders);
            document.getElementById('btn-remove-selected').addEventListener('click', handleRemoveSelected);
            document.getElementById('btn-clear-all').addEventListener('click', handleClearAll);
            document.getElementById('btn-download').addEventListener('click', handleDownload);
            document.getElementById('btn-register').addEventListener('click', handleRegisterInvoice);

            // ì „ì²´ì£¼ë¬¸ê´€ë¦¬ ì»¨íŠ¸ë¡¤
            document.getElementById('btn-order-select-all').addEventListener('click', orderSelectAll);
            document.getElementById('btn-order-deselect-all').addEventListener('click', orderDeselectAll);
            document.getElementById('btn-order-mark-shipped').addEventListener('click', orderMarkShipped);
            document.getElementById('btn-order-mark-paid').addEventListener('click', orderMarkPaid);
            document.getElementById('btn-order-mark-invoice-issued').addEventListener('click', orderMarkInvoiceIssued);
            document.getElementById('btn-order-calculate').addEventListener('click', calculateOrderManagementOrders);
            document.getElementById('btn-order-aggregate').addEventListener('click', aggregateOrderManagement);
            document.getElementById('btn-order-delete-selected').addEventListener('click', orderDeleteSelected);
            document.getElementById('btn-order-reset-filters').addEventListener('click', resetAllOrderFilters);
            document.getElementById('btn-order-bulk-edit').addEventListener('click', openOrderBulkEditModal);
            document.getElementById('order-bulk-edit-modal-close').addEventListener('click', closeOrderBulkEditModal);
            document.getElementById('btn-order-bulk-edit-apply').addEventListener('click', applyOrderBulkEdit);
            document.getElementById('btn-order-bulk-edit-cancel').addEventListener('click', closeOrderBulkEditModal);
            document.getElementById('btn-order-download').addEventListener('click', handleOrderDownload);
            document.getElementById('btn-order-btype-download').addEventListener('click', handleOrderBTypeDownload);
            document.getElementById('btn-order-vendor-download').addEventListener('click', handleOrderVendorDownload);
            document.getElementById('btn-upload-invoice').addEventListener('click', () => document.getElementById('invoice-file-input').click());
            document.getElementById('invoice-file-input').addEventListener('change', handleInvoiceUpload);

            // ë°œì£¼ì²˜ë³„ ì—‘ì…€ í…œí”Œë¦¿
            document.getElementById('btn-load-template').addEventListener('click', loadTemplateForVendor);
            document.getElementById('btn-save-template').addEventListener('click', saveVendorTemplate);
            document.getElementById('btn-delete-template').addEventListener('click', deleteVendorTemplate);

            // ì›ê°€ê´€ë¦¬
            document.getElementById('btn-add-part').addEventListener('click', handleAddPart);
            document.getElementById('btn-add-packaging').addEventListener('click', handleAddPackaging);

            // SKU ìƒí’ˆê´€ë¦¬
            document.getElementById('btn-add-sku-product').addEventListener('click', () => openSkuProductModal());
            document.getElementById('sku-product-search').addEventListener('input', renderSkuProductsTable);

            // SKU ìƒí’ˆ ëª¨ë‹¬
            document.getElementById('sku-product-modal-close').addEventListener('click', closeSkuProductModal);
            document.getElementById('btn-cancel-sku-product').addEventListener('click', closeSkuProductModal);
            document.getElementById('btn-save-sku-product').addEventListener('click', handleSaveSkuProduct);
            document.getElementById('btn-add-composition').addEventListener('click', addCompositionItem);
            document.getElementById('sku-packaging').addEventListener('change', calculateSkuCost);

            // ê±°ë˜ì²˜ë³„ ìƒí’ˆê´€ë¦¬
            document.getElementById('btn-add-vendor').addEventListener('click', handleAddVendor);
            document.getElementById('btn-add-mapping').addEventListener('click', () => openMappingModal());
            document.getElementById('btn-import-mapping').addEventListener('click', openImportMappingModal);
            document.getElementById('btn-export-mapping').addEventListener('click', handleExportMapping);
            document.getElementById('mapping-search-input').addEventListener('input', renderMappingTable);

            // ë§¤ì¹­ ëª¨ë‹¬
            document.getElementById('mapping-modal-close').addEventListener('click', closeMappingModal);
            document.getElementById('btn-cancel-mapping').addEventListener('click', closeMappingModal);
            document.getElementById('btn-save-mapping').addEventListener('click', handleSaveMapping);

            // ë§¤ì¹­ Import ëª¨ë‹¬
            document.getElementById('import-mapping-modal-close').addEventListener('click', closeImportMappingModal);
            document.getElementById('btn-cancel-import-mapping').addEventListener('click', closeImportMappingModal);
            document.getElementById('import-mapping-upload-area').addEventListener('click', () => {
                document.getElementById('import-mapping-file-input').click();
            });
            document.getElementById('import-mapping-file-input').addEventListener('change', handleImportMappingFile);

            // Day ëª¨ë‹¬
            document.getElementById('day-modal-close').addEventListener('click', closeDayModal);
        }

        // ë©”ë‰´ í´ë¦­ (ê³µí†µ ë©”ë‰´ìš©)
        function handleMenuClick(item) {
            // ëª¨ë“  ë©”ë‰´ ì•„ì´í…œ ë° ì‚¬ìš©ì ë“œë¡­ë‹¤ìš´ ë¹„í™œì„±í™”
            document.querySelectorAll('.menu-item').forEach(i => i.classList.remove('active'));
            document.querySelectorAll('.user-dropdown-header').forEach(h => h.classList.remove('active'));

            // í˜ì´ì§€ ìˆ¨ê¹€
            document.querySelectorAll('.page-content').forEach(p => p.classList.remove('active'));

            // ì„ íƒí•œ ë©”ë‰´ í™œì„±í™”
            item.classList.add('active');

            // í˜ì´ì§€ í‘œì‹œ
            const pageId = item.dataset.page;
            showPage(pageId);

            // í†µí•©ì¡°íšŒ í˜ì´ì§€ì¸ ê²½ìš° ë°ì´í„° ë Œë”ë§
            if (pageId === 'integrated-view') {
                renderIntegratedView();
            }
        }

        // í˜ì´ì§€ í‘œì‹œ
        function showPage(pageId) {
            document.querySelectorAll('.page-content').forEach(p => p.classList.remove('active'));
            const page = document.getElementById(pageId);
            if (page) page.classList.add('active');
        }

        function switchToPage(pageId) {
            const item = document.querySelector(`.sidebar-menu > .menu-group > .menu-item[data-page="${pageId}"]`);
            if (item) {
                handleMenuClick(item);
            } else {
                showPage(pageId);
            }
        }

        // ==================== íŒŒì¼ ì—…ë¡œë“œ ====================
        function handleDragOver(e) {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        }

        function handleDragLeave() {
            uploadArea.classList.remove('dragover');
        }

        function handleDrop(e) {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            if (e.dataTransfer.files.length) {
                fileInput.files = e.dataTransfer.files;
                handleFileSelect();
            }
        }

        function handleFileSelect() {
            const files = Array.from(fileInput.files);
            if (files.length === 0) return;

            showLoading(true);
            workbooks = [];
            let loadedCount = 0;
            let totalSheets = 0;

            files.forEach((file, index) => {
                const reader = new FileReader();

                reader.onload = (e) => {
                    try {
                        const wb = XLSX.read(e.target.result, { type: 'array' });
                        workbooks.push({ workbook: wb, fileName: file.name });
                        totalSheets += wb.SheetNames.length;
                    } catch (err) {
                        showStatus(statusMsg, `íŒŒì¼ "${file.name}" ì½ê¸° ì˜¤ë¥˜: ${err.message}`, 'error');
                    }

                    loadedCount++;
                    if (loadedCount === files.length) {
                        // ëª¨ë“  íŒŒì¼ ë¡œë“œ ì™„ë£Œ
                        if (workbooks.length > 0) {
                            currentFileName = workbooks.map(w => w.fileName).join(', ');
                            fileInfo.textContent = `íŒŒì¼: ${workbooks.length}ê°œ | ì´ ì‹œíŠ¸: ${totalSheets}ê°œ`;
                            fileInfo.classList.add('show');
                            btnConvert.disabled = false;

                            // ì²« ë²ˆì§¸ íŒŒì¼ë¡œ ë°œì£¼ì²˜ ì¶”ì¸¡
                            guessVendorName(workbooks[0].fileName);

                            showStatus(statusMsg, `${workbooks.length}ê°œ íŒŒì¼ì„ ì„±ê³µì ìœ¼ë¡œ ì½ì—ˆìŠµë‹ˆë‹¤. ë³€í™˜ ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.`, 'success');
                        }
                        showLoading(false);
                    }
                };

                reader.readAsArrayBuffer(file);
            });
        }

        function guessVendorName(filename) {
            const vendors = Object.keys(skuData);
            vendorName.value = '';
            for (const v of vendors) {
                if (filename.toLowerCase().includes(v.toLowerCase())) {
                    vendorName.value = v;
                    break;
                }
            }
        }

        function updateVendorSelect() {
            if (!vendorName) return;
            const vendors = Object.keys(vendorMappings).sort((a, b) => a.localeCompare(b, 'ko'));
            vendorName.innerHTML = '<option value="">ë°œì£¼ì²˜ ì„ íƒ (í•„ìˆ˜)...</option>';
            vendors.forEach(v => {
                const option = document.createElement('option');
                option.value = v;
                option.textContent = v;
                vendorName.appendChild(option);
            });
        }

        // ë°œì£¼ì²˜ ê°„í¸ì¶”ê°€ í† ê¸€
        function toggleVendorQuickAdd() {
            const quickAddDiv = document.getElementById('vendor-quick-add');
            const input = document.getElementById('vendor-quick-input');
            if (quickAddDiv.style.display === 'none') {
                quickAddDiv.style.display = 'block';
                input.value = '';
                input.focus();
            } else {
                quickAddDiv.style.display = 'none';
            }
        }

        // ë°œì£¼ì²˜ ê°„í¸ì¶”ê°€ ì €ì¥
        function saveVendorQuickAdd() {
            const input = document.getElementById('vendor-quick-input');
            const newVendorName = input.value.trim();

            if (!newVendorName) {
                alert('ë°œì£¼ì²˜ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                input.focus();
                return;
            }

            // Firebase í‚¤ ìœ íš¨ì„± ê²€ì‚¬
            if (hasInvalidFirebaseKeyChars(newVendorName)) {
                alert(getInvalidFirebaseKeyCharsMessage());
                input.focus();
                return;
            }

            // ì¤‘ë³µ ì²´í¬
            if (vendorMappings[newVendorName]) {
                alert('ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ë°œì£¼ì²˜ì…ë‹ˆë‹¤.');
                input.focus();
                return;
            }

            // ìƒˆ ë°œì£¼ì²˜ ì¶”ê°€
            vendorMappings[newVendorName] = [];
            saveVendorMappings();
            updateVendorSelect();
            updateTemplateVendorSelect();

            // ìƒˆë¡œ ì¶”ê°€ëœ ë°œì£¼ì²˜ ì„ íƒ
            vendorName.value = newVendorName;

            // ì…ë ¥ì°½ ìˆ¨ê¸°ê¸°
            document.getElementById('vendor-quick-add').style.display = 'none';
            input.value = '';

            showStatus(statusMsg, `ë°œì£¼ì²˜ "${newVendorName}"ì´(ê°€) ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.`, 'success');
        }

        // ë°œì£¼ì²˜ ê°„í¸ì¶”ê°€ ì·¨ì†Œ
        function cancelVendorQuickAdd() {
            document.getElementById('vendor-quick-add').style.display = 'none';
            document.getElementById('vendor-quick-input').value = '';
        }

        // ==================== ë°œì£¼ì„œ ì–‘ì‹ ë‹¤ìš´ë¡œë“œ ====================
        function handleDownloadTemplate() {
            // ì–‘ì‹ í—¤ë”
            const headers = [
                'ì¶œê³ ìš”ì²­ì¼',
                'ë¬¼í’ˆëª…',
                'ìˆ˜ëŸ‰',
                'ìˆ˜ë ¹ì¸',
                'ìˆ˜ë ¹ì¸ì—°ë½ì²˜',
                'ìˆ˜ë ¹ì¸ì£¼ì†Œ',
                'ë°°ì†¡ë©”ì„¸ì§€',
                'ì£¼ë¬¸ë²ˆí˜¸(í•„ìˆ˜ê¸°ì¬x)',
                'ë°œì†¡ì¸',
                'ë°œì†¡ì¸ì—°ë½ì²˜(í•„ìˆ˜ê¸°ì¬x)',
                'ë°œì†¡ì¸ì£¼ì†Œ(í•„ìˆ˜ê¸°ì¬x)'
            ];

            // ì›Œí¬ì‹œíŠ¸ ë°ì´í„° ìƒì„± (í—¤ë”ë§Œ)
            const wsData = [headers];

            // ì›Œí¬ì‹œíŠ¸ ìƒì„±
            const ws = XLSX.utils.aoa_to_sheet(wsData);

            // ì»¬ëŸ¼ ë„ˆë¹„ ì„¤ì •
            ws['!cols'] = [
                { wch: 12 },  // ì¶œê³ ìš”ì²­ì¼
                { wch: 20 },  // ë¬¼í’ˆëª…
                { wch: 8 },   // ìˆ˜ëŸ‰
                { wch: 10 },  // ìˆ˜ë ¹ì¸
                { wch: 15 },  // ìˆ˜ë ¹ì¸ì—°ë½ì²˜
                { wch: 40 },  // ìˆ˜ë ¹ì¸ì£¼ì†Œ
                { wch: 25 },  // ë°°ì†¡ë©”ì„¸ì§€
                { wch: 18 },  // ì£¼ë¬¸ë²ˆí˜¸
                { wch: 10 },  // ë°œì†¡ì¸
                { wch: 20 },  // ë°œì†¡ì¸ì—°ë½ì²˜
                { wch: 25 }   // ë°œì†¡ì¸ì£¼ì†Œ
            ];

            // ì›Œí¬ë¶ ìƒì„±
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'ë°œì£¼ì„œ');

            // íŒŒì¼ ë‹¤ìš´ë¡œë“œ
            XLSX.writeFile(wb, 'ë°œì£¼ì„œ_ì–‘ì‹.xlsx');

            showToast('ë°œì£¼ì„œ ì–‘ì‹ì´ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
        }

        // ==================== ë³€í™˜ ì²˜ë¦¬ ====================
        function handleConvert() {
            if (workbooks.length === 0) {
                showStatus(statusMsg, 'ë¨¼ì € íŒŒì¼ì„ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.', 'error');
                return;
            }

            const selectedVendorValue = vendorName.value.trim();
            if (!selectedVendorValue) {
                showStatus(statusMsg, 'ë°œì£¼ì²˜ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.', 'error');
                vendorName.focus();
                return;
            }

            showLoading(true);

            try {
                convertedData = [];

                // ëª¨ë“  ì›Œí¬ë¶ ì²˜ë¦¬
                for (const { workbook, fileName } of workbooks) {
                    for (const sheetName of workbook.SheetNames) {
                        const sheet = workbook.Sheets[sheetName];
                        const rawData = XLSX.utils.sheet_to_json(sheet, { header: 1 });

                        const headerInfo = findHeaderRow(rawData);
                        if (!headerInfo) continue;

                        const { headerRowIdx, columns } = headerInfo;
                        const mapping = autoMapColumns(columns);

                        const dataRows = rawData.slice(headerRowIdx + 1).filter(row => {
                            return row && row.some(cell => cell !== undefined && cell !== null && cell !== '');
                        });

                        for (const row of dataRows) {
                            const item = convertRow(row, mapping, columns);
                            if (item) {
                                item._sourceFile = fileName; // ì›ë³¸ íŒŒì¼ëª… ì €ì¥
                                // SKU ë§¤ì¹­ í™•ì¸
                                const matchedSku = findMatchingSku(item.vendor, item.productCode);
                                if (matchedSku) {
                                    item.skuName = matchedSku.skuName;
                                    item._skuMatched = true;
                                    item._skuProductId = matchedSku.id;
                                } else {
                                    item.skuName = item.productName;
                                    item._skuMatched = false;
                                }
                                convertedData.push(item);
                            }
                        }
                    }
                }

                if (convertedData.length === 0) {
                    showStatus(statusMsg, 'ë³€í™˜í•  ë°ì´í„°ë¥¼ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ì—‘ì…€ íŒŒì¼ í˜•ì‹ì„ í™•ì¸í•´ì£¼ì„¸ìš”.', 'error');
                    showLoading(false);
                    return;
                }

                const fileCount = workbooks.length;
                renderResult();
                saveConvertedData();  // Firebaseì— ì €ì¥

                // í˜„ì¬ ì‚¬ìš©ìê°€ ìˆìœ¼ë©´ ì‚¬ìš©ì í˜ì´ì§€ë¡œ, ì•„ë‹ˆë©´ ì¼ë°˜ í˜ì´ì§€ë¡œ
                if (currentUser) {
                    selectUserPage(currentUser, 'result');
                } else {
                    switchToPage('result');
                }

                showStatus(statusMsg, `${fileCount}ê°œ íŒŒì¼ì—ì„œ ${convertedData.length}ê±´ì˜ ë°ì´í„°ë¥¼ ë³€í™˜í–ˆìŠµë‹ˆë‹¤.`, 'success');

                // íŒŒì¼ ì…ë ¥ ì´ˆê¸°í™” (ìƒˆ íŒŒì¼ ì—…ë¡œë“œ ê°€ëŠ¥í•˜ë„ë¡)
                workbooks = [];
                fileInput.value = '';
                fileInfo.textContent = '';
                fileInfo.classList.remove('show');
                btnConvert.disabled = true;
            } catch (err) {
                showStatus(statusMsg, 'ë³€í™˜ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + err.message, 'error');
            }

            showLoading(false);
        }

        function findHeaderRow(data) {
            // í—¤ë” ì¸ì‹ í‚¤ì›Œë“œ í™•ì¥
            const keywords = [
                // ìˆ˜ë ¹ì¸/ë°›ëŠ”ì‚¬ëŒ ê´€ë ¨
                'ìˆ˜ë ¹ì¸', 'ìˆ˜ì·¨ì¸', 'ë°›ëŠ”ë¶„', 'ë°›ëŠ”ì‚¬ëŒ', 'ìˆ˜ë ¹ì', 'ì„±ëª…', 'ì´ë¦„', 'ê³ ê°ëª…', 'ë°°ì†¡ì',
                // ì—°ë½ì²˜ ê´€ë ¨
                'ì—°ë½ì²˜', 'íœ´ëŒ€í°', 'í•¸ë“œí°', 'ì „í™”', 'í°ë²ˆí˜¸', 'hp', 'tel', 'íœ´ëŒ€ì „í™”', 'ì „í™”ë²ˆí˜¸', 'í•¸ë“œí°ë²ˆí˜¸',
                // ì£¼ì†Œ ê´€ë ¨
                'ì£¼ì†Œ', 'ë°°ì†¡ì§€', 'ë°°ì†¡ì£¼ì†Œ', 'ë„ë¡œëª…', 'ì§€ë²ˆ', 'ìš°í¸',
                // ìƒí’ˆ ê´€ë ¨
                'ìƒí’ˆ', 'í’ˆëª…', 'í’ˆëª©', 'ë¬¼í’ˆ', 'ì œí’ˆ', 'ë¬¼ê±´', 'ì•„ì´í…œ', 'item', 'product', 'ë‚´ìš©ë¬¼', 'ë‚´í’ˆ',
                // ì£¼ë¬¸ ê´€ë ¨
                'ì£¼ë¬¸', 'ì˜¤ë”', 'order', 'ë²ˆí˜¸',
                // ìˆ˜ëŸ‰ ê´€ë ¨
                'ìˆ˜ëŸ‰', 'ê°œìˆ˜', 'qty', 'quantity',
                // ë°œì†¡ì¸ ê´€ë ¨
                'ë°œì†¡ì¸', 'ë³´ë‚´ëŠ”', 'ì†¡í•˜ì¸', 'ë°œì‹ ',
                // ê¸°íƒ€
                'ë°°ì†¡', 'íƒë°°', 'ì†¡ì¥', 'ìš´ì†¡ì¥', 'ë©”ëª¨', 'ìš”ì²­', 'ë¹„ê³ '
            ];

            // ê²€ìƒ‰ ë²”ìœ„ë¥¼ 20í–‰ìœ¼ë¡œ í™•ì¥
            for (let i = 0; i < Math.min(20, data.length); i++) {
                const row = data[i];
                if (!row || row.length < 2) continue;

                let matchCount = 0;
                const columns = [];

                for (let j = 0; j < row.length; j++) {
                    const cell = row[j];
                    if (cell !== undefined && cell !== null && cell !== '') {
                        const cellStr = String(cell).replace(/[\s\n*]/g, '').toLowerCase();
                        columns.push({ index: j, name: String(cell).trim(), normalized: cellStr });

                        for (const keyword of keywords) {
                            if (cellStr.includes(keyword.toLowerCase())) {
                                matchCount++;
                                break;
                            }
                        }
                    }
                }

                // ìµœì†Œ 2ê°œ ì´ìƒ ë§¤ì¹­ë˜ë©´ í—¤ë”ë¡œ ì¸ì‹
                if (matchCount >= 2) {
                    return { headerRowIdx: i, columns };
                }
            }

            return null;
        }

        function autoMapColumns(columns) {
            const mapping = {};
            const usedColumns = new Set();

            for (const [targetKey, keywords] of Object.entries(MAPPING_RULES)) {
                for (const keyword of keywords) {
                    const keywordLower = keyword.toLowerCase();
                    for (const col of columns) {
                        if (usedColumns.has(col.index)) continue;
                        if (col.normalized === keywordLower) {
                            if (!isExcluded(col.normalized, targetKey)) {
                                mapping[targetKey] = col.index;
                                usedColumns.add(col.index);
                                break;
                            }
                        }
                    }
                    if (mapping[targetKey] !== undefined) break;
                }
            }

            for (const [targetKey, keywords] of Object.entries(MAPPING_RULES)) {
                if (mapping[targetKey] !== undefined) continue;
                for (const keyword of keywords) {
                    const keywordLower = keyword.toLowerCase();
                    for (const col of columns) {
                        if (usedColumns.has(col.index)) continue;
                        if (col.normalized.startsWith(keywordLower)) {
                            if (!isExcluded(col.normalized, targetKey)) {
                                mapping[targetKey] = col.index;
                                usedColumns.add(col.index);
                                break;
                            }
                        }
                    }
                    if (mapping[targetKey] !== undefined) break;
                }
            }

            for (const [targetKey, keywords] of Object.entries(MAPPING_RULES)) {
                if (mapping[targetKey] !== undefined) continue;
                for (const keyword of keywords) {
                    const keywordLower = keyword.toLowerCase();
                    if (keywordLower.length <= 2) continue;
                    for (const col of columns) {
                        if (usedColumns.has(col.index)) continue;
                        if (col.normalized.includes(keywordLower)) {
                            if (!isExcluded(col.normalized, targetKey)) {
                                mapping[targetKey] = col.index;
                                usedColumns.add(col.index);
                                break;
                            }
                        }
                    }
                    if (mapping[targetKey] !== undefined) break;
                }
            }

            const addressColumns = columns.filter(col =>
                !usedColumns.has(col.index) &&
                (col.normalized.includes('ì£¼ì†Œ') || col.normalized.includes('address')) &&
                !isExcluded(col.normalized, 'receiverAddr')
            );

            if (mapping['receiverAddr'] === undefined && addressColumns.length === 1) {
                mapping['receiverAddr'] = addressColumns[0].index;
                usedColumns.add(addressColumns[0].index);
            } else if (mapping['receiverAddr'] === undefined && addressColumns.length > 1) {
                const exactMatch = addressColumns.find(col => col.normalized === 'ì£¼ì†Œ' || col.normalized === 'address');
                if (exactMatch) {
                    mapping['receiverAddr'] = exactMatch.index;
                    usedColumns.add(exactMatch.index);
                } else {
                    const mainAddr = addressColumns.find(col => !col.normalized.includes('ìƒì„¸'));
                    if (mainAddr) {
                        mapping['receiverAddr'] = mainAddr.index;
                        usedColumns.add(mainAddr.index);
                    }
                }
            }

            if (mapping['receiverAddrDetail'] === undefined) {
                for (const col of columns) {
                    if (usedColumns.has(col.index)) continue;
                    if (col.normalized.includes('ìƒì„¸ì£¼ì†Œ') || col.normalized.includes('ìƒì„¸') ||
                        col.normalized === 'ì£¼ì†Œ2' || col.normalized === 'address2') {
                        mapping['receiverAddrDetail'] = col.index;
                        usedColumns.add(col.index);
                        break;
                    }
                }
            }

            if (mapping['receiverName'] !== undefined && mapping['receiverPhone'] === undefined) {
                const receiverIdx = mapping['receiverName'];
                for (const col of columns) {
                    if (col.index === receiverIdx + 1 && !usedColumns.has(col.index)) {
                        const name = col.normalized;
                        if (name.includes('íœ´ëŒ€') || name.includes('ì „í™”') || name.includes('ì—°ë½') || name.includes('í°') || name.includes('í•¸ë“œí°')) {
                            mapping['receiverPhone'] = col.index;
                            usedColumns.add(col.index);
                            break;
                        }
                    }
                }
            }

            // ìƒí’ˆëª… í´ë°±: ë§¤í•‘ ì•ˆëìœ¼ë©´ ì„ ë¬¼ì„¸íŠ¸ íŒ¨í„´(~ì„¸íŠ¸, ~í˜¸) ì»¬ëŸ¼ ì°¾ê¸°
            if (mapping['productName'] === undefined) {
                const giftSetPatterns = ['ì„¸íŠ¸', 'í˜¸', 'ì„ ë¬¼', 'íŒ¨í‚¤ì§€', 'êµ¬ì„±', 'ëª¨ë“¬', 'ì¢…í•©', 'íŠ¹ì„ ', 'ëª…í’ˆ', 'í”„ë¦¬ë¯¸ì—„'];
                for (const col of columns) {
                    if (usedColumns.has(col.index)) continue;
                    const colName = col.name;
                    // ì»¬ëŸ¼ëª…ì— ì„ ë¬¼ì„¸íŠ¸ íŒ¨í„´ì´ í¬í•¨ë˜ì–´ ìˆìœ¼ë©´ ìƒí’ˆëª…ìœ¼ë¡œ ë§¤í•‘
                    for (const pattern of giftSetPatterns) {
                        if (colName.includes(pattern)) {
                            mapping['productName'] = col.index;
                            usedColumns.add(col.index);
                            break;
                        }
                    }
                    if (mapping['productName'] !== undefined) break;
                }
            }

            return mapping;
        }

        function isExcluded(colName, targetKey) {
            const excludes = MAPPING_EXCLUDES[targetKey];
            if (!excludes) return false;
            for (const exclude of excludes) {
                if (colName.includes(exclude.toLowerCase())) {
                    return true;
                }
            }
            return false;
        }

        function convertRow(row, mapping, columns) {
            const item = { _selected: true, _id: generateId() };

            for (const target of RESULT_COLUMNS) {
                if (mapping[target.key] !== undefined) {
                    let value = row[mapping[target.key]];
                    if (value !== undefined && value !== null) {
                        value = String(value).trim();
                        if (target.key.includes('Phone')) {
                            value = formatPhone(value);
                        }
                        if (target.key === 'releaseDate') {
                            value = formatDateValue(value);
                        }
                    }
                    item[target.key] = value || '';
                } else {
                    item[target.key] = '';
                }
            }

            if (mapping['receiverAddrDetail'] !== undefined) {
                let detail = row[mapping['receiverAddrDetail']];
                if (detail !== undefined && detail !== null) {
                    detail = String(detail).trim();
                    if (detail && item.receiverAddr) {
                        item.receiverAddr = item.receiverAddr + ' ' + detail;
                    } else if (detail && !item.receiverAddr) {
                        item.receiverAddr = detail;
                    }
                }
            }

            if (!item.senderName && mapping['ordererName'] !== undefined) {
                let orderer = row[mapping['ordererName']];
                if (orderer !== undefined && orderer !== null) {
                    item.senderName = String(orderer).trim();
                }
            }

            if (!item.vendor && vendorName.value) {
                item.vendor = vendorName.value;
            }

            item.sourceFile = currentFileName;

            if (item.receiverName || item.productName || item.receiverAddr) {
                return item;
            }

            return null;
        }

        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        }

        function formatPhone(phone) {
            if (!phone) return '';
            let phoneStr = String(phone).trim();
            let digits = phoneStr.replace(/\D/g, '');

            if (phoneStr.includes('E') || phoneStr.includes('e')) {
                try {
                    const num = parseFloat(phoneStr);
                    if (!isNaN(num)) {
                        digits = Math.round(num).toString();
                    }
                } catch (e) {}
            }

            if (digits.length === 10 && !digits.startsWith('0')) {
                digits = '0' + digits;
            }

            if (digits.length === 11 && digits.startsWith('01')) {
                return `${digits.slice(0,3)}-${digits.slice(3,7)}-${digits.slice(7)}`;
            } else if (digits.length === 10 && digits.startsWith('01')) {
                return `${digits.slice(0,3)}-${digits.slice(3,6)}-${digits.slice(6)}`;
            } else if (digits.length === 10 && digits.startsWith('02')) {
                return `${digits.slice(0,2)}-${digits.slice(2,6)}-${digits.slice(6)}`;
            } else if (digits.length === 10) {
                return `${digits.slice(0,3)}-${digits.slice(3,6)}-${digits.slice(6)}`;
            } else if (digits.length === 9 && digits.startsWith('02')) {
                return `${digits.slice(0,2)}-${digits.slice(2,5)}-${digits.slice(5)}`;
            } else if (phoneStr.includes('-') && digits.length >= 9) {
                return phoneStr;
            }

            return phoneStr;
        }

        // ë‚ ì§œ í¬ë§· í•¨ìˆ˜
        function formatDateValue(value) {
            if (!value) return '';

            // Excel ë‚ ì§œ ì‹œë¦¬ì–¼ ë„˜ë²„ ì²˜ë¦¬ (ìˆ«ìì¸ ê²½ìš°)
            if (typeof value === 'number' || (typeof value === 'string' && /^\d+$/.test(value.trim()))) {
                const num = Number(value);
                // Excel ë‚ ì§œ ì‹œë¦¬ì–¼ ë„˜ë²„ ë²”ìœ„ ì²´í¬ (1900-01-01 ~ 2100-12-31 ì •ë„)
                if (num > 1 && num < 73050) {
                    // Excel ë‚ ì§œë¥¼ JavaScript Dateë¡œ ë³€í™˜
                    // Excel ë‚ ì§œëŠ” 1900-01-01ì„ 1ë¡œ ì‹œì‘ (1900ë…„ ìœ¤ë…„ ë²„ê·¸ ë³´ì •)
                    const excelEpoch = new Date(1899, 11, 30);
                    const date = new Date(excelEpoch.getTime() + num * 24 * 60 * 60 * 1000);
                    const year = date.getFullYear();
                    const month = String(date.getMonth() + 1).padStart(2, '0');
                    const day = String(date.getDate()).padStart(2, '0');
                    return `${year}-${month}-${day}`;
                }
            }

            // ë¬¸ìì—´ ë‚ ì§œ ì²˜ë¦¬
            const str = String(value).trim();

            // YYYY-MM-DD í˜•ì‹ì€ ê·¸ëŒ€ë¡œ ë°˜í™˜
            if (/^\d{4}-\d{2}-\d{2}$/.test(str)) {
                return str;
            }

            // YYYY/MM/DD í˜•ì‹
            if (/^\d{4}\/\d{2}\/\d{2}$/.test(str)) {
                return str.replace(/\//g, '-');
            }

            // YYYY.MM.DD í˜•ì‹
            if (/^\d{4}\.\d{2}\.\d{2}$/.test(str)) {
                return str.replace(/\./g, '-');
            }

            // MM/DD/YYYY í˜•ì‹
            if (/^\d{2}\/\d{2}\/\d{4}$/.test(str)) {
                const parts = str.split('/');
                return `${parts[2]}-${parts[0]}-${parts[1]}`;
            }

            // YYYYMMDD í˜•ì‹
            if (/^\d{8}$/.test(str)) {
                return `${str.slice(0,4)}-${str.slice(4,6)}-${str.slice(6,8)}`;
            }

            // Date ê°ì²´ë¡œ íŒŒì‹± ì‹œë„
            const parsed = new Date(str);
            if (!isNaN(parsed.getTime())) {
                const year = parsed.getFullYear();
                const month = String(parsed.getMonth() + 1).padStart(2, '0');
                const day = String(parsed.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            }

            // íŒŒì‹± ì‹¤íŒ¨ ì‹œ ì›ë³¸ ë°˜í™˜
            return str;
        }

        // ==================== ë³€í™˜ì™„ë£Œ ====================
        function renderResult() {
            if (convertedData.length === 0) {
                resultContent.style.display = 'block';
                resultData.style.display = 'none';
                return;
            }

            resultContent.style.display = 'none';
            resultData.style.display = 'block';

            const selectedCount = convertedData.filter(item => item._selected).length;
            const matchedCount = convertedData.filter(item => item._skuMatched).length;
            const unmatchedCount = convertedData.length - matchedCount;

            resultSummary.innerHTML = `
                <div class="summary-item">
                    <div class="number">${convertedData.length}</div>
                    <div class="label">ì „ì²´ ê±´ìˆ˜</div>
                </div>
                <div class="summary-item">
                    <div class="number">${selectedCount}</div>
                    <div class="label">ì„ íƒëœ ê±´ìˆ˜</div>
                </div>
                <div class="summary-item" style="background: #e8f5e9;">
                    <div class="number" style="color: #2e7d32;">${matchedCount}</div>
                    <div class="label">ë§¤ì¹­</div>
                </div>
                <div class="summary-item" style="${unmatchedCount > 0 ? 'background: #fff3cd;' : ''}">
                    <div class="number" style="${unmatchedCount > 0 ? 'color: #e74c3c;' : ''}">${unmatchedCount}</div>
                    <div class="label">${unmatchedCount > 0 ? 'âš ï¸ ë¯¸ë§¤ì¹­' : 'ë¯¸ë§¤ì¹­'}</div>
                </div>
            `;

            resultTable.innerHTML = buildTable(convertedData, 'result', RESULT_COLUMNS);
        }

        function buildTable(data, tableType, columns) {
            const headers = ['', '#', ...columns.map(c => c.name)];

            let html = '<table><thead><tr>';
            html += headers.map(h => `<th>${escapeHtml(h)}</th>`).join('');
            html += '</tr></thead><tbody>';

            data.forEach((item, idx) => {
                html += '<tr>';
                html += `<td class="checkbox-cell"><input type="checkbox" ${item._selected ? 'checked' : ''} onchange="handleRowToggle_${tableType}(${idx})"></td>`;
                html += `<td class="row-num">${idx + 1}</td>`;

                for (const col of columns) {
                    const value = escapeHtml(item[col.key] || '');
                    if (col.key === 'vendor') {
                        html += `<td><span class="vendor-tag">${value || '-'}</span></td>`;
                    } else if (col.key === 'sourceFile') {
                        html += `<td><span class="source-file" title="${value}">${value || '-'}</span></td>`;
                    } else if (col.key === 'skuName') {
                        const originalName = escapeHtml(item.productName || '');
                        const productCode = escapeHtml(item.productCode || '');
                        if (!item._skuMatched) {
                            // ë¯¸ë§¤ì¹­ ìƒíƒœ
                            if (tableType === 'confirmed') {
                                html += `<td style="min-width: 150px; max-width: 200px;">
                                    <div style="display: flex; align-items: center; gap: 4px;">
                                        <button class="btn btn-danger btn-small" onclick="openQuickMatchModal(${idx})" style="white-space: nowrap; padding: 2px 8px; font-size: 11px;">ë¯¸ë§¤ì¹­</button>
                                    </div>
                                    <div style="font-size: 11px; color: #666; margin-top: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;" title="ìƒí’ˆì½”ë“œ: ${productCode}">${originalName}</div>
                                </td>`;
                            } else {
                                html += `<td style="min-width: 150px; max-width: 200px;">
                                    <div style="display: flex; align-items: center; gap: 4px;">
                                        <span class="sku-unmatched">ë¯¸ë§¤ì¹­</span>
                                    </div>
                                    <div style="font-size: 11px; color: #666; margin-top: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;" title="ìƒí’ˆì½”ë“œ: ${productCode}">${originalName}</div>
                                </td>`;
                            }
                        } else {
                            html += `<td style="min-width: 150px; max-width: 200px;">
                                <div style="display: flex; align-items: center; gap: 4px; flex-wrap: nowrap;">
                                    <span class="sku-matched">ë§¤ì¹­</span>
                                    <span style="font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;" title="${value}">${value}</span>
                                </div>
                                <div style="font-size: 11px; color: #888; margin-top: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;" title="${originalName}">${originalName}</div>
                            </td>`;
                        }
                    } else if (col.key === 'packagingComposition' && tableType === 'confirmed') {
                        // í¬ì¥&êµ¬ì„± í‘œì‹œ
                        let packCompText = '-';
                        // SKU ì°¾ê¸°: _skuProductId â†’ skuName â†’ vendorMapping ìˆœìœ¼ë¡œ ì‹œë„
                        let sku = null;
                        if (item._skuProductId) {
                            sku = skuProducts.find(p => p.id === item._skuProductId);
                        }
                        if (!sku && item.skuName) {
                            sku = skuProducts.find(p => p.skuName === item.skuName);
                        }
                        if (!sku && item.vendor && item.productCode) {
                            // vendorMappingì—ì„œ ì°¾ê¸°
                            const mapping = vendorMappings[item.vendor]?.find(m => m.productCode === item.productCode);
                            if (mapping) {
                                sku = skuProducts.find(p => p.id === mapping.skuProductId);
                            }
                        }

                        if (sku) {
                            const packagingName = sku.packaging || '';
                            const compText = sku.composition && sku.composition.length > 0
                                ? sku.composition.map(c => {
                                    const partData = partsData[c.part];
                                    const type = partData ? (typeof partData === 'number' ? 'weight' : (partData.type || 'weight')) : 'weight';
                                    const qty = c.quantity || 1;
                                    if (type === 'unit') {
                                        return `${c.part}${qty}ê°œ`;
                                    } else {
                                        return `${c.part}${c.weight}g` + (qty > 1 ? `x${qty}` : '');
                                    }
                                }).join(',')
                                : '';
                            packCompText = packagingName ? `[${packagingName}] ${compText}` : compText || '-';
                        }
                        html += `<td style="font-size: 12px; color: #555; min-width: 180px; max-width: 250px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;" title="${escapeHtml(packCompText)}">${escapeHtml(packCompText)}</td>`;
                    } else if (col.key === 'invoiceNo' && tableType === 'confirmed') {
                        // ì†¡ì¥ë²ˆí˜¸ íŠ¹ë³„ ì²˜ë¦¬
                        if (value) {
                            html += `<td>
                                <span class="invoice-registered" title="ì†¡ì¥ë²ˆí˜¸: ${value}">${value}</span>
                            </td>`;
                        } else {
                            html += `<td>
                                <span class="invoice-pending">ë¯¸ë“±ë¡</span>
                            </td>`;
                        }
                    } else if (col.key === 'convertedDate') {
                        // íŒŒì¼ë³€í™˜ì¼ (ì½ê¸° ì „ìš©)
                        html += `<td style="font-size: 12px; color: #666;">${value || '-'}</td>`;
                    } else {
                        html += `<td><input type="text" value="${value}" style="min-width:${col.width}" onchange="handleCellChange_${tableType}(${idx}, '${col.key}', this.value)"></td>`;
                    }
                }

                html += '</tr>';
            });

            html += '</tbody></table>';
            return html;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML.replace(/"/g, '&quot;');
        }

        function handleRowToggle_result(idx) {
            convertedData[idx]._selected = !convertedData[idx]._selected;
            updateResultSummary();
        }
        window.handleRowToggle_result = handleRowToggle_result;

        function handleCellChange_result(idx, key, value) {
            convertedData[idx][key] = value;
        }
        window.handleCellChange_result = handleCellChange_result;

        function handleToggleAll(selected) {
            convertedData.forEach(item => item._selected = selected);
            document.querySelectorAll('#result-table input[type="checkbox"]').forEach(cb => {
                cb.checked = selected;
            });
            updateResultSummary();
        }

        function updateResultSummary() {
            const selectedCount = convertedData.filter(item => item._selected).length;
            const matchedCount = convertedData.filter(item => item._skuMatched).length;
            const unmatchedCount = convertedData.length - matchedCount;

            resultSummary.innerHTML = `
                <div class="summary-item">
                    <div class="number">${convertedData.length}</div>
                    <div class="label">ì „ì²´ ê±´ìˆ˜</div>
                </div>
                <div class="summary-item">
                    <div class="number">${selectedCount}</div>
                    <div class="label">ì„ íƒëœ ê±´ìˆ˜</div>
                </div>
                <div class="summary-item" style="background: #e8f5e9;">
                    <div class="number" style="color: #2e7d32;">${matchedCount}</div>
                    <div class="label">ë§¤ì¹­</div>
                </div>
                <div class="summary-item" style="${unmatchedCount > 0 ? 'background: #fff3cd;' : ''}">
                    <div class="number" style="${unmatchedCount > 0 ? 'color: #e74c3c;' : ''}">${unmatchedCount}</div>
                    <div class="label">${unmatchedCount > 0 ? 'âš ï¸ ë¯¸ë§¤ì¹­' : 'ë¯¸ë§¤ì¹­'}</div>
                </div>
            `;
        }

        // ==================== ì¼ê´„ì…ë ¥ ëª¨ë‹¬ ====================
        function openBulkEditModal() {
            const selectedItems = convertedData.filter(item => item._selected);

            if (selectedItems.length === 0) {
                showStatus(resultStatus, 'ì¼ê´„ì…ë ¥í•  í•­ëª©ì„ ì„ íƒí•´ì£¼ì„¸ìš”.', 'error');
                return;
            }

            // ì„ íƒ ê±´ìˆ˜ í‘œì‹œ
            document.getElementById('bulk-edit-count').textContent = selectedItems.length;

            // ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
            document.getElementById('bulk-edit-product-name').value = '';
            document.getElementById('bulk-edit-quantity').value = '';
            document.getElementById('bulk-edit-sender-name').value = '';
            document.getElementById('bulk-edit-sender-phone').value = '';
            document.getElementById('bulk-edit-sender-addr').value = '';

            // ëª¨ë‹¬ í‘œì‹œ
            document.getElementById('bulk-edit-modal').classList.add('show');
        }

        function closeBulkEditModal() {
            document.getElementById('bulk-edit-modal').classList.remove('show');
        }

        function applyBulkEdit() {
            const productName = document.getElementById('bulk-edit-product-name').value.trim();
            const quantity = document.getElementById('bulk-edit-quantity').value.trim();
            const senderName = document.getElementById('bulk-edit-sender-name').value.trim();
            const senderPhone = document.getElementById('bulk-edit-sender-phone').value.trim();
            const senderAddr = document.getElementById('bulk-edit-sender-addr').value.trim();

            // ëª¨ë“  í•„ë“œê°€ ë¹„ì–´ìˆìœ¼ë©´ ê²½ê³ 
            if (!productName && !quantity && !senderName && !senderPhone && !senderAddr) {
                alert('ìµœì†Œ í•˜ë‚˜ì˜ í•„ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            let updatedCount = 0;

            convertedData.forEach(item => {
                if (item._selected) {
                    if (productName) {
                        item.productName = productName;
                        item.skuName = productName;
                    }
                    if (quantity) {
                        item.quantity = parseInt(quantity) || 1;
                    }
                    if (senderName) {
                        item.senderName = senderName;
                    }
                    if (senderPhone) {
                        item.senderPhone = senderPhone;
                    }
                    if (senderAddr) {
                        item.senderAddr = senderAddr;
                    }
                    updatedCount++;
                }
            });

            closeBulkEditModal();
            renderResult();
            showStatus(resultStatus, `${updatedCount}ê±´ì˜ ë°ì´í„°ê°€ ì¼ê´„ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.`, 'success');
        }

        // ==================== ë³€í™˜í™•ì • ====================
        function handleAddToConfirmed() {
            const selectedItems = convertedData.filter(item => item._selected);

            if (selectedItems.length === 0) {
                showStatus(resultStatus, 'ë³€í™˜í™•ì •í•  í•­ëª©ì„ ì„ íƒí•´ì£¼ì„¸ìš”.', 'error');
                return;
            }

            // í•„ìˆ˜ê°’ ê²€ì¦
            const requiredFields = [
                { key: 'productName', name: 'ìƒí’ˆëª…' },
                { key: 'quantity', name: 'ìˆ˜ëŸ‰' },
                { key: 'receiverName', name: 'ìˆ˜ë ¹ì¸' },
                { key: 'receiverPhone', name: 'ìˆ˜ë ¹ì¸ì—°ë½ì²˜' },
                { key: 'receiverAddr', name: 'ìˆ˜ë ¹ì¸ì£¼ì†Œ' }
            ];

            const missingItems = [];
            selectedItems.forEach((item, idx) => {
                const missingFields = [];
                requiredFields.forEach(field => {
                    const value = item[field.key];
                    if (!value || (typeof value === 'string' && value.trim() === '')) {
                        missingFields.push(field.name);
                    }
                });
                if (missingFields.length > 0) {
                    missingItems.push({ index: idx + 1, fields: missingFields });
                }
            });

            if (missingItems.length > 0) {
                const errorMsg = missingItems.slice(0, 5).map(item =>
                    `${item.index}ë²ˆì§¸ í•­ëª©: ${item.fields.join(', ')} ëˆ„ë½`
                ).join('\n');
                const moreMsg = missingItems.length > 5 ? `\n...ì™¸ ${missingItems.length - 5}ê±´` : '';
                alert(`í•„ìˆ˜ê°’ì´ ëˆ„ë½ëœ í•­ëª©ì´ ìˆìŠµë‹ˆë‹¤.\n\n${errorMsg}${moreMsg}\n\nìƒí’ˆëª…, ìˆ˜ëŸ‰, ìˆ˜ë ¹ì¸, ìˆ˜ë ¹ì¸ì—°ë½ì²˜, ìˆ˜ë ¹ì¸ì£¼ì†ŒëŠ” í•„ìˆ˜ì…ë‹ˆë‹¤.`);
                return;
            }

            // íŒŒì¼ë³€í™˜ì¼ (ì˜¤ëŠ˜ ë‚ ì§œ)
            const today = new Date();
            const convertedDate = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;

            selectedItems.forEach(item => {
                const newItem = { ...item, _selected: true, _id: generateId(), convertedDate };

                // ìƒí’ˆì½”ë“œê°€ ì—†ìœ¼ë©´ ìƒí’ˆëª…ìœ¼ë¡œ ì„¤ì •
                if (!newItem.productCode && newItem.productName) {
                    newItem.productCode = newItem.productName;
                }

                if (newItem.receiverName && !newItem.receiverName.endsWith('ë‹˜')) {
                    newItem.receiverName = newItem.receiverName + 'ë‹˜';
                }

                const matchedSku = findMatchingSku(newItem.vendor, newItem.productCode);
                if (matchedSku) {
                    newItem.skuName = matchedSku.skuName;
                    newItem._skuMatched = true;
                    newItem._skuProductId = matchedSku.id;  // SKU ID ì €ì¥ (í¬ì¥&êµ¬ì„± í‘œì‹œìš©)
                } else {
                    newItem.skuName = newItem.productName;
                    newItem._skuMatched = false;
                }

                confirmedData.push(newItem);
            });

            // ë³€í™˜í™•ì •ëœ í•­ëª©ì€ ë³€í™˜ì™„ë£Œì—ì„œ ì‚­ì œ
            convertedData = convertedData.filter(item => !item._selected);
            renderResult();
            renderConfirmed();

            saveConvertedAndConfirmedData();  // Firebaseì— ë™ì‹œ ì €ì¥ (race condition ë°©ì§€)

            showStatus(resultStatus, `${selectedItems.length}ê±´ì´ ë³€í™˜í™•ì • ëª©ë¡ì— ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.`, 'success');
            setTimeout(() => {
                if (currentUser) {
                    selectUserPage(currentUser, 'confirmed');
                } else {
                    switchToPage('confirmed');
                }
            }, 500);
        }

        function findMatchingSku(vendor, productCode) {
            if (!vendor || !productCode || !vendorMappings[vendor]) {
                return null;
            }

            const mappings = vendorMappings[vendor];
            const productCodeClean = String(productCode).trim();

            // ì •í™•í•œ ìƒí’ˆì½”ë“œ ë§¤ì¹­
            const mapping = mappings.find(m => String(m.productCode).trim() === productCodeClean);

            if (mapping) {
                const sku = skuProducts.find(p => p.id === mapping.skuProductId);
                return sku || null;
            }

            return null;
        }

        function calculateSimilarity(str1, str2) {
            if (!str1 || !str2) return 0;
            if (str1 === str2) return 1;

            const clean1 = str1.replace(/[\s\-\_\(\)\[\]]/g, '');
            const clean2 = str2.replace(/[\s\-\_\(\)\[\]]/g, '');

            if (clean1 === clean2) return 1;

            const ngrams1 = getNgrams(clean1, 2);
            const ngrams2 = getNgrams(clean2, 2);

            const intersection = ngrams1.filter(g => ngrams2.includes(g)).length;
            const union = new Set([...ngrams1, ...ngrams2]).size;

            if (union === 0) return 0;
            return intersection / union;
        }

        function getNgrams(str, n) {
            const ngrams = [];
            for (let i = 0; i <= str.length - n; i++) {
                ngrams.push(str.substring(i, i + n));
            }
            return ngrams;
        }

        function renderConfirmed() {
            updateConfirmedBadge();

            if (confirmedData.length === 0) {
                confirmedContent.style.display = 'block';
                confirmedDataEl.style.display = 'none';
                return;
            }

            confirmedContent.style.display = 'none';
            confirmedDataEl.style.display = 'block';

            // í•„í„°/ì •ë ¬ ì ìš©ëœ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
            const filteredData = getFilteredConfirmedData();

            const selectedCount = confirmedData.filter(item => item._selected).length;
            const unmatchedCount = confirmedData.filter(item => !item._skuMatched).length;
            const registeredCount = confirmedData.filter(item => item.invoiceNo).length;
            const unregisteredCount = confirmedData.length - registeredCount;
            const duplicateCount = confirmedData.filter(item => isDuplicateInOrderManagement(item)).length;

            const vendorCounts = {};
            confirmedData.forEach(item => {
                const vendor = item.vendor || 'ë¯¸ì§€ì •';
                vendorCounts[vendor] = (vendorCounts[vendor] || 0) + 1;
            });

            // í•„í„° í™œì„±í™” ì—¬ë¶€
            const hasActiveFilters = Object.keys(confirmedFilters).some(k => confirmedFilters[k] && confirmedFilters[k].length > 0);

            let summaryHtml = `
                <div class="summary-item">
                    <div class="number">${confirmedData.length}</div>
                    <div class="label">ì „ì²´ ê±´ìˆ˜</div>
                </div>
                ${hasActiveFilters ? `
                <div class="summary-item" style="background: #e3f2fd;">
                    <div class="number" style="color: #1565c0;">${filteredData.length}</div>
                    <div class="label">í•„í„°ë¨</div>
                </div>
                ` : ''}
                <div class="summary-item">
                    <div class="number">${selectedCount}</div>
                    <div class="label">ì„ íƒëœ ê±´ìˆ˜</div>
                </div>
                <div class="summary-item" style="${unmatchedCount > 0 ? 'background: #fff3cd;' : ''}">
                    <div class="number" style="${unmatchedCount > 0 ? 'color: #e74c3c;' : ''}">${unmatchedCount}</div>
                    <div class="label">${unmatchedCount > 0 ? 'âš ï¸ ë¯¸ë§¤ì¹­' : 'ë¯¸ë§¤ì¹­'}</div>
                </div>
                <div class="summary-item" style="background: #e8f5e9;">
                    <div class="number" style="color: #2e7d32;">${registeredCount}</div>
                    <div class="label">ì†¡ì¥ë“±ë¡</div>
                </div>
                <div class="summary-item" style="${unregisteredCount > 0 ? 'background: #fff3e0;' : ''}">
                    <div class="number" style="${unregisteredCount > 0 ? 'color: #e65100;' : ''}">${unregisteredCount}</div>
                    <div class="label">ë¯¸ë“±ë¡</div>
                </div>
                ${duplicateCount > 0 ? `
                <div class="summary-item" style="background: #ffebee;">
                    <div class="number" style="color: #e74c3c;">${duplicateCount}</div>
                    <div class="label">âš ï¸ ì¤‘ë³µ</div>
                </div>
                ` : ''}
            `;

            for (const [vendor, count] of Object.entries(vendorCounts)) {
                summaryHtml += `
                    <div class="summary-item">
                        <div class="number">${count}</div>
                        <div class="label">${escapeHtml(vendor)}</div>
                    </div>
                `;
            }

            confirmedSummary.innerHTML = summaryHtml;
            confirmedTable.innerHTML = buildConfirmedTable(filteredData);
            updateFilterResetButton();
        }

        // í•„í„°/ì •ë ¬ ì ìš©ëœ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
        function getFilteredConfirmedData() {
            let data = [...confirmedData];

            // í•„í„° ì ìš©
            Object.keys(confirmedFilters).forEach(key => {
                const filterValues = confirmedFilters[key];
                if (filterValues && filterValues.length > 0) {
                    data = data.filter(item => {
                        const value = getDisplayValue(item, key);
                        return filterValues.includes(value);
                    });
                }
            });

            // ì •ë ¬ ì ìš©
            if (confirmedSort.key && confirmedSort.direction) {
                data.sort((a, b) => {
                    const aVal = getDisplayValue(a, confirmedSort.key) || '';
                    const bVal = getDisplayValue(b, confirmedSort.key) || '';

                    // ì¶œê³ ìš”ì²­ì¼ ì •ë ¬ ì‹œ: ë¯¸ë“±ë¡(ë¹ˆê°’)ì´ ìµœìƒë‹¨
                    if (confirmedSort.key === 'releaseDate') {
                        const aEmpty = !aVal || aVal === '';
                        const bEmpty = !bVal || bVal === '';
                        if (aEmpty && !bEmpty) return -1; // aê°€ ë¹ˆê°’ì´ë©´ ìœ„ë¡œ
                        if (!aEmpty && bEmpty) return 1;  // bê°€ ë¹ˆê°’ì´ë©´ ìœ„ë¡œ
                    }

                    let comparison = 0;
                    if (aVal < bVal) comparison = -1;
                    else if (aVal > bVal) comparison = 1;

                    return confirmedSort.direction === 'desc' ? -comparison : comparison;
                });
            }

            return data;
        }

        // í‘œì‹œìš© ê°’ ê°€ì ¸ì˜¤ê¸°
        function getDisplayValue(item, key) {
            if (key === 'packagingComposition') {
                // SKUì—ì„œ í¬ì¥&êµ¬ì„± ì •ë³´ ê°€ì ¸ì˜¤ê¸°
                let sku = null;
                if (item._skuProductId) {
                    sku = skuProducts.find(p => p.id === item._skuProductId);
                }
                if (!sku && item.skuName) {
                    sku = skuProducts.find(p => p.skuName === item.skuName);
                }
                if (sku && sku.packaging) {
                    return `[${sku.packaging}]`;
                }
                return '-';
            }
            return item[key] || '';
        }

        // ì „ì²´ì£¼ë¬¸ê´€ë¦¬ì— ì´ë¯¸ ë“±ë¡ëœ ì¤‘ë³µ í•­ëª©ì¸ì§€ ì²´í¬
        function isDuplicateInOrderManagement(item) {
            return orderManagementData.some(existing => {
                const sameOrderNo = item.orderNo && existing.orderNo && item.orderNo === existing.orderNo;
                const sameReceiver = item.receiverName === existing.receiverName &&
                                     item.receiverPhone === existing.receiverPhone;
                const sameProduct = (item.productName === existing.productName || item.skuName === existing.skuName);

                // ì£¼ë¬¸ë²ˆí˜¸ê°€ ìˆìœ¼ë©´ ì£¼ë¬¸ë²ˆí˜¸ + ìˆ˜ë ¹ì¸ìœ¼ë¡œ ì²´í¬, ì—†ìœ¼ë©´ ìˆ˜ë ¹ì¸ + ìƒí’ˆëª…ìœ¼ë¡œ ì²´í¬
                if (item.orderNo) {
                    return sameOrderNo && sameReceiver;
                } else {
                    return sameReceiver && sameProduct;
                }
            });
        }

        // ë³€í™˜í™•ì • í…Œì´ë¸” ë¹Œë“œ (í•„í„° í—¤ë” í¬í•¨)
        function buildConfirmedTable(data) {
            const columns = TARGET_COLUMNS;

            // í•„í„° ê°€ëŠ¥í•œ ì»¬ëŸ¼ë“¤
            const filterableColumns = ['convertedDate', 'vendor', 'releaseDate', 'productCode', 'skuName', 'receiverName', 'senderName', 'deliveryNo'];

            let html = '<table><thead><tr>';
            html += '<th class="checkbox-cell"></th>';
            html += '<th>#</th>';

            columns.forEach(col => {
                const isFilterable = filterableColumns.includes(col.key);
                const hasFilter = confirmedFilters[col.key] && confirmedFilters[col.key].length > 0;
                const isCurrentSort = confirmedSort.key === col.key;

                if (isFilterable) {
                    html += `<th class="th-filter" data-filter-col="${col.key}">
                        <div class="th-filter-wrapper">
                            <div class="th-content" onclick="window.toggleSort('${col.key}')">
                                <span class="th-title">${col.name}</span>
                                <span class="th-sort-icons">
                                    <span class="sort-icon ${isCurrentSort && confirmedSort.direction === 'asc' ? 'active' : ''}">â–²</span>
                                    <span class="sort-icon ${isCurrentSort && confirmedSort.direction === 'desc' ? 'active' : ''}">â–¼</span>
                                </span>
                            </div>
                            <span class="filter-icon-btn ${hasFilter ? 'active' : ''}" onclick="event.stopPropagation(); window.openFilterDropdown(event, '${col.key}')">â–¼</span>
                        </div>
                        <div class="filter-dropdown" id="filter-dropdown-${col.key}" onclick="event.stopPropagation()"></div>
                    </th>`;
                } else {
                    html += `<th>${col.name}</th>`;
                }
            });
            html += '</tr></thead><tbody>';

            // ì›ë³¸ ë°ì´í„°ì—ì„œ í•„í„°ëœ ë°ì´í„°ì˜ ì¸ë±ìŠ¤ ë§¤í•‘
            data.forEach((item) => {
                const originalIdx = confirmedData.indexOf(item);
                html += '<tr>';
                html += `<td class="checkbox-cell"><input type="checkbox" ${item._selected ? 'checked' : ''} onchange="handleRowToggle_confirmed(${originalIdx})"></td>`;
                html += `<td class="row-num">${originalIdx + 1}</td>`;

                for (const col of columns) {
                    const value = escapeHtml(item[col.key] || '');
                    if (col.key === 'vendor') {
                        html += `<td><span class="vendor-tag">${value || '-'}</span></td>`;
                    } else if (col.key === 'sourceFile') {
                        html += `<td><span class="source-file" title="${value}">${value || '-'}</span></td>`;
                    } else if (col.key === 'skuName') {
                        const originalName = escapeHtml(item.productName || '');
                        const productCode = escapeHtml(item.productCode || '');
                        if (!item._skuMatched) {
                            html += `<td style="min-width: 150px; max-width: 200px;">
                                <div style="display: flex; align-items: center; gap: 4px;">
                                    <button class="btn btn-danger btn-small" onclick="openQuickMatchModal(${originalIdx})" style="white-space: nowrap; padding: 2px 8px; font-size: 11px;">ë¯¸ë§¤ì¹­</button>
                                </div>
                                <div style="font-size: 11px; color: #666; margin-top: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;" title="ìƒí’ˆì½”ë“œ: ${productCode}">${originalName}</div>
                            </td>`;
                        } else {
                            html += `<td style="min-width: 150px; max-width: 200px;">
                                <div style="display: flex; align-items: center; gap: 4px; flex-wrap: nowrap;">
                                    <span class="sku-matched">ë§¤ì¹­</span>
                                    <span style="font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;" title="${value}">${value}</span>
                                </div>
                                <div style="font-size: 11px; color: #888; margin-top: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;" title="${originalName}">${originalName}</div>
                            </td>`;
                        }
                    } else if (col.key === 'packagingComposition') {
                        let packCompText = '-';
                        let sku = null;
                        if (item._skuProductId) {
                            sku = skuProducts.find(p => p.id === item._skuProductId);
                        }
                        if (!sku && item.skuName) {
                            sku = skuProducts.find(p => p.skuName === item.skuName);
                        }
                        if (!sku && item.vendor && item.productCode) {
                            const mapping = vendorMappings[item.vendor]?.find(m => m.productCode === item.productCode);
                            if (mapping) {
                                sku = skuProducts.find(p => p.id === mapping.skuProductId);
                            }
                        }
                        if (sku) {
                            const packagingName = sku.packaging || '';
                            const compText = sku.composition && sku.composition.length > 0
                                ? sku.composition.map(c => {
                                    const partData = partsData[c.part];
                                    const type = partData ? (typeof partData === 'number' ? 'weight' : (partData.type || 'weight')) : 'weight';
                                    const qty = c.quantity || 1;
                                    if (type === 'unit') {
                                        return `${c.part}${qty}ê°œ`;
                                    } else {
                                        return `${c.part}${c.weight}g` + (qty > 1 ? `x${qty}` : '');
                                    }
                                }).join(',')
                                : '';
                            packCompText = packagingName ? `[${packagingName}] ${compText}` : compText || '-';
                        }
                        html += `<td style="font-size: 12px; color: #555; min-width: 180px; max-width: 250px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;" title="${escapeHtml(packCompText)}">${escapeHtml(packCompText)}</td>`;
                    } else if (col.key === 'invoiceNo') {
                        if (value) {
                            html += `<td><span class="invoice-registered" title="ì†¡ì¥ë²ˆí˜¸: ${value}">${value}</span></td>`;
                        } else {
                            html += `<td><span class="invoice-pending">ë¯¸ë“±ë¡</span></td>`;
                        }
                    } else if (col.key === 'convertedDate') {
                        const isDuplicate = isDuplicateInOrderManagement(item);
                        const duplicateTag = isDuplicate ? '<span style="color: #e74c3c; font-size: 10px; font-weight: 600; margin-left: 4px;">ì¤‘ë³µ</span>' : '';
                        html += `<td style="font-size: 12px; color: #666;">${value || '-'}${duplicateTag}</td>`;
                    } else if (col.key === 'releaseDate') {
                        // ì¶œê³ ìš”ì²­ì¼ - ë‚ ì§œ ì…ë ¥ ê°€ëŠ¥
                        html += `<td><input type="date" value="${value}" class="editable-date" onchange="window.handleCellChange_confirmed(${originalIdx}, '${col.key}', this.value)"></td>`;
                    } else if (col.key === 'note') {
                        // ë¹„ê³  - í…ìŠ¤íŠ¸ ì…ë ¥ ê°€ëŠ¥
                        html += `<td><input type="text" value="${value}" class="editable-note" placeholder="ë¹„ê³  ì…ë ¥" onchange="window.handleCellChange_confirmed(${originalIdx}, '${col.key}', this.value)"></td>`;
                    } else {
                        html += `<td>${value || '-'}</td>`;
                    }
                }
                html += '</tr>';
            });

            html += '</tbody></table>';
            return html;
        }

        // ì •ë ¬ í† ê¸€ (ì»¬ëŸ¼ ì œëª© í´ë¦­ ì‹œ)
        function toggleSort(columnKey) {
            closeAllFilterDropdowns();

            if (confirmedSort.key === columnKey) {
                // ê°™ì€ ì»¬ëŸ¼: ì˜¤ë¦„ì°¨ìˆœ â†’ ë‚´ë¦¼ì°¨ìˆœ â†’ ì •ë ¬í•´ì œ
                if (confirmedSort.direction === 'asc') {
                    confirmedSort.direction = 'desc';
                } else if (confirmedSort.direction === 'desc') {
                    confirmedSort = { key: null, direction: null };
                } else {
                    confirmedSort = { key: columnKey, direction: 'asc' };
                }
            } else {
                // ë‹¤ë¥¸ ì»¬ëŸ¼: ì˜¤ë¦„ì°¨ìˆœìœ¼ë¡œ ì‹œì‘
                confirmedSort = { key: columnKey, direction: 'asc' };
            }

            renderConfirmed();
        }
        window.toggleSort = toggleSort;

        // í•„í„° ë“œë¡­ë‹¤ìš´ ì—´ê¸° (í•„í„° ì•„ì´ì½˜ í´ë¦­ ì‹œ)
        function openFilterDropdown(e, columnKey) {
            e.stopPropagation();
            const th = e.target.closest('.th-filter');
            toggleFilterDropdown(columnKey, th);
        }
        window.openFilterDropdown = openFilterDropdown;

        // í•„í„° ë“œë¡­ë‹¤ìš´ í† ê¸€
        function toggleFilterDropdown(columnKey, thElement) {
            const dropdown = document.getElementById(`filter-dropdown-${columnKey}`);
            if (!dropdown) {
                return;
            }

            // ë‹¤ë¥¸ ë“œë¡­ë‹¤ìš´ ë‹«ê¸°
            document.querySelectorAll('.filter-dropdown.show').forEach(d => {
                if (d !== dropdown) d.classList.remove('show');
            });

            if (dropdown.classList.contains('show')) {
                dropdown.classList.remove('show');
                activeFilterDropdown = null;
            } else {
                // ë“œë¡­ë‹¤ìš´ ë‚´ìš© ìƒì„±
                dropdown.innerHTML = buildFilterDropdownContent(columnKey);

                // ë“œë¡­ë‹¤ìš´ ìœ„ì¹˜ ê³„ì‚° (position: fixed ì‚¬ìš©)
                if (thElement) {
                    const rect = thElement.getBoundingClientRect();
                    dropdown.style.top = (rect.bottom + 2) + 'px';
                    dropdown.style.left = rect.left + 'px';

                    // í™”ë©´ ì˜¤ë¥¸ìª½ì„ ë²—ì–´ë‚˜ë©´ ì™¼ìª½ìœ¼ë¡œ ì¡°ì •
                    const dropdownWidth = 220;
                    if (rect.left + dropdownWidth > window.innerWidth) {
                        dropdown.style.left = (window.innerWidth - dropdownWidth - 10) + 'px';
                    }
                }

                dropdown.classList.add('show');
                activeFilterDropdown = columnKey;
            }
        }
        window.toggleFilterDropdown = toggleFilterDropdown;

        // ì„ì‹œ í•„í„° ìƒíƒœ (ì¡°íšŒ ë²„íŠ¼ ëˆ„ë¥´ê¸° ì „ê¹Œì§€ì˜ ì„ íƒ ìƒíƒœ)
        let pendingFilterSelections = {};

        // í•„í„° ë“œë¡­ë‹¤ìš´ ë‚´ìš© ìƒì„±
        function buildFilterDropdownContent(columnKey) {
            // í•´ë‹¹ ì»¬ëŸ¼ì˜ ê³ ìœ ê°’ ìˆ˜ì§‘
            const valueCounts = {};
            confirmedData.forEach(item => {
                const value = getDisplayValue(item, columnKey) || '(ë¹ˆ ê°’)';
                valueCounts[value] = (valueCounts[value] || 0) + 1;
            });

            const sortedValues = Object.keys(valueCounts).sort();
            const currentFilters = confirmedFilters[columnKey] || [];

            // ì„ì‹œ ì„ íƒ ìƒíƒœ ì´ˆê¸°í™” (í˜„ì¬ í•„í„° ìƒíƒœ ê¸°ë°˜)
            pendingFilterSelections[columnKey] = currentFilters.length === 0
                ? [...sortedValues]  // í•„í„° ì—†ìœ¼ë©´ ì „ì²´ ì„ íƒ
                : [...currentFilters];  // ê¸°ì¡´ í•„í„° ê°’ ë³µì‚¬

            // ê°’ ëª©ë¡ì„ ì „ì—­ì— ì €ì¥
            window._filterValues = window._filterValues || {};
            window._filterValues[columnKey] = sortedValues;

            let html = `
                <div class="filter-header" onclick="event.stopPropagation()">
                    <input type="text" placeholder="ê²€ìƒ‰..." oninput="window.filterDropdownSearch('${columnKey}', this.value)">
                </div>
                <div class="filter-select-actions" onclick="event.stopPropagation()">
                    <button class="btn-select-all" onclick="event.stopPropagation(); window.selectAllFilterValues('${columnKey}')">ì „ì²´ì„ íƒ</button>
                    <button class="btn-deselect-all" onclick="event.stopPropagation(); window.deselectAllFilterValues('${columnKey}')">ì „ì²´í•´ì œ</button>
                    <button class="btn-apply-filter" onclick="event.stopPropagation(); window.applyPendingFilter('${columnKey}')">ì¡°íšŒ</button>
                </div>
                <div class="filter-list" id="filter-list-${columnKey}" onclick="event.stopPropagation()">
            `;

            sortedValues.forEach((value, idx) => {
                const isChecked = currentFilters.length === 0 || currentFilters.includes(value);
                const displayValue = value.length > 30 ? value.substring(0, 30) + '...' : value;
                html += `
                    <div class="filter-item" data-value="${escapeHtml(value)}" data-col="${columnKey}" data-idx="${idx}" onclick="event.stopPropagation()">
                        <input type="checkbox" ${isChecked ? 'checked' : ''} onchange="event.stopPropagation(); window.togglePendingFilterValue('${columnKey}', ${idx}, this.checked)">
                        <span class="filter-item-label" title="${escapeHtml(value)}">${escapeHtml(displayValue)}</span>
                        <span class="filter-item-count">(${valueCounts[value]})</span>
                    </div>
                `;
            });

            html += '</div>';
            return html;
        }

        // ì„ì‹œ í•„í„° ê°’ í† ê¸€ (ì²´í¬ë°•ìŠ¤ ë³€ê²½ ì‹œ - ë°”ë¡œ ì ìš© ì•ˆí•¨)
        function togglePendingFilterValue(columnKey, idx, checked) {
            const value = window._filterValues && window._filterValues[columnKey] ? window._filterValues[columnKey][idx] : null;
            if (value === null) return;

            if (!pendingFilterSelections[columnKey]) {
                pendingFilterSelections[columnKey] = [];
            }

            if (checked) {
                if (!pendingFilterSelections[columnKey].includes(value)) {
                    pendingFilterSelections[columnKey].push(value);
                }
            } else {
                pendingFilterSelections[columnKey] = pendingFilterSelections[columnKey].filter(v => v !== value);
            }
        }
        window.togglePendingFilterValue = togglePendingFilterValue;

        // ì „ì²´ ì„ íƒ
        function selectAllFilterValues(columnKey) {
            const allValues = window._filterValues[columnKey] || [];
            pendingFilterSelections[columnKey] = [...allValues];

            // ì²´í¬ë°•ìŠ¤ UI ì—…ë°ì´íŠ¸
            const filterList = document.getElementById(`filter-list-${columnKey}`);
            if (filterList) {
                filterList.querySelectorAll('input[type="checkbox"]').forEach(cb => {
                    cb.checked = true;
                });
            }
        }
        window.selectAllFilterValues = selectAllFilterValues;

        // ì „ì²´ í•´ì œ
        function deselectAllFilterValues(columnKey) {
            pendingFilterSelections[columnKey] = [];

            // ì²´í¬ë°•ìŠ¤ UI ì—…ë°ì´íŠ¸
            const filterList = document.getElementById(`filter-list-${columnKey}`);
            if (filterList) {
                filterList.querySelectorAll('input[type="checkbox"]').forEach(cb => {
                    cb.checked = false;
                });
            }
        }
        window.deselectAllFilterValues = deselectAllFilterValues;

        // ì¡°íšŒ ë²„íŠ¼ í´ë¦­ ì‹œ í•„í„° ì ìš©
        function applyPendingFilter(columnKey) {
            const allValues = window._filterValues[columnKey] || [];
            const selected = pendingFilterSelections[columnKey] || [];

            // ëª¨ë“  ê°’ì´ ì„ íƒë˜ë©´ í•„í„° í•´ì œ (ì „ì²´ ë³´ê¸°)
            if (selected.length === allValues.length || selected.length === 0) {
                delete confirmedFilters[columnKey];
            } else {
                confirmedFilters[columnKey] = [...selected];
            }

            closeAllFilterDropdowns();
            renderConfirmed();
        }
        window.applyPendingFilter = applyPendingFilter;

        // ì •ë ¬ ì ìš©
        function applySort(columnKey, direction) {
            if (confirmedSort.key === columnKey && confirmedSort.direction === direction) {
                // ê°™ì€ ì •ë ¬ í´ë¦­ ì‹œ í•´ì œ
                confirmedSort = { key: null, direction: null };
            } else {
                confirmedSort = { key: columnKey, direction };
            }
            closeAllFilterDropdowns();
            renderConfirmed();
        }
        window.applySort = applySort;

        // ì»¬ëŸ¼ í•„í„° ì´ˆê¸°í™”
        function clearColumnFilter(columnKey) {
            delete confirmedFilters[columnKey];
            if (confirmedSort.key === columnKey) {
                confirmedSort = { key: null, direction: null };
            }
            closeAllFilterDropdowns();
            renderConfirmed();
        }
        window.clearColumnFilter = clearColumnFilter;

        // ë“œë¡­ë‹¤ìš´ ê²€ìƒ‰
        function filterDropdownSearch(columnKey, searchTerm) {
            const filterList = document.getElementById(`filter-list-${columnKey}`);
            if (!filterList) return;

            const items = filterList.querySelectorAll('.filter-item');
            const term = searchTerm.toLowerCase();

            items.forEach(item => {
                const value = item.dataset.value.toLowerCase();
                item.style.display = value.includes(term) ? '' : 'none';
            });
        }
        window.filterDropdownSearch = filterDropdownSearch;

        // ëª¨ë“  í•„í„° ë“œë¡­ë‹¤ìš´ ë‹«ê¸°
        function closeAllFilterDropdowns() {
            document.querySelectorAll('.filter-dropdown.show').forEach(d => {
                d.classList.remove('show');
            });
            activeFilterDropdown = null;
        }

        // ëª¨ë“  í•„í„°/ì •ë ¬ ì´ˆê¸°í™”
        function resetAllFilters() {
            confirmedFilters = {};
            confirmedSort = { key: null, direction: null };
            closeAllFilterDropdowns();
            renderConfirmed();
        }
        window.resetAllFilters = resetAllFilters;

        // ì„ íƒí•­ëª© ì¶œê³ ìš”ì²­ì¼ ì¼ê´„ ì ìš©
        function applyBatchReleaseDate() {
            const dateInput = document.getElementById('batch-release-date');
            const dateValue = dateInput.value;

            if (!dateValue) {
                alert('ë‚ ì§œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }

            const selectedItems = confirmedData.filter(item => item._selected);

            if (selectedItems.length === 0) {
                alert('ì„ íƒëœ í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤.\nì¶œê³ ìš”ì²­ì¼ì„ ì ìš©í•  í•­ëª©ì„ ë¨¼ì € ì²´í¬í•´ì£¼ì„¸ìš”.');
                return;
            }

            // ì„ íƒëœ í•­ëª©ì— ì¶œê³ ìš”ì²­ì¼ ì ìš©
            selectedItems.forEach(item => {
                item.releaseDate = dateValue;
            });

            saveConfirmedData();
            renderConfirmed();

            showStatus(confirmedStatus, `${selectedItems.length}ê±´ì˜ ì¶œê³ ìš”ì²­ì¼ì´ ${dateValue}ë¡œ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤.`, 'success');
        }
        window.applyBatchReleaseDate = applyBatchReleaseDate;

        // í•„í„° ë²„íŠ¼ í‘œì‹œ/ìˆ¨ê¹€ ì—…ë°ì´íŠ¸
        function updateFilterResetButton() {
            const btn = document.getElementById('btn-reset-filters');
            if (!btn) return;

            const hasActiveFilters = Object.keys(confirmedFilters).some(k => confirmedFilters[k] && confirmedFilters[k].length > 0);
            const hasActiveSort = confirmedSort.key !== null;

            btn.style.display = (hasActiveFilters || hasActiveSort) ? '' : 'none';
        }

        // ë¬¸ì„œ í´ë¦­ ì‹œ ë“œë¡­ë‹¤ìš´ ë‹«ê¸°
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.th-filter') && !e.target.closest('.filter-dropdown')) {
                closeAllFilterDropdowns();
            }
        });

        // ìŠ¤í¬ë¡¤ ì‹œ ë“œë¡­ë‹¤ìš´ ë‹«ê¸°
        document.addEventListener('scroll', () => {
            closeAllFilterDropdowns();
        }, true);

        function handleRowToggle_confirmed(idx) {
            confirmedData[idx]._selected = !confirmedData[idx]._selected;
            updateConfirmedSummary();
            saveConfirmedData();
        }
        window.handleRowToggle_confirmed = handleRowToggle_confirmed;

        function handleCellChange_confirmed(idx, key, value) {
            confirmedData[idx][key] = value;
            saveConfirmedData();
        }
        window.handleCellChange_confirmed = handleCellChange_confirmed;

        // ë¹ ë¥¸ ë§¤ì¹­ ê´€ë ¨
        let quickMatchIndex = -1;

        function openQuickMatchModal(idx) {
            quickMatchIndex = idx;
            const item = confirmedData[idx];
            const modal = document.getElementById('quick-match-modal');

            // ì •ë³´ í‘œì‹œ
            document.getElementById('quick-match-vendor').textContent = item.vendor || '-';
            document.getElementById('quick-match-product-code').textContent = item.productCode || '-';
            document.getElementById('quick-match-product-name').textContent = item.productName || '-';

            // SKU ìƒí’ˆ ì˜µì…˜ ë¡œë“œ
            const select = document.getElementById('quick-match-sku-select');
            select.innerHTML = '<option value="">SKU ìƒí’ˆì„ ì„ íƒí•˜ì„¸ìš”</option>';
            skuProducts.forEach(sku => {
                const cost = calculateProductCost(sku);
                const option = document.createElement('option');
                option.value = sku.id;
                option.textContent = `${sku.skuName} (ì›ê°€: ${cost.toLocaleString()}ì›)`;
                select.appendChild(option);
            });

            // ì´ˆê¸°í™”
            document.getElementById('quick-match-selling-price').value = '';
            document.getElementById('quick-match-save-mapping').checked = true;
            document.getElementById('quick-match-cost-info').style.display = 'none';

            modal.classList.add('show');
        }
        window.openQuickMatchModal = openQuickMatchModal;

        function closeQuickMatchModal() {
            document.getElementById('quick-match-modal').classList.remove('show');
            document.getElementById('quick-sku-add-section').style.display = 'none';
            quickMatchIndex = -1;
        }
        window.closeQuickMatchModal = closeQuickMatchModal;

        // SKU ê°„í¸ë“±ë¡ í† ê¸€
        function toggleQuickSkuAdd() {
            const section = document.getElementById('quick-sku-add-section');
            const isVisible = section.style.display !== 'none';
            section.style.display = isVisible ? 'none' : 'block';

            if (!isVisible) {
                // í˜„ì¬ ìƒí’ˆëª…ì„ SKUëª… ê¸°ë³¸ê°’ìœ¼ë¡œ ì„¤ì •
                const productName = document.getElementById('quick-match-product-name').textContent;
                document.getElementById('quick-sku-name').value = productName !== '-' ? productName : '';

                // í¬ì¥ë°©ë²• ì˜µì…˜ - ì›ê°€ê´€ë¦¬ ë°ì´í„°ì—ì„œ ë¡œë“œ
                const packagingSelect = document.getElementById('quick-sku-packaging');
                packagingSelect.innerHTML = '<option value="">ì„ íƒì•ˆí•¨</option>';
                Object.entries(packagingData).sort((a, b) => a[0].localeCompare(b[0], 'ko')).forEach(([name, price]) => {
                    const option = document.createElement('option');
                    option.value = name;
                    option.textContent = `${name} (${price.toLocaleString()}ì›)`;
                    packagingSelect.appendChild(option);
                });

                // êµ¬ì„±í’ˆ ë¦¬ìŠ¤íŠ¸ ì´ˆê¸°í™”í•˜ê³  ì²« ë²ˆì§¸ í–‰ ì¶”ê°€
                const compositionList = document.getElementById('quick-sku-composition-list');
                compositionList.innerHTML = '';
                addQuickSkuCompositionRow();

                document.getElementById('quick-sku-name').focus();
            }
        }

        // SKU ê°„í¸ë“±ë¡ - êµ¬ì„±í’ˆ í–‰ ì¶”ê°€
        function addQuickSkuCompositionRow() {
            const container = document.getElementById('quick-sku-composition-list');
            const row = document.createElement('div');
            row.className = 'quick-sku-comp-row';
            row.style.cssText = 'display: flex; gap: 6px; align-items: center;';

            // ë¶€ìœ„/í’ˆëª© ì˜µì…˜ ìƒì„±
            let partOptions = '<option value="">ë¶€ìœ„/í’ˆëª©</option>';
            Object.entries(partsData).sort((a, b) => a[0].localeCompare(b[0], 'ko')).forEach(([name, data]) => {
                const price = typeof data === 'number' ? data : data.price;
                const type = typeof data === 'number' ? 'weight' : (data.type || 'weight');
                const unitLabel = type === 'weight' ? 'ì›/100g' : 'ì›/ê°œ';
                partOptions += `<option value="${escapeHtml(name)}" data-type="${type}">${escapeHtml(name)} (${price.toLocaleString()}${unitLabel})</option>`;
            });

            row.innerHTML = `
                <select class="quick-comp-part" style="flex: 2; padding: 6px; border: 1px solid #ddd; border-radius: 4px;" onchange="updateQuickCompPlaceholder(this)">${partOptions}</select>
                <input type="number" class="quick-comp-weight" placeholder="ì¤‘ëŸ‰(g)/ìˆ˜ëŸ‰" style="flex: 1; width: 70px; padding: 6px; border: 1px solid #ddd; border-radius: 4px;">
                <button type="button" class="btn btn-danger" onclick="this.parentElement.remove()" style="padding: 4px 8px; font-size: 12px;">Ã—</button>
            `;
            container.appendChild(row);
        }
        window.addQuickSkuCompositionRow = addQuickSkuCompositionRow;

        // ë¶€ìœ„ ì„ íƒ ì‹œ placeholder ì—…ë°ì´íŠ¸
        function updateQuickCompPlaceholder(select) {
            const row = select.closest('.quick-sku-comp-row');
            const weightInput = row.querySelector('.quick-comp-weight');
            const selectedOption = select.options[select.selectedIndex];
            const type = selectedOption.dataset.type || 'weight';
            weightInput.placeholder = type === 'weight' ? 'ì¤‘ëŸ‰ (g)' : 'ìˆ˜ëŸ‰ (ê°œ)';
        }
        window.updateQuickCompPlaceholder = updateQuickCompPlaceholder;

        // SKU ê°„í¸ë“±ë¡ ì €ì¥
        function saveQuickSku() {
            const skuName = document.getElementById('quick-sku-name').value.trim();
            const packaging = document.getElementById('quick-sku-packaging').value;

            if (!skuName) {
                alert('SKU ìƒí’ˆëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                document.getElementById('quick-sku-name').focus();
                return;
            }

            // ì¤‘ë³µ ì²´í¬
            const existingSku = skuProducts.find(p => p.skuName === skuName);
            if (existingSku) {
                alert('ì´ë¯¸ ì¡´ì¬í•˜ëŠ” SKU ìƒí’ˆëª…ì…ë‹ˆë‹¤.');
                document.getElementById('quick-sku-name').focus();
                return;
            }

            // êµ¬ì„±í’ˆ ë°°ì—´ ìƒì„± - ëª¨ë“  í–‰ì—ì„œ ìˆ˜ì§‘
            const composition = [];
            document.querySelectorAll('.quick-sku-comp-row').forEach(row => {
                const partName = row.querySelector('.quick-comp-part').value;
                const weightOrQuantity = parseInt(row.querySelector('.quick-comp-weight').value) || 0;

                if (partName && weightOrQuantity > 0 && partsData[partName]) {
                    const partData = partsData[partName];
                    const type = typeof partData === 'number' ? 'weight' : (partData.type || 'weight');
                    composition.push({
                        part: partName,
                        weight: type === 'weight' ? weightOrQuantity : 0,
                        quantity: type === 'count' ? weightOrQuantity : 1
                    });
                }
            });

            // ìƒˆ SKU ìƒí’ˆ ìƒì„±
            const newSku = {
                id: generateId(),
                skuName: skuName,
                packaging: packaging,
                sellingPrice: 0,
                composition: composition
            };

            // SKU ìƒí’ˆ ëª©ë¡ì— ì¶”ê°€
            skuProducts.push(newSku);
            saveSkuProducts();

            // ìƒˆ SKUì˜ ì›ê°€ ê³„ì‚°
            let skuCost = 0;
            // í¬ì¥ë¹„
            if (packaging && packagingData[packaging]) {
                skuCost += packagingData[packaging];
            }
            // êµ¬ì„±í’ˆ ì›ê°€
            composition.forEach(comp => {
                if (partsData[comp.part]) {
                    const partData = partsData[comp.part];
                    const price = typeof partData === 'number' ? partData : partData.price;
                    const type = typeof partData === 'number' ? 'weight' : (partData.type || 'weight');
                    if (type === 'weight' && comp.weight > 0) {
                        skuCost += (price / 100) * comp.weight * (comp.quantity || 1);
                    } else if (type === 'count') {
                        skuCost += price * (comp.quantity || 1);
                    }
                }
            });

            // SKU ì„ íƒ ë“œë¡­ë‹¤ìš´ì— ì¶”ê°€í•˜ê³  ì„ íƒ
            const select = document.getElementById('quick-match-sku-select');
            const option = document.createElement('option');
            option.value = newSku.id;
            option.textContent = `${newSku.skuName} (ì›ê°€: ${Math.round(skuCost).toLocaleString()}ì›)`;
            select.appendChild(option);
            select.value = newSku.id;

            // ê°„í¸ë“±ë¡ ì„¹ì…˜ ìˆ¨ê¸°ê¸°
            document.getElementById('quick-sku-add-section').style.display = 'none';

            // ì†ìµ ì •ë³´ ì—…ë°ì´íŠ¸
            updateQuickMatchInfo(false);

            // ì„¤ì • í˜ì´ì§€ SKU ëª©ë¡ë„ ê°±ì‹ 
            renderSkuProductsTable();
        }

        // SKU ê°„í¸ë“±ë¡ ì·¨ì†Œ
        function cancelQuickSkuAdd() {
            document.getElementById('quick-sku-add-section').style.display = 'none';
        }

        function updateQuickMatchInfo(autoFillPrice = false) {
            const skuId = document.getElementById('quick-match-sku-select').value;
            const costInfoBox = document.getElementById('quick-match-cost-info');
            const sellingPriceInput = document.getElementById('quick-match-selling-price');

            if (!skuId) {
                costInfoBox.style.display = 'none';
                return;
            }

            const sku = skuProducts.find(p => p.id === skuId);
            if (!sku) {
                costInfoBox.style.display = 'none';
                return;
            }

            // SKU ì„ íƒ ì‹œ ê¸°ì¡´ ë§¤ì¹­ ì •ë³´ì—ì„œ íŒë§¤ê°€ ìë™ ë¡œë“œ
            if (autoFillPrice && quickMatchIndex >= 0) {
                const item = confirmedData[quickMatchIndex];
                if (item.vendor && item.productCode && vendorMappings[item.vendor]) {
                    const existingMapping = vendorMappings[item.vendor].find(
                        m => m.productCode === item.productCode && m.skuProductId === skuId
                    );
                    if (existingMapping && existingMapping.sellingPrice) {
                        sellingPriceInput.value = existingMapping.sellingPrice;
                    }
                }
            }

            const sellingPrice = parseInt(sellingPriceInput.value) || 0;
            const cost = calculateProductCost(sku);
            const profit = sellingPrice - cost;

            document.getElementById('quick-match-cost').textContent = cost.toLocaleString() + 'ì›';
            document.getElementById('quick-match-selling').textContent = sellingPrice.toLocaleString() + 'ì›';
            document.getElementById('quick-match-profit').textContent = profit.toLocaleString() + 'ì›';
            document.getElementById('quick-match-profit').style.color = profit >= 0 ? 'green' : 'red';

            costInfoBox.style.display = 'block';
        }
        window.updateQuickMatchInfo = updateQuickMatchInfo;

        function handleQuickMatch() {
            const skuId = document.getElementById('quick-match-sku-select').value;
            const sellingPrice = parseInt(document.getElementById('quick-match-selling-price').value) || 0;
            const saveMapping = document.getElementById('quick-match-save-mapping').checked;

            if (!skuId) {
                alert('SKU ìƒí’ˆì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }

            const sku = skuProducts.find(p => p.id === skuId);
            if (!sku) {
                alert('SKU ìƒí’ˆì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            const item = confirmedData[quickMatchIndex];

            // í˜„ì¬ í•­ëª©ì— SKU ì ìš©
            item.skuName = sku.skuName;
            item._skuMatched = true;
            item._skuProductId = skuId;  // SKU ID ì €ì¥ (í¬ì¥&êµ¬ì„± í‘œì‹œìš©)

            // ê±°ë˜ì²˜ë³„ ìƒí’ˆê´€ë¦¬ì— ì €ì¥
            if (saveMapping && item.vendor && item.productCode) {
                if (!vendorMappings[item.vendor]) {
                    vendorMappings[item.vendor] = [];
                }

                // ê¸°ì¡´ ë§¤ì¹­ì´ ìˆëŠ”ì§€ í™•ì¸
                const existingIdx = vendorMappings[item.vendor].findIndex(
                    m => m.productCode === item.productCode
                );

                if (existingIdx >= 0) {
                    vendorMappings[item.vendor][existingIdx] = {
                        productCode: item.productCode,
                        skuProductId: skuId,
                        sellingPrice
                    };
                } else {
                    vendorMappings[item.vendor].push({
                        productCode: item.productCode,
                        skuProductId: skuId,
                        sellingPrice
                    });
                }

                saveVendorMappings();

                // ê°™ì€ ë°œì£¼ì²˜, ê°™ì€ ìƒí’ˆì½”ë“œë¥¼ ê°€ì§„ ë‹¤ë¥¸ ë¯¸ë§¤ì¹­ í•­ëª©ë„ ìë™ ë§¤ì¹­
                confirmedData.forEach((dataItem, idx) => {
                    if (idx !== quickMatchIndex &&
                        dataItem.vendor === item.vendor &&
                        dataItem.productCode === item.productCode &&
                        !dataItem._skuMatched) {
                        dataItem.skuName = sku.skuName;
                        dataItem._skuMatched = true;
                        dataItem._skuProductId = skuId;  // SKU ID ì €ì¥ (í¬ì¥&êµ¬ì„± í‘œì‹œìš©)
                    }
                });
            }

            saveConfirmedData();
            renderConfirmed();
            closeQuickMatchModal();

            showStatus(confirmedStatus, `'${sku.skuName}'ìœ¼ë¡œ ë§¤ì¹­ë˜ì—ˆìŠµë‹ˆë‹¤.`, 'success');
        }
        window.handleQuickMatch = handleQuickMatch;

        function handleConfirmedToggleAll(selected) {
            // í•„í„°ê°€ ì ìš©ëœ ê²½ìš°, í•„í„°ëœ í•­ëª©ë§Œ ì„ íƒ/í•´ì œ
            const filteredData = getFilteredConfirmedData();
            const filteredSet = new Set(filteredData);

            confirmedData.forEach(item => {
                if (filteredSet.has(item)) {
                    item._selected = selected;
                }
            });

            document.querySelectorAll('#confirmed-table input[type="checkbox"]').forEach(cb => {
                cb.checked = selected;
            });
            renderConfirmed();
            saveConfirmedData();
        }

        function updateConfirmedSummary() {
            const selectedCount = confirmedData.filter(item => item._selected).length;
            const summaryItems = confirmedSummary.querySelectorAll('.summary-item');
            if (summaryItems.length >= 2) {
                summaryItems[1].querySelector('.number').textContent = selectedCount;
            }
        }

        function updateConfirmedBadge() {
            const badge = document.getElementById(`badge-confirmed-${currentUser}`);
            if (!badge) return;

            if (confirmedData.length > 0) {
                badge.textContent = confirmedData.length;
                badge.style.display = 'inline';
            } else {
                badge.style.display = 'none';
            }
        }

        function handleRemoveSelected() {
            const selectedCount = confirmedData.filter(item => item._selected).length;

            if (selectedCount === 0) {
                showStatus(confirmedStatus, 'ì‚­ì œí•  í•­ëª©ì„ ì„ íƒí•´ì£¼ì„¸ìš”.', 'error');
                return;
            }

            if (!confirm(`ì„ íƒí•œ ${selectedCount}ê±´ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                return;
            }

            confirmedData = confirmedData.filter(item => !item._selected);
            renderConfirmed();
            saveConfirmedData();

            showStatus(confirmedStatus, `${selectedCount}ê±´ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.`, 'success');
        }

        function handleClearAll() {
            if (confirmedData.length === 0) {
                showStatus(confirmedStatus, 'ì‚­ì œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.', 'error');
                return;
            }

            if (!confirm(`ì „ì²´ ${confirmedData.length}ê±´ì„ ëª¨ë‘ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                return;
            }

            confirmedData = [];
            renderConfirmed();
            saveConfirmedData();

            showStatus(confirmedStatus, 'ì „ì²´ ë°ì´í„°ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
        }

        function handleDownload() {
            const selectedData = confirmedData.filter(item => item._selected);

            if (selectedData.length === 0) {
                showStatus(confirmedStatus, 'ë‹¤ìš´ë¡œë“œí•  ë°ì´í„°ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.', 'error');
                return;
            }

            const exportData = selectedData.map(item => {
                const row = {};
                for (const col of TARGET_COLUMNS) {
                    row[col.name] = item[col.key] || '';
                }
                return row;
            });

            const ws = XLSX.utils.json_to_sheet(exportData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'ì£¼ë¬¸ë°ì´í„°');

            const filename = `ì£¼ë¬¸ê´€ë¦¬_í™•ì •_${formatDate(new Date())}.xlsx`;
            XLSX.writeFile(wb, filename);

            showStatus(confirmedStatus, `${selectedData.length}ê±´ì˜ ë°ì´í„°ë¥¼ ë‹¤ìš´ë¡œë“œí–ˆìŠµë‹ˆë‹¤.`, 'success');
        }

        function formatDate(date) {
            return `${date.getFullYear()}${String(date.getMonth()+1).padStart(2,'0')}${String(date.getDate()).padStart(2,'0')}`;
        }

        // í•©í¬ì¥ ì²˜ë¦¬ í•¨ìˆ˜
        // í¬ì¥ë°©ë²•ì´ "ë‹¨í’ˆ" ë˜ëŠ” "ì´ë™ê°ˆë¹„"ì´ê³  ìˆ˜ëŸ‰ì´ 2ê°œ ì´ìƒì¸ ê²½ìš°
        // ìƒí’ˆëª…ì„ "{ìƒí’ˆëª…} - {ìˆ˜ëŸ‰}ê°œ"ë¡œ, ìˆ˜ëŸ‰ì„ 1ë¡œ ë³€í™˜
        function applyBundlePackaging(data) {
            const BUNDLE_PACKAGING_TYPES = ['ë‹¨í’ˆ', 'ì´ë™ê°ˆë¹„'];

            return data.map(item => {
                // SKUì—ì„œ í¬ì¥ë°©ë²• ê°€ì ¸ì˜¤ê¸°
                let sku = null;
                if (item._skuProductId) {
                    sku = skuProducts.find(p => p.id === item._skuProductId);
                }
                if (!sku && item.skuName) {
                    sku = skuProducts.find(p => p.skuName === item.skuName);
                }

                const packagingMethod = sku ? sku.packaging : '';
                const quantity = parseInt(item.quantity) || 1;

                // í•©í¬ì¥ ëŒ€ìƒ: í¬ì¥ë°©ë²•ì´ ë‹¨í’ˆ/ì´ë™ê°ˆë¹„ & ìˆ˜ëŸ‰ 2ê°œ ì´ìƒ
                if (BUNDLE_PACKAGING_TYPES.includes(packagingMethod) && quantity >= 2) {
                    return {
                        ...item,
                        skuName: `${item.skuName} - ${quantity}ê°œ`,
                        quantity: 1,
                        _originalQuantity: quantity  // ì›ë³¸ ìˆ˜ëŸ‰ ë³´ê´€
                    };
                }

                return { ...item };
            });
        }

        function handleRegisterInvoice() {
            let selectedData = confirmedData.filter(item => item._selected);

            if (selectedData.length === 0) {
                showStatus(confirmedStatus, 'ì†¡ì¥ ë“±ë¡í•  ë°ì´í„°ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.', 'error');
                return;
            }

            // ì¤‘ë³µ ì²´í¬: ê¸°ì¡´ ì „ì²´ì£¼ë¬¸ê´€ë¦¬ ë°ì´í„°ì™€ ë¹„êµ
            const duplicates = [];
            const nonDuplicates = [];

            selectedData.forEach(item => {
                // ì£¼ë¬¸ë²ˆí˜¸ + ìˆ˜ë ¹ì¸ + ìˆ˜ë ¹ì¸ì—°ë½ì²˜ ì¡°í•©ìœ¼ë¡œ ì¤‘ë³µ ì²´í¬
                const isDuplicate = orderManagementData.some(existing => {
                    const sameOrderNo = item.orderNo && existing.orderNo && item.orderNo === existing.orderNo;
                    const sameReceiver = item.receiverName === existing.receiverName &&
                                         item.receiverPhone === existing.receiverPhone;
                    const sameProduct = (item.productName === existing.productName || item.skuName === existing.skuName);

                    // ì£¼ë¬¸ë²ˆí˜¸ê°€ ìˆìœ¼ë©´ ì£¼ë¬¸ë²ˆí˜¸ + ìˆ˜ë ¹ì¸ìœ¼ë¡œ ì²´í¬, ì—†ìœ¼ë©´ ìˆ˜ë ¹ì¸ + ìƒí’ˆëª…ìœ¼ë¡œ ì²´í¬
                    if (item.orderNo) {
                        return sameOrderNo && sameReceiver;
                    } else {
                        return sameReceiver && sameProduct;
                    }
                });

                if (isDuplicate) {
                    duplicates.push(item);
                } else {
                    nonDuplicates.push(item);
                }
            });

            // ì¤‘ë³µ í•­ëª©ì´ ìˆìœ¼ë©´ ê²½ê³ 
            if (duplicates.length > 0) {
                const message = `ì´ë¯¸ ë“±ë¡ëœ ì¤‘ë³µ ë°ì´í„°ê°€ ${duplicates.length}ê±´ ìˆìŠµë‹ˆë‹¤.\n\n` +
                    `- ì „ì²´ ì„ íƒ: ${selectedData.length}ê±´\n` +
                    `- ì¤‘ë³µ ë°ì´í„°: ${duplicates.length}ê±´\n` +
                    `- ì‹ ê·œ ë°ì´í„°: ${nonDuplicates.length}ê±´\n\n` +
                    `ì¤‘ë³µ ë°ì´í„°ë¥¼ ì œì™¸í•˜ê³  ì‹ ê·œ ë°ì´í„°ë§Œ ë“±ë¡í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n` +
                    `(ì·¨ì†Œ ì‹œ ì „ì²´ ì‘ì—…ì´ ì·¨ì†Œë©ë‹ˆë‹¤)`;

                if (!confirm(message)) {
                    return;
                }

                // ì¤‘ë³µ ì œì™¸í•˜ê³  ì§„í–‰
                if (nonDuplicates.length === 0) {
                    showStatus(confirmedStatus, 'ëª¨ë“  ë°ì´í„°ê°€ ì¤‘ë³µì…ë‹ˆë‹¤. ë“±ë¡í•  ì‹ ê·œ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.', 'warning');
                    return;
                }

                selectedData = nonDuplicates;
            }

            // ì„ íƒëœ í•­ëª©ì„ ì „ì²´ì£¼ë¬¸ê´€ë¦¬ë¡œ ì´ë™
            const today = formatDateKey(new Date());

            // ì¶œê³ ìš”ì²­ì¼ ë¯¸ì§€ì • í•­ëª© í™•ì¸
            const noReleaseDateItems = selectedData.filter(item => !item.releaseDate || item.releaseDate === '');
            if (noReleaseDateItems.length > 0) {
                const confirmed = confirm(`ì¶œê³ ìš”ì²­ì¼ì´ ì§€ì •ë˜ì§€ ì•Šì€ ì£¼ë¬¸ì´ ${noReleaseDateItems.length}ê±´ ìˆìŠµë‹ˆë‹¤.\ní•´ë‹¹ ì£¼ë¬¸ì€ ì¶œê³ ìš”ì²­ì¼ì´ "${today}"ë¡œ í‘œê¸°ë©ë‹ˆë‹¤.\n\nê³„ì† ì§„í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`);
                if (!confirmed) {
                    return;
                }
            }

            // í•©í¬ì¥ ì²˜ë¦¬ ì ìš©ëœ ë°ì´í„° ìƒì„±
            const processedData = applyBundlePackaging(selectedData);

            // Bíƒ€ì… ì–‘ì‹ ì—‘ì…€ ë‹¤ìš´ë¡œë“œ
            downloadLogenExcel(processedData);

            const itemsToMove = processedData.map(item => ({
                ...item,
                registeredDate: today,
                // ì¶œê³ ìš”ì²­ì¼ì´ ì—†ìœ¼ë©´ ì˜¤ëŠ˜ ë‚ ì§œë¡œ í‘œê¸°
                releaseDate: item.releaseDate || today,
                _shipped: false,
                _paid: false,
                _invoiceIssued: false,
                _selected: false
            }));

            // ì „ì²´ì£¼ë¬¸ê´€ë¦¬ì— ì¶”ê°€
            orderManagementData = [...orderManagementData, ...itemsToMove];
            saveOrderManagementData();
            renderOrderManagement();

            // ë³€í™˜í™•ì •ì—ì„œ ì‚­ì œ (ì‹¤ì œë¡œ ì²˜ë¦¬ëœ í•­ëª©ë§Œ ì‚­ì œ)
            const processedIds = new Set(selectedData.map(item =>
                `${item.orderNo || ''}_${item.receiverName || ''}_${item.receiverPhone || ''}_${item.productName || ''}`
            ));
            confirmedData = confirmedData.filter(item => {
                const itemId = `${item.orderNo || ''}_${item.receiverName || ''}_${item.receiverPhone || ''}_${item.productName || ''}`;
                return !processedIds.has(itemId);
            });
            saveConfirmedData();
            renderConfirmed();

            showStatus(confirmedStatus, `${selectedData.length}ê±´ì´ Bíƒ€ì… ì–‘ì‹ìœ¼ë¡œ ë‹¤ìš´ë¡œë“œë˜ê³  ì „ì²´ì£¼ë¬¸ê´€ë¦¬ë¡œ ì´ë™ë˜ì—ˆìŠµë‹ˆë‹¤.`, 'success');

            // ì „ì²´ì£¼ë¬¸ê´€ë¦¬ í˜ì´ì§€ë¡œ ì´ë™
            setTimeout(() => {
                document.querySelectorAll('.menu-item').forEach(item => item.classList.remove('active'));
                document.querySelector('[data-page="order-management"]').classList.add('active');
                document.querySelectorAll('.page-content').forEach(page => page.classList.remove('active'));
                document.getElementById('order-management').classList.add('active');
            }, 1500);
        }

        // Bíƒ€ì… ì–‘ì‹ ì—‘ì…€ ë‹¤ìš´ë¡œë“œ
        function downloadLogenExcel(data) {
            // Bíƒ€ì… ì–‘ì‹ í—¤ë”
            const logenHeaders = [
                'SKUìƒí’ˆëª…', 'ìˆ˜ëŸ‰', 'ìˆ˜ë ¹ì¸', 'ìˆ˜ë ¹ì¸ì—°ë½ì²˜', 'ìˆ˜ë ¹ì¸ì£¼ì†Œ',
                'ë°°ì†¡ë©”ëª¨', 'ì£¼ë¬¸ë²ˆí˜¸', 'ë°œì†¡ì¸', 'ë°œì†¡ì¸ì—°ë½ì²˜', 'ë°œì†¡ì¸ì£¼ì†Œ', 'ë°°ì†¡ë²ˆí˜¸'
            ];

            const logenData = data.map(item => [
                item.skuName || item.productName || '',
                item.quantity || 1,
                item.receiverName || '',
                item.receiverPhone || '',
                item.receiverAddr || '',
                item.memo || '',
                item.orderNo || '',
                item.senderName || '',      // ë°œì†¡ì¸
                item.senderPhone || '',     // ë°œì†¡ì¸ì—°ë½ì²˜
                item.senderAddr || '',      // ë°œì†¡ì¸ì£¼ì†Œ
                item.deliveryNo || ''       // ë°°ì†¡ë²ˆí˜¸
            ]);

            const wsData = [logenHeaders, ...logenData];
            const ws = XLSX.utils.aoa_to_sheet(wsData);

            // ì»¬ëŸ¼ ë„ˆë¹„ ì„¤ì •
            ws['!cols'] = [
                { wch: 30 },  // SKUìƒí’ˆëª…
                { wch: 8 },   // ìˆ˜ëŸ‰
                { wch: 12 },  // ìˆ˜ë ¹ì¸
                { wch: 15 },  // ìˆ˜ë ¹ì¸ì—°ë½ì²˜
                { wch: 50 },  // ìˆ˜ë ¹ì¸ì£¼ì†Œ
                { wch: 25 },  // ë°°ì†¡ë©”ëª¨
                { wch: 20 },  // ì£¼ë¬¸ë²ˆí˜¸
                { wch: 12 },  // ë°œì†¡ì¸
                { wch: 15 },  // ë°œì†¡ì¸ì—°ë½ì²˜
                { wch: 40 },  // ë°œì†¡ì¸ì£¼ì†Œ
                { wch: 15 }   // ë°°ì†¡ë²ˆí˜¸
            ];

            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Bíƒ€ì…');

            const fileName = `Bíƒ€ì…_${formatDate(new Date())}_${data.length}ê±´.xlsx`;
            XLSX.writeFile(wb, fileName);
        }

        // ==================== ì›ê°€ê´€ë¦¬ ====================
        function handleAddPart() {
            const name = document.getElementById('part-name').value.trim();
            const type = document.getElementById('part-type').value;
            const price = parseInt(document.getElementById('part-price').value);

            if (!name) {
                showStatus(document.getElementById('cost-status'), 'í’ˆëª©ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }

            if (!price || price <= 0) {
                showStatus(document.getElementById('cost-status'), 'ë‹¨ê°€ë¥¼ ì˜¬ë°”ë¥´ê²Œ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }

            partsData[name] = { price: price, type: type };
            saveCostData();
            renderPartsTable();

            document.getElementById('part-name').value = '';
            document.getElementById('part-type').value = 'weight';
            document.getElementById('part-price').value = '';

            showStatus(document.getElementById('cost-status'), `'${name}' í’ˆëª©ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.`, 'success');
        }

        function handleAddPackaging() {
            const name = document.getElementById('packaging-name').value.trim();
            const price = parseInt(document.getElementById('packaging-price').value);

            if (!name) {
                showStatus(document.getElementById('cost-status'), 'í¬ì¥ë°©ë²•ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }

            if (price === undefined || price < 0) {
                showStatus(document.getElementById('cost-status'), 'í¬ì¥ë¹„ë¥¼ ì˜¬ë°”ë¥´ê²Œ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }

            packagingData[name] = price;
            saveCostData();
            renderPackagingTable();

            document.getElementById('packaging-name').value = '';
            document.getElementById('packaging-price').value = '';

            showStatus(document.getElementById('cost-status'), `'${name}' í¬ì¥ë°©ë²•ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.`, 'success');
        }

        function renderPartsTable() {
            const tbody = document.querySelector('#parts-table tbody');
            tbody.innerHTML = '';

            // í’ˆëª©ëª… ê¸°ì¤€ ì˜¤ë¦„ì°¨ìˆœ ì •ë ¬
            const sortedParts = Object.entries(partsData).sort((a, b) => a[0].localeCompare(b[0], 'ko'));

            sortedParts.forEach(([name, data]) => {
                // ê¸°ì¡´ ë°ì´í„° í˜¸í™˜ì„± (ìˆ«ìë§Œ ì €ì¥ëœ ê²½ìš°)
                const price = typeof data === 'number' ? data : data.price;
                const type = typeof data === 'number' ? 'weight' : (data.type || 'weight');
                const typeLabel = type === 'weight' ? '100gë‹¹' : '1ê°œë‹¹';

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${escapeHtml(name)}</td>
                    <td><span class="unit-badge unit-${type}">${typeLabel}</span></td>
                    <td>${price.toLocaleString()}ì›</td>
                    <td>
                        <button class="btn btn-secondary btn-small" onclick="editPart('${escapeHtml(name)}')">ìˆ˜ì •</button>
                        <button class="btn btn-danger btn-small" onclick="deletePart('${escapeHtml(name)}')">ì‚­ì œ</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });

            if (Object.keys(partsData).length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; color: #999;">ë“±ë¡ëœ í’ˆëª©ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
            }
        }

        function renderPackagingTable() {
            const tbody = document.querySelector('#packaging-table tbody');
            tbody.innerHTML = '';

            // í¬ì¥ë°©ë²•ëª… ê¸°ì¤€ ì˜¤ë¦„ì°¨ìˆœ ì •ë ¬
            const sortedPackaging = Object.entries(packagingData).sort((a, b) => a[0].localeCompare(b[0], 'ko'));

            sortedPackaging.forEach(([name, price]) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${escapeHtml(name)}</td>
                    <td>${price.toLocaleString()}ì›</td>
                    <td>
                        <button class="btn btn-secondary btn-small" onclick="editPackaging('${escapeHtml(name)}')">ìˆ˜ì •</button>
                        <button class="btn btn-danger btn-small" onclick="deletePackaging('${escapeHtml(name)}')">ì‚­ì œ</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });

            if (Object.keys(packagingData).length === 0) {
                tbody.innerHTML = '<tr><td colspan="3" style="text-align: center; color: #999;">ë“±ë¡ëœ í¬ì¥ë°©ë²•ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
            }
        }

        function editPart(name) {
            const data = partsData[name];
            // ê¸°ì¡´ ë°ì´í„° í˜¸í™˜ì„±
            const currentPrice = typeof data === 'number' ? data : data.price;
            const currentType = typeof data === 'number' ? 'weight' : (data.type || 'weight');

            const newName = prompt('í’ˆëª©ëª…ì„ ì…ë ¥í•˜ì„¸ìš”:', name);
            if (newName === null) return;
            if (!newName.trim()) {
                alert('í’ˆëª©ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            const typeLabel = currentType === 'weight' ? 'ì¤‘ëŸ‰(100gë‹¹)' : 'ê°œìˆ˜(1ê°œë‹¹)';
            const changeType = confirm(`í˜„ì¬ ë‹¨ìœ„: ${typeLabel}\n\në‹¨ìœ„ë¥¼ ë³€ê²½í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n[í™•ì¸] = ë³€ê²½ / [ì·¨ì†Œ] = ìœ ì§€`);
            const newType = changeType ? (currentType === 'weight' ? 'unit' : 'weight') : currentType;
            const priceLabel = newType === 'weight' ? '100gë‹¹' : '1ê°œë‹¹';

            const newPrice = prompt(`${priceLabel} ë‹¨ê°€ë¥¼ ì…ë ¥í•˜ì„¸ìš”:`, currentPrice);
            if (newPrice === null) return;
            const priceNum = parseInt(newPrice);
            if (isNaN(priceNum) || priceNum < 0) {
                alert('ì˜¬ë°”ë¥¸ ë‹¨ê°€ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            // ì´ë¦„ì´ ë³€ê²½ëœ ê²½ìš° ê¸°ì¡´ í•­ëª© ì‚­ì œ
            if (newName.trim() !== name) {
                if (partsData[newName.trim()]) {
                    alert('ì´ë¯¸ ì¡´ì¬í•˜ëŠ” í’ˆëª©ëª…ì…ë‹ˆë‹¤.');
                    return;
                }
                delete partsData[name];
            }

            partsData[newName.trim()] = { price: priceNum, type: newType };
            saveCostData();
            renderPartsTable();
            renderSkuProductsTable();
            showStatus(document.getElementById('cost-status'), `'${newName.trim()}' í’ˆëª©ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.`, 'success');
        }
        window.editPart = editPart;

        function deletePart(name) {
            if (!confirm(`'${name}' í’ˆëª©ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
            delete partsData[name];
            saveCostData();
            renderPartsTable();
            renderSkuProductsTable();
            showStatus(document.getElementById('cost-status'), `'${name}' í’ˆëª©ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.`, 'success');
        }
        window.deletePart = deletePart;

        function editPackaging(name) {
            const currentPrice = packagingData[name];

            const newName = prompt('í¬ì¥ë°©ë²•ëª…ì„ ì…ë ¥í•˜ì„¸ìš”:', name);
            if (newName === null) return;
            if (!newName.trim()) {
                alert('í¬ì¥ë°©ë²•ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            const newPrice = prompt('í¬ì¥ ë¹„ìš©ì„ ì…ë ¥í•˜ì„¸ìš”:', currentPrice);
            if (newPrice === null) return;
            const priceNum = parseInt(newPrice);
            if (isNaN(priceNum) || priceNum < 0) {
                alert('ì˜¬ë°”ë¥¸ ê°€ê²©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            // ì´ë¦„ì´ ë³€ê²½ëœ ê²½ìš° ê¸°ì¡´ í•­ëª© ì‚­ì œ
            if (newName.trim() !== name) {
                if (packagingData[newName.trim()]) {
                    alert('ì´ë¯¸ ì¡´ì¬í•˜ëŠ” í¬ì¥ë°©ë²•ëª…ì…ë‹ˆë‹¤.');
                    return;
                }
                delete packagingData[name];
            }

            packagingData[newName.trim()] = priceNum;
            saveCostData();
            renderPackagingTable();
            renderSkuProductsTable();
            showStatus(document.getElementById('cost-status'), `'${newName.trim()}' í¬ì¥ë°©ë²•ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.`, 'success');
        }
        window.editPackaging = editPackaging;

        function deletePackaging(name) {
            if (!confirm(`'${name}' í¬ì¥ë°©ë²•ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
            delete packagingData[name];
            saveCostData();
            renderPackagingTable();
            renderSkuProductsTable();
            showStatus(document.getElementById('cost-status'), `'${name}' í¬ì¥ë°©ë²•ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.`, 'success');
        }
        window.deletePackaging = deletePackaging;

        // ==================== ê±°ë˜ì²˜ ê´€ë¦¬ ====================

        // Firebase í‚¤ì— ì‚¬ìš©í•  ìˆ˜ ì—†ëŠ” ë¬¸ì ê²€ì‚¬
        function hasInvalidFirebaseKeyChars(str) {
            const invalidChars = /[.#$/\[\]]/;
            return invalidChars.test(str);
        }

        function getInvalidFirebaseKeyCharsMessage() {
            return 'ë°œì£¼ì²˜ ì´ë¦„ì— ë‹¤ìŒ ë¬¸ìëŠ” ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤: . # $ / [ ]';
        }

        function handleAddVendor() {
            const name = document.getElementById('new-vendor-name').value.trim();
            if (!name) {
                showStatus(document.getElementById('mapping-status'), 'ë°œì£¼ì²˜ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }

            if (hasInvalidFirebaseKeyChars(name)) {
                showStatus(document.getElementById('mapping-status'), getInvalidFirebaseKeyCharsMessage(), 'error');
                return;
            }

            if (vendorMappings[name]) {
                showStatus(document.getElementById('mapping-status'), 'ì´ë¯¸ ë“±ë¡ëœ ë°œì£¼ì²˜ì…ë‹ˆë‹¤.', 'error');
                return;
            }

            vendorMappings[name] = [];
            saveVendorMappings();
            renderVendorList();
            document.getElementById('new-vendor-name').value = '';

            showStatus(document.getElementById('mapping-status'), `'${name}' ë°œì£¼ì²˜ê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.`, 'success');
        }

        function editVendorName(oldName) {
            const newName = prompt('ìƒˆ ë°œì£¼ì²˜ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”:', oldName);
            if (!newName || newName.trim() === '') return;
            if (newName.trim() === oldName) return;

            const trimmedName = newName.trim();

            // Firebase í‚¤ ìœ íš¨ì„± ê²€ì‚¬
            if (hasInvalidFirebaseKeyChars(trimmedName)) {
                alert(getInvalidFirebaseKeyCharsMessage());
                return;
            }

            if (vendorMappings[trimmedName]) {
                alert('ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ë°œì£¼ì²˜ ì´ë¦„ì…ë‹ˆë‹¤.');
                return;
            }

            // ë§¤ì¹­ ë°ì´í„° ì´ë™
            vendorMappings[trimmedName] = vendorMappings[oldName];
            delete vendorMappings[oldName];

            // ë³€í™˜í™•ì • ë°ì´í„°ì˜ ë°œì£¼ì²˜ëª…ë„ ë³€ê²½
            let updatedCount = 0;
            confirmedData.forEach(item => {
                if (item.vendor === oldName) {
                    item.vendor = trimmedName;
                    updatedCount++;
                }
            });

            // ì„ íƒëœ ë°œì£¼ì²˜ ì—…ë°ì´íŠ¸
            if (selectedVendor === oldName) {
                selectedVendor = trimmedName;
                document.getElementById('selected-vendor-name').textContent = `- ${trimmedName}`;
            }

            saveVendorMappings();
            if (updatedCount > 0) {
                saveConfirmedData();
            }
            renderVendorList();
            updateVendorSelect();

            showStatus(document.getElementById('mapping-status'), `ë°œì£¼ì²˜ ì´ë¦„ì´ '${trimmedName}'(ìœ¼)ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.`, 'success');
        }
        window.editVendorName = editVendorName;

        function deleteVendor(vendorName) {
            const mappingCount = vendorMappings[vendorName] ? vendorMappings[vendorName].length : 0;
            let message = `'${vendorName}' ë°œì£¼ì²˜ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`;
            if (mappingCount > 0) {
                message += `\n(${mappingCount}ê°œì˜ ë§¤ì¹­ ì •ë³´ë„ í•¨ê»˜ ì‚­ì œë©ë‹ˆë‹¤)`;
            }

            if (!confirm(message)) return;

            // ë³€í™˜í™•ì •ì—ì„œ í•´ë‹¹ ë°œì£¼ì²˜ì˜ ë§¤ì¹­ í•´ì œ
            let unmatchedCount = 0;
            if (vendorMappings[vendorName]) {
                const vendorProductCodes = vendorMappings[vendorName].map(m => m.productCode);
                confirmedData.forEach(item => {
                    if (item.vendor === vendorName && item._skuMatched && vendorProductCodes.includes(item.productCode)) {
                        item._skuMatched = false;
                        item.skuName = item.productName;
                        unmatchedCount++;
                    }
                });
            }

            delete vendorMappings[vendorName];

            // ì„ íƒëœ ë°œì£¼ì²˜ê°€ ì‚­ì œëœ ê²½ìš°
            if (selectedVendor === vendorName) {
                selectedVendor = null;
                document.getElementById('mapping-empty-state').style.display = 'block';
                document.getElementById('mapping-content').style.display = 'none';
                document.getElementById('selected-vendor-name').textContent = '';
            }

            saveVendorMappings();
            if (unmatchedCount > 0) {
                saveConfirmedData();
                renderConfirmed();
            }
            renderVendorList();
            updateVendorSelect();

            let statusMsg = `'${vendorName}' ë°œì£¼ì²˜ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.`;
            if (unmatchedCount > 0) {
                statusMsg += ` (ë³€í™˜í™•ì • ${unmatchedCount}ê±´ ë¯¸ë§¤ì¹­ìœ¼ë¡œ ë³€ê²½)`;
            }
            showStatus(document.getElementById('mapping-status'), statusMsg, 'success');
        }
        window.deleteVendor = deleteVendor;

        // ==================== SKU ìƒí’ˆê´€ë¦¬ (skuProducts) ====================
        function renderSkuProductsTable() {
            const container = document.getElementById('sku-products-table');
            const searchTerm = document.getElementById('sku-product-search').value.toLowerCase();

            // SKUìƒí’ˆëª… ê¸°ì¤€ ì˜¤ë¦„ì°¨ìˆœ ì •ë ¬
            let products = [...skuProducts].sort((a, b) => a.skuName.localeCompare(b.skuName, 'ko'));
            if (searchTerm) {
                products = products.filter(p => p.skuName.toLowerCase().includes(searchTerm));
            }

            if (products.length === 0) {
                container.innerHTML = '<div class="empty-state" style="padding: 40px;"><div class="icon">ğŸ·ï¸</div><div>ë“±ë¡ëœ SKU ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤.</div></div>';
                return;
            }

            let html = `
                <table>
                    <thead>
                        <tr>
                            <th style="width: 40px;">#</th>
                            <th>SKUìƒí’ˆëª…</th>
                            <th>í¬ì¥ë°©ë²•</th>
                            <th>êµ¬ì„±í’ˆ</th>
                            <th>ê³ ê¸°ì›ê°€<br><span style="font-weight: normal; font-size: 11px; color: #888;">(ë¶€ìœ„ì›ê°€)</span></th>
                            <th>ì´ì›ê°€<br><span style="font-weight: normal; font-size: 11px; color: #888;">(ë¶€ìœ„+í¬ì¥)</span></th>
                            <th style="width: 100px;">ê´€ë¦¬</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            products.forEach((product, idx) => {
                const originalIdx = skuProducts.indexOf(product);
                const { meatCost, packagingCost, totalCost } = calculateProductCostDetails(product);
                const compositionText = product.composition && product.composition.length > 0
                    ? product.composition.map(c => {
                        const partData = partsData[c.part];
                        const type = partData ? (typeof partData === 'number' ? 'weight' : (partData.type || 'weight')) : 'weight';
                        const qty = c.quantity || 1;
                        if (type === 'unit') {
                            return `${c.part} ${qty}ê°œ`;
                        } else {
                            return `${c.part} ${c.weight}g` + (qty > 1 ? ` x${qty}` : '');
                        }
                    }).join(', ')
                    : '-';

                html += `
                    <tr>
                        <td class="row-num">${idx + 1}</td>
                        <td><strong>${escapeHtml(product.skuName)}</strong></td>
                        <td>${escapeHtml(product.packaging || '-')}</td>
                        <td style="font-size: 12px; color: #666;">${escapeHtml(compositionText)}</td>
                        <td>${meatCost.toLocaleString()}ì›</td>
                        <td><strong>${totalCost.toLocaleString()}ì›</strong></td>
                        <td>
                            <button class="btn btn-primary btn-small" onclick="openSkuProductModal(${originalIdx})">ìˆ˜ì •</button>
                            <button class="btn btn-danger btn-small" onclick="handleDeleteSkuProduct(${originalIdx})">ì‚­ì œ</button>
                        </td>
                    </tr>
                `;
            });

            html += '</tbody></table>';
            container.innerHTML = html;
        }

        // ==================== ê±°ë˜ì²˜ë³„ ìƒí’ˆê´€ë¦¬ (vendorMappings) ====================
        function renderVendorList() {
            const container = document.getElementById('vendor-list');
            if (!container) return;
            // ê±°ë˜ì²˜ëª… ê¸°ì¤€ ì˜¤ë¦„ì°¨ìˆœ ì •ë ¬
            const vendors = Object.keys(vendorMappings).sort((a, b) => a.localeCompare(b, 'ko'));

            if (vendors.length === 0) {
                container.innerHTML = '<div class="empty-state" style="padding: 20px;"><div>ë“±ë¡ëœ ë°œì£¼ì²˜ê°€ ì—†ìŠµë‹ˆë‹¤.</div></div>';
                return;
            }

            container.innerHTML = vendors.map(vendor => `
                <div class="vendor-list-item ${selectedVendor === vendor ? 'active' : ''}" data-vendor="${escapeHtml(vendor)}">
                    <div class="vendor-info" style="flex: 1;">
                        <div class="vendor-name">${escapeHtml(vendor)}</div>
                        <div class="vendor-count">${vendorMappings[vendor].length}ê°œ ë§¤ì¹­</div>
                    </div>
                    <div class="vendor-actions" style="display: flex; gap: 4px;" onclick="event.stopPropagation();">
                        <button class="btn btn-small" style="padding: 2px 6px; font-size: 11px;" onclick="editVendorName('${escapeHtml(vendor)}')">ìˆ˜ì •</button>
                        <button class="btn btn-danger btn-small" style="padding: 2px 6px; font-size: 11px;" onclick="deleteVendor('${escapeHtml(vendor)}')">ì‚­ì œ</button>
                    </div>
                </div>
            `).join('');

            container.querySelectorAll('.vendor-list-item').forEach(item => {
                item.querySelector('.vendor-info').addEventListener('click', () => selectVendor(item.dataset.vendor));
            });

            // í…œí”Œë¦¿ ë°œì£¼ì²˜ ì…€ë ‰íŠ¸ë„ ì—…ë°ì´íŠ¸
            updateTemplateVendorSelect();
        }

        function selectVendor(vendor) {
            selectedVendor = vendor;
            renderVendorList();

            document.getElementById('mapping-empty-state').style.display = 'none';
            document.getElementById('mapping-content').style.display = 'block';
            document.getElementById('selected-vendor-name').textContent = `- ${vendor}`;

            renderMappingTable();
        }

        function renderMappingTable() {
            if (!selectedVendor || !vendorMappings[selectedVendor]) return;

            const searchTerm = document.getElementById('mapping-search-input').value.toLowerCase();
            // ìƒí’ˆì½”ë“œ ê¸°ì¤€ ì˜¤ë¦„ì°¨ìˆœ ì •ë ¬
            let mappings = [...vendorMappings[selectedVendor]].sort((a, b) => a.productCode.localeCompare(b.productCode, 'ko'));

            if (searchTerm) {
                mappings = mappings.filter(m => {
                    const sku = skuProducts.find(p => p.id === m.skuProductId);
                    return m.productCode.toLowerCase().includes(searchTerm) ||
                           (sku && sku.skuName.toLowerCase().includes(searchTerm));
                });
            }

            const container = document.getElementById('mapping-table');

            if (mappings.length === 0) {
                container.innerHTML = '<div class="empty-state" style="padding: 40px;"><div class="icon">ğŸ”—</div><div>ë“±ë¡ëœ ë§¤ì¹­ì´ ì—†ìŠµë‹ˆë‹¤.</div></div>';
                return;
            }

            let html = `
                <table>
                    <thead>
                        <tr>
                            <th style="width: 40px;">#</th>
                            <th>ìƒí’ˆì½”ë“œ</th>
                            <th>SKUìƒí’ˆëª…</th>
                            <th>ì›ê°€</th>
                            <th>íŒë§¤ê°€</th>
                            <th>ì†ìµ</th>
                            <th style="width: 100px;">ê´€ë¦¬</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            mappings.forEach((mapping, idx) => {
                const originalIdx = vendorMappings[selectedVendor].indexOf(mapping);
                const sku = skuProducts.find(p => p.id === mapping.skuProductId);
                const skuName = sku ? sku.skuName : '(ì‚­ì œëœ ìƒí’ˆ)';
                const cost = sku ? calculateProductCost(sku) : 0;
                const sellingPrice = mapping.sellingPrice || 0;
                const profit = sellingPrice - cost;
                const profitRate = sellingPrice > 0 ? ((profit / sellingPrice) * 100).toFixed(1) : 0;

                html += `
                    <tr>
                        <td class="row-num">${idx + 1}</td>
                        <td><strong>${escapeHtml(mapping.productCode)}</strong></td>
                        <td>${escapeHtml(skuName)}</td>
                        <td>${cost.toLocaleString()}ì›</td>
                        <td>${sellingPrice.toLocaleString()}ì›</td>
                        <td style="color: ${profit >= 0 ? 'green' : 'red'}; font-weight: bold;">${profit.toLocaleString()}ì› (${profitRate}%)</td>
                        <td>
                            <button class="btn btn-primary btn-small" onclick="openMappingModal(${originalIdx})">ìˆ˜ì •</button>
                            <button class="btn btn-danger btn-small" onclick="handleDeleteMapping(${originalIdx})">ì‚­ì œ</button>
                        </td>
                    </tr>
                `;
            });

            html += '</tbody></table>';
            container.innerHTML = html;
        }

        function calculateProductCost(product) {
            const details = calculateProductCostDetails(product);
            return details.totalCost;
        }

        function calculateProductCostDetails(product) {
            let meatCost = 0;
            let packagingCost = 0;

            // í¬ì¥ë¹„
            if (product.packaging && packagingData[product.packaging]) {
                packagingCost = packagingData[product.packaging];
            }

            // êµ¬ì„±í’ˆ ì›ê°€ (ë¶€ìœ„/í’ˆëª© ì›ê°€)
            if (product.composition && product.composition.length > 0) {
                product.composition.forEach(comp => {
                    if (partsData[comp.part]) {
                        const partData = partsData[comp.part];
                        // ê¸°ì¡´ ë°ì´í„° í˜¸í™˜ì„± (ìˆ«ìë§Œ ì €ì¥ëœ ê²½ìš°)
                        const price = typeof partData === 'number' ? partData : partData.price;
                        const type = typeof partData === 'number' ? 'weight' : (partData.type || 'weight');

                        if (type === 'weight') {
                            // ì¤‘ëŸ‰ ê¸°ë°˜: (100gë‹¹ ê°€ê²© / 100) * ì¤‘ëŸ‰(g) * ìˆ˜ëŸ‰
                            const pricePerPiece = (price / 100) * comp.weight;
                            meatCost += pricePerPiece * (comp.quantity || 1);
                        } else {
                            // ê°œìˆ˜ ê¸°ë°˜: ê°œë‹¹ ê°€ê²© * ìˆ˜ëŸ‰ (ì¤‘ëŸ‰ ë¬´ì‹œ)
                            meatCost += price * (comp.quantity || 1);
                        }
                    }
                });
            }

            return {
                meatCost: Math.round(meatCost),
                packagingCost: Math.round(packagingCost),
                totalCost: Math.round(meatCost + packagingCost)
            };
        }

        function openSkuProductModal(idx = -1) {
            editingSkuProductIndex = idx;
            const modal = document.getElementById('sku-product-modal');

            // í¬ì¥ë°©ë²• ì˜µì…˜ ì—…ë°ì´íŠ¸
            updatePackagingSelect();

            if (idx >= 0 && skuProducts[idx]) {
                const sku = skuProducts[idx];
                document.getElementById('sku-product-modal-title').textContent = 'SKU ìƒí’ˆ ìˆ˜ì •';
                document.getElementById('sku-product-name').value = sku.skuName;
                document.getElementById('sku-packaging').value = sku.packaging || '';

                // êµ¬ì„±í’ˆ ë¡œë“œ
                const container = document.getElementById('sku-composition-container');
                container.innerHTML = '';
                if (sku.composition && sku.composition.length > 0) {
                    sku.composition.forEach(comp => {
                        addCompositionItem();
                        const lastItem = container.lastElementChild;
                        const partSelect = lastItem.querySelector('.comp-part');
                        partSelect.value = comp.part;
                        lastItem.querySelector('.comp-weight').value = comp.weight;
                        lastItem.querySelector('.comp-quantity').value = comp.quantity || 1;
                        // ê°œìˆ˜ ê¸°ë°˜ í’ˆëª©ì¸ ê²½ìš° ì¤‘ëŸ‰ í•„ë“œ ì—…ë°ì´íŠ¸
                        updateCompositionWeightLabel(partSelect);
                    });
                }
            } else {
                document.getElementById('sku-product-modal-title').textContent = 'SKU ìƒí’ˆ ì¶”ê°€';
                document.getElementById('sku-product-name').value = '';
                document.getElementById('sku-packaging').value = '';
                document.getElementById('sku-composition-container').innerHTML = '';
            }

            calculateSkuCost();
            modal.classList.add('show');
        }
        window.openSkuProductModal = openSkuProductModal;

        function openMappingModal(idx = -1) {
            editingMappingIndex = idx;
            const modal = document.getElementById('mapping-modal');

            // SKU ìƒí’ˆ ì˜µì…˜ ì—…ë°ì´íŠ¸
            const select = document.getElementById('mapping-sku-select');
            select.innerHTML = '<option value="">SKU ìƒí’ˆì„ ì„ íƒí•˜ì„¸ìš”</option>';
            skuProducts.forEach(sku => {
                const cost = calculateProductCost(sku);
                const option = document.createElement('option');
                option.value = sku.id;
                option.textContent = `${sku.skuName} (ì›ê°€: ${cost.toLocaleString()}ì›)`;
                select.appendChild(option);
            });

            if (idx >= 0 && vendorMappings[selectedVendor] && vendorMappings[selectedVendor][idx]) {
                const mapping = vendorMappings[selectedVendor][idx];
                document.getElementById('mapping-modal-title').textContent = 'ìƒí’ˆì½”ë“œ ë§¤ì¹­ ìˆ˜ì •';
                document.getElementById('mapping-product-code').value = mapping.productCode;
                document.getElementById('mapping-sku-select').value = mapping.skuProductId;
                document.getElementById('mapping-selling-price').value = mapping.sellingPrice || '';
            } else {
                document.getElementById('mapping-modal-title').textContent = 'ìƒí’ˆì½”ë“œ ë§¤ì¹­ ì¶”ê°€';
                document.getElementById('mapping-product-code').value = '';
                document.getElementById('mapping-sku-select').value = '';
                document.getElementById('mapping-selling-price').value = '';
            }

            updateMappingCostInfo();
            modal.classList.add('show');
        }
        window.openMappingModal = openMappingModal;

        function updateMappingCostInfo() {
            const skuId = document.getElementById('mapping-sku-select').value;
            const sellingPrice = parseInt(document.getElementById('mapping-selling-price').value) || 0;
            const costInfoBox = document.getElementById('mapping-cost-info');

            if (!skuId) {
                costInfoBox.style.display = 'none';
                return;
            }

            const sku = skuProducts.find(p => p.id === skuId);
            if (!sku) {
                costInfoBox.style.display = 'none';
                return;
            }

            const cost = calculateProductCost(sku);
            const profit = sellingPrice - cost;
            const profitRate = sellingPrice > 0 ? ((profit / sellingPrice) * 100).toFixed(1) : 0;

            document.getElementById('mapping-cost-total').textContent = cost.toLocaleString() + 'ì›';
            document.getElementById('mapping-selling').textContent = sellingPrice.toLocaleString() + 'ì›';
            document.getElementById('mapping-profit').textContent = profit.toLocaleString() + 'ì›';
            document.getElementById('mapping-profit').style.color = profit >= 0 ? 'green' : 'red';
            document.getElementById('mapping-profit-rate').textContent = profitRate + '%';
            document.getElementById('mapping-profit-rate').style.color = profit >= 0 ? 'green' : 'red';

            costInfoBox.style.display = 'block';
        }
        window.updateMappingCostInfo = updateMappingCostInfo;

        function updatePackagingSelect() {
            const select = document.getElementById('sku-packaging');
            select.innerHTML = '<option value="">ì„ íƒí•˜ì„¸ìš”</option>';
            Object.entries(packagingData).forEach(([name, price]) => {
                const option = document.createElement('option');
                option.value = name;
                option.textContent = `${name} (${price.toLocaleString()}ì›)`;
                select.appendChild(option);
            });
        }

        function addCompositionItem() {
            const container = document.getElementById('sku-composition-container');
            const item = document.createElement('div');
            item.className = 'composition-item';

            let partOptions = '<option value="">ë¶€ìœ„/í’ˆëª© ì„ íƒ</option>';
            Object.entries(partsData).forEach(([name, data]) => {
                // ì´ì „ í˜•ì‹(ìˆ«ì)ê³¼ ìƒˆ í˜•ì‹({price, type}) ëª¨ë‘ ì§€ì›
                const price = typeof data === 'number' ? data : data.price;
                const type = typeof data === 'number' ? 'weight' : (data.type || 'weight');
                const unitLabel = type === 'weight' ? 'ì›/100g' : 'ì›/ê°œ';
                partOptions += `<option value="${escapeHtml(name)}" data-type="${type}">${escapeHtml(name)} (${price.toLocaleString()}${unitLabel})</option>`;
            });

            item.innerHTML = `
                <div class="comp-field">
                    <label>ë¶€ìœ„/í’ˆëª©</label>
                    <select class="comp-part" onchange="updateCompositionWeightLabel(this); calculateSkuCost()">${partOptions}</select>
                </div>
                <div class="comp-field comp-weight-field">
                    <label class="comp-weight-label">ì¤‘ëŸ‰ (g)</label>
                    <input type="number" class="comp-weight" placeholder="ì˜ˆ: 500" oninput="calculateSkuCost()">
                </div>
                <div class="comp-field">
                    <label>ìˆ˜ëŸ‰</label>
                    <input type="number" class="comp-quantity" value="1" min="1" oninput="calculateSkuCost()">
                </div>
                <button class="btn btn-danger" onclick="this.parentElement.remove(); calculateSkuCost();">ì‚­ì œ</button>
            `;

            container.appendChild(item);
        }

        function updateCompositionWeightLabel(selectEl) {
            const item = selectEl.closest('.composition-item');
            const weightField = item.querySelector('.comp-weight-field');
            const weightLabel = item.querySelector('.comp-weight-label');
            const weightInput = item.querySelector('.comp-weight');
            const selectedOption = selectEl.options[selectEl.selectedIndex];
            const partName = selectEl.value;

            if (partName && partsData[partName]) {
                const data = partsData[partName];
                const type = typeof data === 'number' ? 'weight' : (data.type || 'weight');

                if (type === 'unit') {
                    weightLabel.textContent = 'ì¤‘ëŸ‰ (ë¯¸ì‚¬ìš©)';
                    weightInput.placeholder = 'ê°œìˆ˜ í’ˆëª©ì€ ë¬´ì‹œë¨';
                    weightInput.value = '1';
                    weightInput.disabled = true;
                    weightField.style.opacity = '0.5';
                } else {
                    weightLabel.textContent = 'ì¤‘ëŸ‰ (g)';
                    weightInput.placeholder = 'ì˜ˆ: 500';
                    weightInput.disabled = false;
                    weightField.style.opacity = '1';
                }
            } else {
                weightLabel.textContent = 'ì¤‘ëŸ‰ (g)';
                weightInput.placeholder = 'ì˜ˆ: 500';
                weightInput.disabled = false;
                weightField.style.opacity = '1';
            }
        }
        window.updateCompositionWeightLabel = updateCompositionWeightLabel;

        function calculateSkuCost() {
            const packaging = document.getElementById('sku-packaging').value;

            let partsCost = 0;
            let packagingCost = packaging && packagingData[packaging] ? packagingData[packaging] : 0;

            document.querySelectorAll('.composition-item').forEach(item => {
                const part = item.querySelector('.comp-part').value;
                const weight = parseInt(item.querySelector('.comp-weight').value) || 0;
                const quantity = parseInt(item.querySelector('.comp-quantity').value) || 1;

                if (part && partsData[part]) {
                    const data = partsData[part];
                    // ì´ì „ í˜•ì‹(ìˆ«ì)ê³¼ ìƒˆ í˜•ì‹({price, type}) ëª¨ë‘ ì§€ì›
                    const price = typeof data === 'number' ? data : data.price;
                    const type = typeof data === 'number' ? 'weight' : (data.type || 'weight');

                    if (type === 'weight' && weight > 0) {
                        // ì¤‘ëŸ‰ ê¸°ë°˜: 100gë‹¹ ê°€ê²© * (ì¤‘ëŸ‰/100) * ìˆ˜ëŸ‰
                        const pricePerPiece = (price / 100) * weight;
                        partsCost += pricePerPiece * quantity;
                    } else if (type === 'unit') {
                        // ê°œìˆ˜ ê¸°ë°˜: ê°œë‹¹ ê°€ê²© * ìˆ˜ëŸ‰ (ì¤‘ëŸ‰ ë¬´ì‹œ)
                        partsCost += price * quantity;
                    }
                }
            });

            const totalCost = Math.round(partsCost + packagingCost);

            document.getElementById('cost-parts').textContent = Math.round(partsCost).toLocaleString() + 'ì›';
            document.getElementById('cost-packaging').textContent = packagingCost.toLocaleString() + 'ì›';
            document.getElementById('cost-total').textContent = totalCost.toLocaleString() + 'ì›';

            const costInfoBox = document.getElementById('sku-cost-info');
            if (partsCost > 0 || packagingCost > 0) {
                costInfoBox.style.display = 'block';
            } else {
                costInfoBox.style.display = 'none';
            }
        }
        window.calculateSkuCost = calculateSkuCost;

        function closeSkuProductModal() {
            document.getElementById('sku-product-modal').classList.remove('show');
            editingSkuProductIndex = -1;
        }

        function closeMappingModal() {
            document.getElementById('mapping-modal').classList.remove('show');
            editingMappingIndex = -1;
        }

        function handleSaveSkuProduct() {
            const skuName = document.getElementById('sku-product-name').value.trim();
            const packaging = document.getElementById('sku-packaging').value;

            if (!skuName) {
                alert('SKUìƒí’ˆëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            // êµ¬ì„±í’ˆ ìˆ˜ì§‘
            const composition = [];
            document.querySelectorAll('.composition-item').forEach(item => {
                const part = item.querySelector('.comp-part').value;
                const weight = parseInt(item.querySelector('.comp-weight').value) || 0;
                const quantity = parseInt(item.querySelector('.comp-quantity').value) || 1;

                if (part) {
                    // partsDataì—ì„œ íƒ€ì… í™•ì¸
                    const partData = partsData[part];
                    const type = partData ? (typeof partData === 'number' ? 'weight' : (partData.type || 'weight')) : 'weight';

                    // ì¤‘ëŸ‰ ê¸°ë°˜ì€ weight > 0 í•„ìˆ˜, ê°œìˆ˜ ê¸°ë°˜ì€ weight ë¬´ì‹œ
                    if (type === 'unit' || weight > 0) {
                        composition.push({ part, weight, quantity });
                    }
                }
            });

            if (editingSkuProductIndex >= 0) {
                skuProducts[editingSkuProductIndex] = {
                    ...skuProducts[editingSkuProductIndex],
                    skuName,
                    packaging,
                    composition
                };
            } else {
                skuProducts.push({
                    id: Date.now().toString(),
                    skuName,
                    packaging,
                    composition
                });
            }

            saveSkuProducts();
            renderSkuProductsTable();
            closeSkuProductModal();

            showStatus(document.getElementById('sku-products-status'), 'SKU ìƒí’ˆì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
        }

        function handleSaveMapping() {
            const productCode = document.getElementById('mapping-product-code').value.trim();
            const skuProductId = document.getElementById('mapping-sku-select').value;
            const sellingPrice = parseInt(document.getElementById('mapping-selling-price').value) || 0;

            if (!productCode || !skuProductId) {
                alert('ìƒí’ˆì½”ë“œì™€ SKU ìƒí’ˆì„ ëª¨ë‘ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }

            if (!selectedVendor) {
                alert('ë°œì£¼ì²˜ë¥¼ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }

            // ìƒí’ˆì½”ë“œ ì¤‘ë³µ ì²´í¬
            const existingMappings = vendorMappings[selectedVendor] || [];
            const duplicateIndex = existingMappings.findIndex(m => m.productCode === productCode);

            // ìƒˆë¡œ ì¶”ê°€í•  ë•Œ ì¤‘ë³µì´ê±°ë‚˜, ìˆ˜ì •í•  ë•Œ ë‹¤ë¥¸ í•­ëª©ê³¼ ì¤‘ë³µì¸ ê²½ìš°
            if (duplicateIndex !== -1 && duplicateIndex !== editingMappingIndex) {
                alert(`ìƒí’ˆì½”ë“œ "${productCode}"ëŠ” ì´ë¯¸ ë“±ë¡ë˜ì–´ ìˆìŠµë‹ˆë‹¤.\në‹¤ë¥¸ ìƒí’ˆì½”ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.`);
                document.getElementById('mapping-product-code').focus();
                return;
            }

            const mappingItem = { productCode, skuProductId, sellingPrice };

            if (editingMappingIndex >= 0) {
                vendorMappings[selectedVendor][editingMappingIndex] = mappingItem;
            } else {
                vendorMappings[selectedVendor].push(mappingItem);
            }

            saveVendorMappings();
            renderMappingTable();
            renderVendorList();
            closeMappingModal();

            showStatus(document.getElementById('mapping-status'), 'ë§¤ì¹­ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
        }

        function handleDeleteSkuProduct(idx) {
            if (!confirm('ì´ SKU ìƒí’ˆì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nì—°ê²°ëœ ë§¤ì¹­ë„ í•¨ê»˜ ì‚­ì œë˜ê³ , ë³€í™˜í™•ì •ì˜ ë§¤ì¹­ ì •ë³´ë„ í•´ì œë©ë‹ˆë‹¤.')) {
                return;
            }

            const deletedProduct = skuProducts[idx];
            const deletedId = deletedProduct.id;
            const deletedSkuName = deletedProduct.skuName;

            skuProducts.splice(idx, 1);

            // ì—°ê²°ëœ ë§¤ì¹­ë„ ì‚­ì œ
            Object.keys(vendorMappings).forEach(vendor => {
                vendorMappings[vendor] = vendorMappings[vendor].filter(m => m.skuProductId !== deletedId);
            });

            // ë³€í™˜í™•ì •ì—ì„œ í•´ë‹¹ SKUë¡œ ë§¤ì¹­ëœ í•­ëª©ë“¤ì„ ë¯¸ë§¤ì¹­ìœ¼ë¡œ ë³€ê²½
            let unmatchedCount = 0;
            confirmedData.forEach(item => {
                if (item._skuMatched && item.skuName === deletedSkuName) {
                    item._skuMatched = false;
                    item.skuName = item.productName; // ì›ë˜ ìƒí’ˆëª…ìœ¼ë¡œ ë³µì›
                    unmatchedCount++;
                }
            });

            saveSkuProducts();
            saveVendorMappings();
            if (unmatchedCount > 0) {
                saveConfirmedData();
                renderConfirmed();
            }
            renderSkuProductsTable();

            let message = 'SKU ìƒí’ˆì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.';
            if (unmatchedCount > 0) {
                message += ` (ë³€í™˜í™•ì • ${unmatchedCount}ê±´ ë¯¸ë§¤ì¹­ìœ¼ë¡œ ë³€ê²½)`;
            }
            showStatus(document.getElementById('sku-products-status'), message, 'success');
        }
        window.handleDeleteSkuProduct = handleDeleteSkuProduct;

        function handleDeleteMapping(idx) {
            if (!confirm('ì´ ë§¤ì¹­ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\në³€í™˜í™•ì •ì˜ ê´€ë ¨ ë§¤ì¹­ ì •ë³´ë„ í•´ì œë©ë‹ˆë‹¤.')) {
                return;
            }

            const deletedMapping = vendorMappings[selectedVendor][idx];
            const deletedProductCode = deletedMapping.productCode;
            const deletedSku = skuProducts.find(p => p.id === deletedMapping.skuProductId);
            const deletedSkuName = deletedSku ? deletedSku.skuName : null;

            vendorMappings[selectedVendor].splice(idx, 1);

            // ë³€í™˜í™•ì •ì—ì„œ í•´ë‹¹ ê±°ë˜ì²˜+ìƒí’ˆì½”ë“œë¡œ ë§¤ì¹­ëœ í•­ëª©ë“¤ì„ ë¯¸ë§¤ì¹­ìœ¼ë¡œ ë³€ê²½
            let unmatchedCount = 0;
            if (deletedSkuName) {
                confirmedData.forEach(item => {
                    if (item._skuMatched &&
                        item.vendor === selectedVendor &&
                        item.productCode === deletedProductCode &&
                        item.skuName === deletedSkuName) {
                        item._skuMatched = false;
                        item.skuName = item.productName;
                        unmatchedCount++;
                    }
                });
            }

            saveVendorMappings();
            if (unmatchedCount > 0) {
                saveConfirmedData();
                renderConfirmed();
            }
            renderMappingTable();
            renderVendorList();

            let message = 'ë§¤ì¹­ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.';
            if (unmatchedCount > 0) {
                message += ` (ë³€í™˜í™•ì • ${unmatchedCount}ê±´ ë¯¸ë§¤ì¹­ìœ¼ë¡œ ë³€ê²½)`;
            }
            showStatus(document.getElementById('mapping-status'), message, 'success');
        }
        window.handleDeleteMapping = handleDeleteMapping;

        // ë§¤ì¹­ ì—‘ì…€ ê°€ì ¸ì˜¤ê¸°/ë‚´ë³´ë‚´ê¸°
        function openImportMappingModal() {
            if (!selectedVendor) {
                showStatus(document.getElementById('mapping-status'), 'ë°œì£¼ì²˜ë¥¼ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”.', 'error');
                return;
            }
            document.getElementById('import-mapping-modal').classList.add('show');
        }

        function closeImportMappingModal() {
            document.getElementById('import-mapping-modal').classList.remove('show');
            document.getElementById('import-mapping-file-input').value = '';
        }

        function handleImportMappingFile() {
            const file = document.getElementById('import-mapping-file-input').files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const wb = XLSX.read(e.target.result, { type: 'array' });
                    const sheet = wb.Sheets[wb.SheetNames[0]];
                    const data = XLSX.utils.sheet_to_json(sheet, { header: 1 });

                    let importCount = 0;
                    let notFoundCount = 0;
                    for (let i = 1; i < data.length; i++) {
                        const row = data[i];
                        if (row && row[0] && row[1]) {
                            const productCode = String(row[0]).trim();
                            const skuName = String(row[1]).trim();
                            const sellingPrice = row[2] ? parseInt(row[2]) : 0;

                            // SKU ìƒí’ˆëª…ìœ¼ë¡œ ID ì°¾ê¸°
                            const sku = skuProducts.find(p => p.skuName === skuName);
                            if (sku) {
                                vendorMappings[selectedVendor].push({
                                    productCode,
                                    skuProductId: sku.id,
                                    sellingPrice
                                });
                                importCount++;
                            } else {
                                notFoundCount++;
                            }
                        }
                    }

                    saveVendorMappings();
                    renderMappingTable();
                    renderVendorList();
                    closeImportMappingModal();

                    let message = `${importCount}ê°œì˜ ë§¤ì¹­ì„ ê°€ì ¸ì™”ìŠµë‹ˆë‹¤.`;
                    if (notFoundCount > 0) {
                        message += ` (${notFoundCount}ê°œëŠ” SKU ìƒí’ˆì„ ì°¾ì„ ìˆ˜ ì—†ì–´ ê±´ë„ˆëœ€)`;
                    }
                    showStatus(document.getElementById('mapping-status'), message, 'success');
                } catch (err) {
                    showStatus(document.getElementById('mapping-status'), 'íŒŒì¼ì„ ì½ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + err.message, 'error');
                }
            };
            reader.readAsArrayBuffer(file);
        }

        function handleExportMapping() {
            if (!selectedVendor || !vendorMappings[selectedVendor] || vendorMappings[selectedVendor].length === 0) {
                showStatus(document.getElementById('mapping-status'), 'ë‚´ë³´ë‚¼ ë§¤ì¹­ì´ ì—†ìŠµë‹ˆë‹¤.', 'error');
                return;
            }

            const exportData = vendorMappings[selectedVendor].map(mapping => {
                const sku = skuProducts.find(p => p.id === mapping.skuProductId);
                const cost = sku ? calculateProductCost(sku) : 0;
                const sellingPrice = mapping.sellingPrice || 0;
                const profit = sellingPrice - cost;
                return {
                    'ìƒí’ˆì½”ë“œ': mapping.productCode,
                    'SKUìƒí’ˆëª…': sku ? sku.skuName : '(ì‚­ì œëœ ìƒí’ˆ)',
                    'ì›ê°€': cost,
                    'íŒë§¤ê°€': sellingPrice,
                    'ì†ìµ': profit
                };
            });

            const ws = XLSX.utils.json_to_sheet(exportData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'ë§¤ì¹­');

            XLSX.writeFile(wb, `ë§¤ì¹­_${selectedVendor}_${formatDate(new Date())}.xlsx`);

            showStatus(document.getElementById('mapping-status'), 'ë§¤ì¹­ ëª©ë¡ì„ ë‚´ë³´ëƒˆìŠµë‹ˆë‹¤.', 'success');
        }

        // ==================== ë°ì´í„° ì €ì¥/ë¶ˆëŸ¬ì˜¤ê¸° (Firebase ì—°ë™) ====================

        // ë³€í™˜ì™„ë£Œ ë°ì´í„° ì €ì¥
        function saveConvertedData() {
            if (!currentUser) {
                // í´ë°±: localStorage
                localStorage.setItem('convertedData', JSON.stringify(convertedData));
                return;
            }
            database.ref(`users/${currentUser}/convertedData`).set(convertedData);
        }

        // ë³€í™˜í™•ì • ë°ì´í„° ì €ì¥
        function saveConfirmedData() {
            if (!currentUser) {
                // í´ë°±: localStorage
                localStorage.setItem('confirmedData', JSON.stringify(confirmedData));
                return;
            }
            database.ref(`users/${currentUser}/confirmedData`).set(confirmedData);
        }

        // ë³€í™˜ì™„ë£Œ + ë³€í™˜í™•ì • ë°ì´í„° ë™ì‹œ ì €ì¥ (race condition ë°©ì§€)
        function saveConvertedAndConfirmedData() {
            if (!currentUser) {
                // í´ë°±: localStorage
                localStorage.setItem('convertedData', JSON.stringify(convertedData));
                localStorage.setItem('confirmedData', JSON.stringify(confirmedData));
                return;
            }

            // ë‹¤ì¤‘ ê²½ë¡œ ì—…ë°ì´íŠ¸ë¡œ ì›ìì  ì €ì¥
            const updates = {};
            updates[`users/${currentUser}/convertedData`] = convertedData;
            updates[`users/${currentUser}/confirmedData`] = confirmedData;

            database.ref().update(updates)
                .catch(err => {
                    console.error('Firebase ì €ì¥ ì‹¤íŒ¨:', err.message);
                });
        }

        // ë³€í™˜í™•ì • ë°ì´í„° ë¡œë“œ (localStorage í´ë°±ìš©)
        function loadConfirmedData() {
            const saved = localStorage.getItem('confirmedData');
            if (saved) {
                confirmedData = JSON.parse(saved);
                renderConfirmed();
            }
        }

        // ==================== ì „ì²´ì£¼ë¬¸ê´€ë¦¬ ====================
        function saveOrderManagementData() {
            if (!currentUser) {
                // í´ë°±: localStorage
                localStorage.setItem('orderManagementData', JSON.stringify(orderManagementData));
                if (typeof renderCalendar === 'function') {
                    renderCalendar();
                }
                return;
            }
            database.ref(`users/${currentUser}/orderManagementData`).set(orderManagementData);
            // ëŒ€ì‹œë³´ë“œ ë‹¬ë ¥ ê°±ì‹ 
            if (typeof renderCalendar === 'function') {
                renderCalendar();
            }
        }

        function loadOrderManagementData() {
            const saved = localStorage.getItem('orderManagementData');
            if (saved) {
                orderManagementData = JSON.parse(saved);
                renderOrderManagement();
            }
        }

        function updateOrderManagementBadge() {
            const badge = document.getElementById(`badge-order-${currentUser}`);
            if (!badge) return;

            if (orderManagementData.length > 0) {
                badge.textContent = orderManagementData.length;
                badge.style.display = '';
            } else {
                badge.style.display = 'none';
            }
        }

        // ì „ì²´ì£¼ë¬¸ê´€ë¦¬ ë‚ ì§œ í•„í„° ì ìš©
        function applyOrderDateFilter() {
            const fromInput = document.getElementById('order-date-from');
            const toInput = document.getElementById('order-date-to');
            const statusSelect = document.getElementById('order-status-filter');

            orderDateFilter.from = fromInput ? fromInput.value : null;
            orderDateFilter.to = toInput ? toInput.value : null;
            orderDateFilter.status = statusSelect ? statusSelect.value : '';

            renderOrderManagement();
        }
        window.applyOrderDateFilter = applyOrderDateFilter;

        // ì „ì²´ì£¼ë¬¸ê´€ë¦¬ ë‚ ì§œ í•„í„° ì´ˆê¸°í™”
        function clearOrderDateFilter() {
            const fromInput = document.getElementById('order-date-from');
            const toInput = document.getElementById('order-date-to');
            const statusSelect = document.getElementById('order-status-filter');

            if (fromInput) fromInput.value = '';
            if (toInput) toInput.value = '';
            if (statusSelect) statusSelect.value = '';

            orderDateFilter = { from: null, to: null, status: '' };
            renderOrderManagement();
        }
        window.clearOrderDateFilter = clearOrderDateFilter;

        function renderOrderManagement() {
            updateOrderManagementBadge();

            if (orderManagementData.length === 0) {
                orderManagementContent.style.display = 'block';
                orderManagementDataEl.style.display = 'none';
                return;
            }

            orderManagementContent.style.display = 'none';
            orderManagementDataEl.style.display = 'block';

            // í•„í„° ì´ˆê¸°í™” ë²„íŠ¼ í‘œì‹œ/ìˆ¨ê¹€
            const hasActiveOrderFilters = Object.keys(orderManagementFilters).some(k => orderManagementFilters[k] && orderManagementFilters[k].length > 0);
            const hasActiveOrderSort = orderManagementSort.key !== null;
            const resetBtn = document.getElementById('btn-order-reset-filters');
            if (resetBtn) {
                resetBtn.style.display = (hasActiveOrderFilters || hasActiveOrderSort) ? 'inline-block' : 'none';
            }

            const totalCount = orderManagementData.length;
            const filteredCount = getFilteredOrderManagementData().length;
            const selectedCount = orderManagementData.filter(item => item._selected).length;
            const shippedCount = orderManagementData.filter(item => item._shipped).length;
            const paidCount = orderManagementData.filter(item => item._paid).length;
            const invoiceIssuedCount = orderManagementData.filter(item => item._invoiceIssued).length;

            const vendorCounts = {};
            orderManagementData.forEach(item => {
                const vendor = item.vendor || 'ë¯¸ì§€ì •';
                vendorCounts[vendor] = (vendorCounts[vendor] || 0) + 1;
            });

            const isFiltered = filteredCount !== totalCount;

            let summaryHtml = `
                <div class="summary-item">
                    <div class="number">${isFiltered ? filteredCount + '/' + totalCount : totalCount}</div>
                    <div class="label">${isFiltered ? 'í•„í„°/ì „ì²´' : 'ì „ì²´'}</div>
                </div>
                <div class="summary-item">
                    <div class="number">${selectedCount}</div>
                    <div class="label">ì„ íƒ</div>
                </div>
                <div class="summary-item" style="background: ${shippedCount === totalCount ? '#e8f5e9' : '#fff3e0'};">
                    <div class="number" style="color: ${shippedCount === totalCount ? '#2e7d32' : '#e65100'};">${shippedCount}/${totalCount}</div>
                    <div class="label">ì¶œê³ ì™„ë£Œ</div>
                </div>
                <div class="summary-item" style="background: ${paidCount === totalCount ? '#e3f2fd' : '#fce4ec'};">
                    <div class="number" style="color: ${paidCount === totalCount ? '#1565c0' : '#c62828'};">${paidCount}/${totalCount}</div>
                    <div class="label">ê²°ì œì™„ë£Œ</div>
                </div>
                <div class="summary-item" style="background: ${invoiceIssuedCount === totalCount ? '#f3e5f5' : '#efebe9'};">
                    <div class="number" style="color: ${invoiceIssuedCount === totalCount ? '#7b1fa2' : '#5d4037'};">${invoiceIssuedCount}/${totalCount}</div>
                    <div class="label">ê³„ì‚°ì„œë°œí–‰</div>
                </div>
            `;

            for (const [vendor, count] of Object.entries(vendorCounts)) {
                summaryHtml += `
                    <div class="summary-item">
                        <div class="number">${count}</div>
                        <div class="label">${escapeHtml(vendor)}</div>
                    </div>
                `;
            }

            orderManagementSummary.innerHTML = summaryHtml;

            // í•„í„°ë§ëœ ë°ì´í„° ê°€ì ¸ì˜¤ê¸° (ì¶œê³ ì™„ë£Œ ê±´ì€ ìë™ìœ¼ë¡œ í•˜ë‹¨ìœ¼ë¡œ ì •ë ¬ë¨)
            const filteredData = getFilteredOrderManagementData();
            orderManagementTable.innerHTML = buildOrderManagementTable(filteredData);
        }

        // ì „ì²´ì£¼ë¬¸ê´€ë¦¬ í‘œì‹œìš© ê°’ ê°€ì ¸ì˜¤ê¸°
        function getOrderDisplayValue(item, key) {
            if (key === 'packagingComposition') {
                let sku = null;
                if (item._skuProductId) {
                    sku = skuProducts.find(p => p.id === item._skuProductId);
                }
                if (!sku && item.skuName) {
                    const skuNameClean = item.skuName.replace(/ - \d+ê°œ$/, '');
                    sku = skuProducts.find(p => p.skuName === skuNameClean);
                }
                if (sku && sku.packaging) {
                    return `[${sku.packaging}]`;
                }
                return '-';
            }
            if (key === '_shipped') {
                return item._shipped ? 'ì¶œê³ ì™„ë£Œ' : 'ë¯¸ì¶œê³ ';
            }
            if (key === '_paid') {
                return item._paid ? 'ê²°ì œì™„ë£Œ' : 'ë¯¸ê²°ì œ';
            }
            if (key === '_invoiceIssued') {
                return item._invoiceIssued ? 'ë°œí–‰ì™„ë£Œ' : 'ë¯¸ë°œí–‰';
            }
            return item[key] || '';
        }

        // ì „ì²´ì£¼ë¬¸ê´€ë¦¬ í•„í„°ë§ëœ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
        function getFilteredOrderManagementData() {
            let data = [...orderManagementData];

            // ë‚ ì§œ í•„í„° ì ìš©
            if (orderDateFilter.from) {
                data = data.filter(item => {
                    const releaseDate = item.releaseDate || '';
                    return releaseDate >= orderDateFilter.from;
                });
            }
            if (orderDateFilter.to) {
                data = data.filter(item => {
                    const releaseDate = item.releaseDate || '';
                    return releaseDate <= orderDateFilter.to;
                });
            }

            // ìƒíƒœ í•„í„° ì ìš©
            if (orderDateFilter.status === 'pending') {
                data = data.filter(item => !item._shipped);
            } else if (orderDateFilter.status === 'shipped') {
                data = data.filter(item => item._shipped);
            }

            // ì»¬ëŸ¼ë³„ í•„í„° ì ìš©
            Object.keys(orderManagementFilters).forEach(key => {
                const filterValues = orderManagementFilters[key];
                if (filterValues && filterValues.length > 0) {
                    data = data.filter(item => {
                        const value = getOrderDisplayValue(item, key);
                        return filterValues.includes(value);
                    });
                }
            });

            // ì •ë ¬ ì ìš©
            if (orderManagementSort.key && orderManagementSort.direction) {
                data.sort((a, b) => {
                    const aVal = getOrderDisplayValue(a, orderManagementSort.key) || '';
                    const bVal = getOrderDisplayValue(b, orderManagementSort.key) || '';

                    let comparison = 0;
                    if (aVal < bVal) comparison = -1;
                    else if (aVal > bVal) comparison = 1;

                    return orderManagementSort.direction === 'desc' ? -comparison : comparison;
                });
            }

            // ì¶œê³ ì™„ë£Œ ê±´ì€ í•˜ë‹¨ìœ¼ë¡œ ì •ë ¬ (í•„í„°/ì •ë ¬ í›„ì—ë„ ìœ ì§€)
            data.sort((a, b) => {
                if (a._shipped && !b._shipped) return 1;
                if (!a._shipped && b._shipped) return -1;
                return 0;
            });

            return data;
        }

        function buildOrderManagementTable(data) {
            const columns = ORDER_MANAGEMENT_COLUMNS;

            // í•„í„° ê°€ëŠ¥í•œ ì»¬ëŸ¼ë“¤ (í¬ì¥&êµ¬ì„± ì œì™¸)
            const filterableColumns = ['registeredDate', 'vendor', 'releaseDate', 'skuName', 'receiverName', 'senderName', '_shipped', '_paid', '_invoiceIssued'];

            let html = '<table><thead><tr>';
            html += '<th class="checkbox-cell"></th>';
            html += '<th>#</th>';

            columns.forEach(col => {
                const isFilterable = filterableColumns.includes(col.key);
                const hasFilter = orderManagementFilters[col.key] && orderManagementFilters[col.key].length > 0;
                const isCurrentSort = orderManagementSort.key === col.key;

                if (isFilterable) {
                    html += `<th class="th-filter" data-filter-col="${col.key}">
                        <div class="th-filter-wrapper">
                            <div class="th-content" onclick="window.toggleOrderSort('${col.key}')">
                                <span class="th-title">${col.name}</span>
                                <span class="th-sort-icons">
                                    <span class="sort-icon ${isCurrentSort && orderManagementSort.direction === 'asc' ? 'active' : ''}">â–²</span>
                                    <span class="sort-icon ${isCurrentSort && orderManagementSort.direction === 'desc' ? 'active' : ''}">â–¼</span>
                                </span>
                            </div>
                            <span class="filter-icon-btn ${hasFilter ? 'active' : ''}" onclick="event.stopPropagation(); window.openOrderFilterDropdown(event, '${col.key}')">â–¼</span>
                        </div>
                        <div class="filter-dropdown" id="order-filter-dropdown-${col.key}" onclick="event.stopPropagation()"></div>
                    </th>`;
                } else {
                    html += `<th>${col.name}</th>`;
                }
            });
            html += '</tr></thead><tbody>';

            data.forEach((item, displayIdx) => {
                // ì›ë³¸ ë°ì´í„°ì—ì„œì˜ ì‹¤ì œ ì¸ë±ìŠ¤ ì°¾ê¸°
                const idx = orderManagementData.indexOf(item);
                // ì¶œê³ ì™„ë£Œ ê±´ì€ ì–´ë‘ìš´ íšŒìƒ‰ ë°°ê²½
                const rowStyle = item._shipped ? 'background-color: #9e9e9e; color: #fff;' : '';
                html += `<tr style="${rowStyle}">`;
                html += `<td class="checkbox-cell"><input type="checkbox" ${item._selected ? 'checked' : ''} onchange="window.handleOrderRowToggle(${idx})"></td>`;
                html += `<td class="row-num">${displayIdx + 1}</td>`;

                const isShippedRow = item._shipped;
                const textColor = isShippedRow ? '#fff' : '';
                const subTextColor = isShippedRow ? '#ddd' : '#888';

                for (const col of columns) {
                    const value = escapeHtml(item[col.key] || '');

                    if (col.key === 'vendor') {
                        html += `<td><span class="vendor-tag" style="${isShippedRow ? 'background: #757575; color: #fff;' : ''}">${value || '-'}</span></td>`;
                    } else if (col.key === 'registeredDate') {
                        html += `<td style="font-size: 12px; color: ${isShippedRow ? '#ddd' : '#666'};">${value || '-'}</td>`;
                    } else if (col.key === 'invoiceNo') {
                        html += `<td><input type="text" value="${value}" class="editable-note" style="width: 100px; ${isShippedRow ? 'background: #757575; color: #fff; border-color: #888;' : ''}" placeholder="ì†¡ì¥ë²ˆí˜¸" onchange="window.handleOrderCellChange(${idx}, 'invoiceNo', this.value)"></td>`;
                    } else if (col.key === '_shipped') {
                        const isShipped = item._shipped;
                        html += `<td><span class="status-badge ${isShipped ? 'shipped' : 'not-shipped'}" onclick="window.toggleOrderStatus(${idx}, '_shipped')" style="cursor: pointer;">${isShipped ? 'ì¶œê³ ì™„ë£Œ' : 'ë¯¸ì¶œê³ '}</span></td>`;
                    } else if (col.key === '_paid') {
                        const isPaid = item._paid;
                        html += `<td><span class="status-badge ${isPaid ? 'paid' : 'not-paid'}" onclick="window.toggleOrderStatus(${idx}, '_paid')" style="cursor: pointer;">${isPaid ? 'ê²°ì œì™„ë£Œ' : 'ë¯¸ê²°ì œ'}</span></td>`;
                    } else if (col.key === '_invoiceIssued') {
                        const isIssued = item._invoiceIssued;
                        html += `<td><span class="status-badge ${isIssued ? 'issued' : 'not-issued'}" onclick="window.toggleOrderStatus(${idx}, '_invoiceIssued')" style="cursor: pointer;">${isIssued ? 'ë°œí–‰ì™„ë£Œ' : 'ë¯¸ë°œí–‰'}</span></td>`;
                    } else if (col.key === 'unitPrice') {
                        // ì£¼ë¬¸ ìì²´ì— ì €ì¥ëœ ë‹¨ê°€ê°€ ìˆìœ¼ë©´ ì‚¬ìš©, ì—†ìœ¼ë©´ ê±°ë˜ì²˜/SKUì—ì„œ ê°€ì ¸ì˜¤ê¸°
                        let unitPrice = item._unitPrice || 0;
                        if (!unitPrice) {
                            if (item.vendor && item.productCode && vendorMappings[item.vendor]) {
                                const mapping = vendorMappings[item.vendor].find(m => m.productCode === item.productCode);
                                if (mapping && mapping.sellingPrice) {
                                    unitPrice = mapping.sellingPrice;
                                }
                            }
                            if (!unitPrice && item._skuProductId) {
                                const sku = skuProducts.find(p => p.id === item._skuProductId);
                                if (sku && sku.sellingPrice) {
                                    unitPrice = sku.sellingPrice;
                                }
                            }
                        }
                        html += `<td><input type="number" value="${unitPrice || ''}" class="editable-note" style="width: 80px; text-align: right; ${isShippedRow ? 'background: #757575; color: #fff; border-color: #888;' : ''}" placeholder="ë‹¨ê°€" onchange="window.handleOrderCellChange(${idx}, '_unitPrice', this.value)"></td>`;
                    } else if (col.key === 'totalPrice') {
                        // ë‹¨ê°€ Ã— ìˆ˜ëŸ‰ (í•©í¬ì¥ ì „ ì›ë˜ ìˆ˜ëŸ‰ ê¸°ì¤€)
                        let unitPrice = item._unitPrice || 0;
                        if (!unitPrice) {
                            if (item.vendor && item.productCode && vendorMappings[item.vendor]) {
                                const mapping = vendorMappings[item.vendor].find(m => m.productCode === item.productCode);
                                if (mapping && mapping.sellingPrice) {
                                    unitPrice = mapping.sellingPrice;
                                }
                            }
                            if (!unitPrice && item._skuProductId) {
                                const sku = skuProducts.find(p => p.id === item._skuProductId);
                                if (sku && sku.sellingPrice) {
                                    unitPrice = sku.sellingPrice;
                                }
                            }
                        }
                        // í•©í¬ì¥ ì „ ì›ë˜ ìˆ˜ëŸ‰ ì‚¬ìš© (_originalQuantityê°€ ìˆìœ¼ë©´ ì‚¬ìš©, ì—†ìœ¼ë©´ quantity ì‚¬ìš©)
                        const originalQuantity = parseInt(item._originalQuantity || item.quantity) || 1;
                        const totalPrice = unitPrice * originalQuantity;
                        html += `<td style="text-align: right; font-weight: 600; ${isShippedRow ? 'color: #fff;' : ''}">${totalPrice ? totalPrice.toLocaleString() + 'ì›' : '-'}</td>`;
                    } else if (col.key === 'note') {
                        html += `<td><input type="text" value="${value}" class="editable-note" placeholder="ë¹„ê³ " style="${isShippedRow ? 'background: #757575; color: #fff; border-color: #888;' : ''}" onchange="window.handleOrderCellChange(${idx}, 'note', this.value)"></td>`;
                    } else if (col.key === 'skuName') {
                        const originalName = escapeHtml(item.productName || '');
                        html += `<td style="min-width: 120px;">
                            <div style="font-weight: 500;">${value || '-'}</div>
                            <div style="font-size: 11px; color: ${subTextColor};">${originalName}</div>
                        </td>`;
                    } else if (col.key === 'packagingComposition') {
                        // í¬ì¥&êµ¬ì„± í‘œì‹œ (ë³€í™˜í™•ì • í…Œì´ë¸”ê³¼ ë™ì¼í•œ í˜•ì‹)
                        let packCompText = '-';
                        let sku = null;
                        if (item._skuProductId) {
                            sku = skuProducts.find(p => p.id === item._skuProductId);
                        }
                        if (!sku && item.skuName) {
                            // í•©í¬ì¥ í˜•ì‹(ì˜ˆ: "ê°ˆë¹„íƒ•1íŒ©D - 2ê°œ")ì—ì„œ ì›ë³¸ SKUëª… ì¶”ì¶œ
                            const skuNameClean = item.skuName.replace(/ - \d+ê°œ$/, '');
                            sku = skuProducts.find(p => p.skuName === skuNameClean);
                        }
                        if (sku) {
                            const packagingName = sku.packaging || '';
                            const compText = sku.composition && sku.composition.length > 0
                                ? sku.composition.map(c => {
                                    const partData = partsData[c.part];
                                    const type = partData ? (typeof partData === 'number' ? 'weight' : (partData.type || 'weight')) : 'weight';
                                    const qty = c.quantity || 1;
                                    if (type === 'unit') {
                                        return `${c.part}${qty}ê°œ`;
                                    } else {
                                        return `${c.part}${c.weight}g` + (qty > 1 ? `x${qty}` : '');
                                    }
                                }).join(',')
                                : '';
                            packCompText = packagingName ? `[${packagingName}] ${compText}` : compText || '-';
                        }
                        html += `<td style="font-size: 12px; color: ${isShippedRow ? '#ddd' : '#555'}; min-width: 180px; max-width: 250px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;" title="${escapeHtml(packCompText)}">${escapeHtml(packCompText)}</td>`;
                    } else {
                        html += `<td style="${isShippedRow ? 'color: #fff;' : ''}">${value || '-'}</td>`;
                    }
                }
                html += '</tr>';
            });

            html += '</tbody></table>';
            return html;
        }

        // ì „ì²´ì£¼ë¬¸ê´€ë¦¬ í•„í„° ë“œë¡­ë‹¤ìš´ ì—´ê¸°
        function openOrderFilterDropdown(e, columnKey) {
            e.stopPropagation();
            const th = e.target.closest('.th-filter');
            toggleOrderFilterDropdown(columnKey, th);
        }
        window.openOrderFilterDropdown = openOrderFilterDropdown;

        // ì „ì²´ì£¼ë¬¸ê´€ë¦¬ í•„í„° ë“œë¡­ë‹¤ìš´ í† ê¸€
        function toggleOrderFilterDropdown(columnKey, thElement) {
            const dropdown = document.getElementById(`order-filter-dropdown-${columnKey}`);
            if (!dropdown) return;

            // ë‹¤ë¥¸ ë“œë¡­ë‹¤ìš´ ë‹«ê¸°
            document.querySelectorAll('.filter-dropdown.show').forEach(d => {
                if (d !== dropdown) d.classList.remove('show');
            });

            if (dropdown.classList.contains('show')) {
                dropdown.classList.remove('show');
                activeFilterDropdown = null;
            } else {
                dropdown.innerHTML = buildOrderFilterDropdownContent(columnKey);

                if (thElement) {
                    const rect = thElement.getBoundingClientRect();
                    dropdown.style.top = (rect.bottom + 2) + 'px';
                    dropdown.style.left = rect.left + 'px';

                    const dropdownWidth = 220;
                    if (rect.left + dropdownWidth > window.innerWidth) {
                        dropdown.style.left = (window.innerWidth - dropdownWidth - 10) + 'px';
                    }
                }

                dropdown.classList.add('show');
                activeFilterDropdown = columnKey;
            }
        }

        // ì „ì²´ì£¼ë¬¸ê´€ë¦¬ìš© ì„ì‹œ í•„í„° ìƒíƒœ
        let pendingOrderFilterSelections = {};

        // ì „ì²´ì£¼ë¬¸ê´€ë¦¬ í•„í„° ë“œë¡­ë‹¤ìš´ ë‚´ìš© ìƒì„±
        function buildOrderFilterDropdownContent(columnKey) {
            const valueCounts = {};
            orderManagementData.forEach(item => {
                const value = getOrderDisplayValue(item, columnKey) || '(ë¹ˆ ê°’)';
                valueCounts[value] = (valueCounts[value] || 0) + 1;
            });

            const sortedValues = Object.keys(valueCounts).sort();
            const currentFilters = orderManagementFilters[columnKey] || [];

            pendingOrderFilterSelections[columnKey] = currentFilters.length === 0
                ? [...sortedValues]
                : [...currentFilters];

            window._orderFilterValues = window._orderFilterValues || {};
            window._orderFilterValues[columnKey] = sortedValues;

            let html = `
                <div class="filter-header" onclick="event.stopPropagation()">
                    <input type="text" placeholder="ê²€ìƒ‰..." oninput="window.orderFilterDropdownSearch('${columnKey}', this.value)">
                </div>
                <div class="filter-select-actions" onclick="event.stopPropagation()">
                    <button class="btn-select-all" onclick="event.stopPropagation(); window.selectAllOrderFilterValues('${columnKey}')">ì „ì²´ì„ íƒ</button>
                    <button class="btn-deselect-all" onclick="event.stopPropagation(); window.deselectAllOrderFilterValues('${columnKey}')">ì „ì²´í•´ì œ</button>
                    <button class="btn-apply-filter" onclick="event.stopPropagation(); window.applyPendingOrderFilter('${columnKey}')">ì¡°íšŒ</button>
                </div>
                <div class="filter-list" id="order-filter-list-${columnKey}" onclick="event.stopPropagation()">
            `;

            sortedValues.forEach((value, idx) => {
                const isChecked = currentFilters.length === 0 || currentFilters.includes(value);
                const displayValue = value.length > 30 ? value.substring(0, 30) + '...' : value;
                html += `
                    <div class="filter-item" data-value="${escapeHtml(value)}" data-col="${columnKey}" data-idx="${idx}" onclick="event.stopPropagation()">
                        <input type="checkbox" ${isChecked ? 'checked' : ''} onchange="event.stopPropagation(); window.togglePendingOrderFilterValue('${columnKey}', ${idx}, this.checked)">
                        <span class="filter-item-label" title="${escapeHtml(value)}">${escapeHtml(displayValue)}</span>
                        <span class="filter-item-count">(${valueCounts[value]})</span>
                    </div>
                `;
            });

            html += '</div>';
            return html;
        }

        // ì „ì²´ì£¼ë¬¸ê´€ë¦¬ í•„í„° ê°’ í† ê¸€
        function togglePendingOrderFilterValue(columnKey, idx, checked) {
            const value = window._orderFilterValues && window._orderFilterValues[columnKey] ? window._orderFilterValues[columnKey][idx] : null;
            if (value === null) return;

            if (!pendingOrderFilterSelections[columnKey]) {
                pendingOrderFilterSelections[columnKey] = [];
            }

            if (checked) {
                if (!pendingOrderFilterSelections[columnKey].includes(value)) {
                    pendingOrderFilterSelections[columnKey].push(value);
                }
            } else {
                pendingOrderFilterSelections[columnKey] = pendingOrderFilterSelections[columnKey].filter(v => v !== value);
            }
        }
        window.togglePendingOrderFilterValue = togglePendingOrderFilterValue;

        // ì „ì²´ì£¼ë¬¸ê´€ë¦¬ ì „ì²´ ì„ íƒ
        function selectAllOrderFilterValues(columnKey) {
            const allValues = window._orderFilterValues[columnKey] || [];
            pendingOrderFilterSelections[columnKey] = [...allValues];

            const filterList = document.getElementById(`order-filter-list-${columnKey}`);
            if (filterList) {
                filterList.querySelectorAll('input[type="checkbox"]').forEach(cb => {
                    cb.checked = true;
                });
            }
        }
        window.selectAllOrderFilterValues = selectAllOrderFilterValues;

        // ì „ì²´ì£¼ë¬¸ê´€ë¦¬ ì „ì²´ í•´ì œ
        function deselectAllOrderFilterValues(columnKey) {
            pendingOrderFilterSelections[columnKey] = [];

            const filterList = document.getElementById(`order-filter-list-${columnKey}`);
            if (filterList) {
                filterList.querySelectorAll('input[type="checkbox"]').forEach(cb => {
                    cb.checked = false;
                });
            }
        }
        window.deselectAllOrderFilterValues = deselectAllOrderFilterValues;

        // ì „ì²´ì£¼ë¬¸ê´€ë¦¬ í•„í„° ì ìš©
        function applyPendingOrderFilter(columnKey) {
            const allValues = window._orderFilterValues[columnKey] || [];
            const selected = pendingOrderFilterSelections[columnKey] || [];

            if (selected.length === allValues.length || selected.length === 0) {
                delete orderManagementFilters[columnKey];
            } else {
                orderManagementFilters[columnKey] = [...selected];
            }

            closeAllFilterDropdowns();
            renderOrderManagement();
        }
        window.applyPendingOrderFilter = applyPendingOrderFilter;

        // ì „ì²´ì£¼ë¬¸ê´€ë¦¬ ì •ë ¬ í† ê¸€
        function toggleOrderSort(columnKey) {
            if (orderManagementSort.key === columnKey) {
                if (orderManagementSort.direction === 'asc') {
                    orderManagementSort.direction = 'desc';
                } else if (orderManagementSort.direction === 'desc') {
                    orderManagementSort = { key: null, direction: null };
                } else {
                    orderManagementSort.direction = 'asc';
                }
            } else {
                orderManagementSort = { key: columnKey, direction: 'asc' };
            }
            renderOrderManagement();
        }
        window.toggleOrderSort = toggleOrderSort;

        // ì „ì²´ì£¼ë¬¸ê´€ë¦¬ ë“œë¡­ë‹¤ìš´ ê²€ìƒ‰
        function orderFilterDropdownSearch(columnKey, searchTerm) {
            const filterList = document.getElementById(`order-filter-list-${columnKey}`);
            if (!filterList) return;

            const items = filterList.querySelectorAll('.filter-item');
            const term = searchTerm.toLowerCase();

            items.forEach(item => {
                const value = item.dataset.value.toLowerCase();
                item.style.display = value.includes(term) ? '' : 'none';
            });
        }
        window.orderFilterDropdownSearch = orderFilterDropdownSearch;

        // ì „ì²´ì£¼ë¬¸ê´€ë¦¬ ëª¨ë“  í•„í„°/ì •ë ¬ ì´ˆê¸°í™”
        function resetAllOrderFilters() {
            orderManagementFilters = {};
            orderManagementSort = { key: null, direction: null };
            closeAllFilterDropdowns();
            renderOrderManagement();
        }
        window.resetAllOrderFilters = resetAllOrderFilters;

        function handleOrderRowToggle(idx) {
            orderManagementData[idx]._selected = !orderManagementData[idx]._selected;
            renderOrderManagement();
            saveOrderManagementData();
        }
        window.handleOrderRowToggle = handleOrderRowToggle;

        function handleOrderCellChange(idx, key, value) {
            orderManagementData[idx][key] = value;

            // ì†¡ì¥ë²ˆí˜¸ ì…ë ¥ ì‹œ ìë™ìœ¼ë¡œ ì¶œê³ ì™„ë£Œ ì²˜ë¦¬
            if (key === 'invoiceNo' && value && value.trim() !== '') {
                orderManagementData[idx]._shipped = true;
                renderOrderManagement();
            }

            saveOrderManagementData();
        }
        window.handleOrderCellChange = handleOrderCellChange;

        function toggleOrderStatus(idx, statusKey) {
            orderManagementData[idx][statusKey] = !orderManagementData[idx][statusKey];
            renderOrderManagement();
            saveOrderManagementData();
        }
        window.toggleOrderStatus = toggleOrderStatus;

        function orderSelectAll() {
            // í•„í„°ëœ í•­ëª©ë§Œ ì„ íƒ
            const filteredData = getFilteredOrderManagementData();
            const filteredSet = new Set(filteredData);
            orderManagementData.forEach(item => {
                if (filteredSet.has(item)) {
                    item._selected = true;
                }
            });
            renderOrderManagement();
            saveOrderManagementData();
        }

        function orderDeselectAll() {
            // í•„í„°ëœ í•­ëª©ë§Œ ì„ íƒ í•´ì œ
            const filteredData = getFilteredOrderManagementData();
            const filteredSet = new Set(filteredData);
            orderManagementData.forEach(item => {
                if (filteredSet.has(item)) {
                    item._selected = false;
                }
            });
            renderOrderManagement();
            saveOrderManagementData();
        }

        function orderMarkShipped() {
            const selected = orderManagementData.filter(item => item._selected);
            if (selected.length === 0) {
                alert('ì„ íƒëœ í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            // ëª¨ë‘ ì¶œê³ ì™„ë£Œ ìƒíƒœë©´ ë¯¸ì¶œê³ ë¡œ, ì•„ë‹ˆë©´ ì¶œê³ ì™„ë£Œë¡œ
            const allShipped = selected.every(item => item._shipped);
            selected.forEach(item => item._shipped = !allShipped);
            renderOrderManagement();
            saveOrderManagementData();
            const statusText = allShipped ? 'ë¯¸ì¶œê³ ' : 'ì¶œê³ ì™„ë£Œ';
            showStatus(orderManagementStatus, `${selected.length}ê±´ì´ ${statusText} ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.`, 'success');
        }

        function orderMarkPaid() {
            const selected = orderManagementData.filter(item => item._selected);
            if (selected.length === 0) {
                alert('ì„ íƒëœ í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            // ëª¨ë‘ ê²°ì œì™„ë£Œ ìƒíƒœë©´ ë¯¸ê²°ì œë¡œ, ì•„ë‹ˆë©´ ê²°ì œì™„ë£Œë¡œ
            const allPaid = selected.every(item => item._paid);
            selected.forEach(item => item._paid = !allPaid);
            renderOrderManagement();
            saveOrderManagementData();
            const statusText = allPaid ? 'ë¯¸ê²°ì œ' : 'ê²°ì œì™„ë£Œ';
            showStatus(orderManagementStatus, `${selected.length}ê±´ì´ ${statusText} ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.`, 'success');
        }

        function orderMarkInvoiceIssued() {
            const selected = orderManagementData.filter(item => item._selected);
            if (selected.length === 0) {
                alert('ì„ íƒëœ í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            // ëª¨ë‘ ë°œí–‰ì™„ë£Œ ìƒíƒœë©´ ë¯¸ë°œí–‰ìœ¼ë¡œ, ì•„ë‹ˆë©´ ë°œí–‰ì™„ë£Œë¡œ
            const allIssued = selected.every(item => item._invoiceIssued);
            selected.forEach(item => item._invoiceIssued = !allIssued);
            renderOrderManagement();
            saveOrderManagementData();
            const statusText = allIssued ? 'ë¯¸ë°œí–‰' : 'ë°œí–‰ì™„ë£Œ';
            showStatus(orderManagementStatus, `${selected.length}ê±´ì´ ${statusText} ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.`, 'success');
        }

        function orderDeleteSelected() {
            const selected = orderManagementData.filter(item => item._selected);
            if (selected.length === 0) {
                alert('ì„ íƒëœ í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            if (!confirm(`ì„ íƒëœ ${selected.length}ê±´ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;

            orderManagementData = orderManagementData.filter(item => !item._selected);
            renderOrderManagement();
            saveOrderManagementData();
            showStatus(orderManagementStatus, `${selected.length}ê±´ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.`, 'success');
        }

        // ==================== ì „ì²´ì£¼ë¬¸ê´€ë¦¬ ì¼ê´„ìˆ˜ì • ====================
        function openOrderBulkEditModal() {
            const selectedItems = orderManagementData.filter(item => item._selected);

            if (selectedItems.length === 0) {
                showStatus(orderManagementStatus, 'ì¼ê´„ìˆ˜ì •í•  í•­ëª©ì„ ì„ íƒí•´ì£¼ì„¸ìš”.', 'error');
                return;
            }

            // ì„ íƒ ê±´ìˆ˜ í‘œì‹œ
            document.getElementById('order-bulk-edit-count').textContent = selectedItems.length;

            // ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
            document.getElementById('order-bulk-edit-unit-price').value = '';
            document.getElementById('order-bulk-edit-note').value = '';

            // ëª¨ë‹¬ í‘œì‹œ
            document.getElementById('order-bulk-edit-modal').classList.add('show');
        }

        function closeOrderBulkEditModal() {
            document.getElementById('order-bulk-edit-modal').classList.remove('show');
        }

        function applyOrderBulkEdit() {
            const unitPrice = document.getElementById('order-bulk-edit-unit-price').value.trim();
            const note = document.getElementById('order-bulk-edit-note').value.trim();

            // ëª¨ë“  í•„ë“œê°€ ë¹„ì–´ìˆìœ¼ë©´ ê²½ê³ 
            if (!unitPrice && !note) {
                alert('ìµœì†Œ í•˜ë‚˜ì˜ í•„ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            let updatedCount = 0;

            orderManagementData.forEach(item => {
                if (item._selected) {
                    if (unitPrice) {
                        item._unitPrice = parseInt(unitPrice) || 0;
                    }
                    if (note) {
                        item.note = note;
                    }
                    updatedCount++;
                }
            });

            closeOrderBulkEditModal();
            renderOrderManagement();
            saveOrderManagementData();
            showStatus(orderManagementStatus, `${updatedCount}ê±´ì˜ ë°ì´í„°ê°€ ì¼ê´„ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.`, 'success');
        }

        function handleOrderDownload() {
            if (orderManagementData.length === 0) {
                showStatus(orderManagementStatus, 'ë‹¤ìš´ë¡œë“œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.', 'error');
                return;
            }

            const headers = [
                'ë“±ë¡ì¼', 'ë°œì£¼ì²˜', 'ì¶œê³ ìš”ì²­ì¼', 'ìƒí’ˆì½”ë“œ', 'SKUìƒí’ˆëª…', 'ìƒí’ˆëª…',
                'ìˆ˜ëŸ‰', 'ìˆ˜ë ¹ì¸', 'ìˆ˜ë ¹ì¸ì—°ë½ì²˜', 'ìˆ˜ë ¹ì¸ì£¼ì†Œ', 'ì†¡ì¥ë²ˆí˜¸',
                'ì¶œê³ ì—¬ë¶€', 'ê²°ì œì—¬ë¶€', 'ê³„ì‚°ì„œë°œí–‰', 'ë¹„ê³ '
            ];

            const dataRows = orderManagementData.map(item => [
                item.registeredDate || '',
                item.vendor || '',
                item.releaseDate || '',
                item.productCode || '',
                item.skuName || '',
                item.productName || '',
                item.quantity || '',
                item.receiverName || '',
                item.receiverPhone || '',
                item.receiverAddr || '',
                item.invoiceNo || '',
                item._shipped ? 'ì™„ë£Œ' : 'ë¯¸ì™„ë£Œ',
                item._paid ? 'ì™„ë£Œ' : 'ë¯¸ì™„ë£Œ',
                item._invoiceIssued ? 'ë°œí–‰' : 'ë¯¸ë°œí–‰',
                item.note || ''
            ]);

            const wsData = [headers, ...dataRows];
            const ws = XLSX.utils.aoa_to_sheet(wsData);

            ws['!cols'] = headers.map(() => ({ wch: 15 }));
            ws['!cols'][5] = { wch: 30 };  // ìƒí’ˆëª…
            ws['!cols'][9] = { wch: 50 };  // ìˆ˜ë ¹ì¸ì£¼ì†Œ

            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'ì „ì²´ì£¼ë¬¸ê´€ë¦¬');

            const fileName = `ì „ì²´ì£¼ë¬¸ê´€ë¦¬_${formatDate(new Date())}.xlsx`;
            XLSX.writeFile(wb, fileName);

            showStatus(orderManagementStatus, `${orderManagementData.length}ê±´ì˜ ë°ì´í„°ë¥¼ ë‹¤ìš´ë¡œë“œí–ˆìŠµë‹ˆë‹¤.`, 'success');
        }

        // Bíƒ€ì… ì–‘ì‹ ë‹¤ìš´ë¡œë“œ (ì „ì²´ì£¼ë¬¸ê´€ë¦¬)
        function handleOrderBTypeDownload() {
            const selectedData = orderManagementData.filter(item => item._selected);

            if (selectedData.length === 0) {
                showStatus(orderManagementStatus, 'Bíƒ€ì… ë‹¤ìš´ë¡œë“œí•  í•­ëª©ì„ ì„ íƒí•´ì£¼ì„¸ìš”.', 'error');
                return;
            }

            // ì´ë¯¸ ë‹¤ìš´ë¡œë“œ ë°›ì€ í•­ëª© í™•ì¸
            const alreadyDownloaded = selectedData.filter(item => item._bTypeDownloaded);
            if (alreadyDownloaded.length > 0) {
                const confirmed = confirm(`ì„ íƒí•œ í•­ëª© ì¤‘ ${alreadyDownloaded.length}ê±´ì€ ì´ë¯¸ Bíƒ€ì… íŒŒì¼ì„ ë‹¤ìš´ë¡œë“œ ë°›ì€ í•­ëª©ì…ë‹ˆë‹¤.\n\në‹¤ì‹œ ë‹¤ìš´ë¡œë“œ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`);
                if (!confirmed) {
                    return;
                }
            }

            // Bíƒ€ì… ì–‘ì‹ ë‹¤ìš´ë¡œë“œ
            downloadLogenExcel(selectedData);

            // ë‹¤ìš´ë¡œë“œ ì™„ë£Œ í‘œì‹œ
            selectedData.forEach(item => {
                item._bTypeDownloaded = true;
            });
            saveOrderManagementData();

            showStatus(orderManagementStatus, `${selectedData.length}ê±´ì„ Bíƒ€ì… ì–‘ì‹ìœ¼ë¡œ ë‹¤ìš´ë¡œë“œí–ˆìŠµë‹ˆë‹¤.`, 'success');
        }

        // ë°œì£¼ì²˜ë³„ ì–‘ì‹ ë‹¤ìš´ë¡œë“œ (ì „ì²´ì£¼ë¬¸ê´€ë¦¬)
        function handleOrderVendorDownload() {
            const selectedData = orderManagementData.filter(item => item._selected);

            if (selectedData.length === 0) {
                showStatus(orderManagementStatus, 'ë‹¤ìš´ë¡œë“œí•  í•­ëª©ì„ ì„ íƒí•´ì£¼ì„¸ìš”.', 'error');
                return;
            }

            // ê¸°ë³¸ì–‘ì‹ë„ ì—†ê³  ë°œì£¼ì²˜ë³„ í…œí”Œë¦¿ë„ ì—†ëŠ” ê²½ìš° ì²´í¬
            const hasDefaultTemplate = vendorTemplates['__default__'] && vendorTemplates['__default__'].columns && vendorTemplates['__default__'].columns.length > 0;

            // ë°œì£¼ì²˜ë³„ë¡œ ê·¸ë£¹í•‘
            const vendorGroups = {};
            selectedData.forEach(item => {
                const vendor = item.vendor || 'ë¯¸ì§€ì •';
                if (!vendorGroups[vendor]) {
                    vendorGroups[vendor] = [];
                }
                vendorGroups[vendor].push(item);
            });

            const vendorList = Object.keys(vendorGroups).sort((a, b) => a.localeCompare(b, 'ko'));

            // í…œí”Œë¦¿ì´ ì—†ëŠ” ë°œì£¼ì²˜ í™•ì¸ (ê¸°ë³¸ì–‘ì‹ë„ ì—†ëŠ” ê²½ìš°ë§Œ)
            if (!hasDefaultTemplate) {
                const noTemplateVendors = vendorList.filter(v => !vendorTemplates[v]);
                if (noTemplateVendors.length > 0) {
                    const message = `ë‹¤ìŒ ë°œì£¼ì²˜ì˜ ì—‘ì…€ í…œí”Œë¦¿ì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤:\n\n${noTemplateVendors.join('\n')}\n\nê±°ë˜ì²˜ë³„ íƒë°°ê´€ë¦¬ì—ì„œ ê¸°ë³¸ì–‘ì‹ ë˜ëŠ” ë°œì£¼ì²˜ë³„ í…œí”Œë¦¿ì„ ì„¤ì •í•´ì£¼ì„¸ìš”.`;
                    alert(message);
                    return;
                }
            }

            // ë°œì£¼ì²˜ë³„ë¡œ ë‹¤ìš´ë¡œë“œ
            let downloadCount = 0;
            vendorList.forEach(vendor => {
                const data = vendorGroups[vendor];
                if (downloadVendorExcel(vendor, data)) {
                    downloadCount++;
                }
            });

            if (downloadCount > 0) {
                showStatus(orderManagementStatus, `${downloadCount}ê°œ ë°œì£¼ì²˜ì˜ ì—‘ì…€ íŒŒì¼ì„ ë‹¤ìš´ë¡œë“œí–ˆìŠµë‹ˆë‹¤.`, 'success');
            }
        }

        // ì†¡ì¥ë²ˆí˜¸ ì—‘ì…€ ì—…ë¡œë“œ ì²˜ë¦¬
        function handleInvoiceUpload() {
            const fileInput = document.getElementById('invoice-file-input');
            const file = fileInput.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const workbook = XLSX.read(e.target.result, { type: 'array' });
                    const sheetName = workbook.SheetNames[0];
                    const sheet = workbook.Sheets[sheetName];
                    const data = XLSX.utils.sheet_to_json(sheet, { header: 1 });

                    if (data.length < 2) {
                        alert('ì—‘ì…€ íŒŒì¼ì— ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                        fileInput.value = '';
                        return;
                    }

                    // í—¤ë” í–‰ ìë™ íƒìƒ‰ (ì²˜ìŒ 20í–‰ ë‚´ì—ì„œ ì°¾ê¸°)
                    let headerRowIdx = -1;
                    let headers = [];
                    const HEADER_KEYWORDS = ['ì†¡ì¥ë²ˆí˜¸', 'ìš´ì†¡ì¥ë²ˆí˜¸', 'ì†¡ì¥', 'ìš´ì†¡ì¥', 'ì£¼ë¬¸ë²ˆí˜¸', 'ìˆ˜í•˜ì¸', 'ì†¡í•˜ì¸', 'ì§‘í•˜', 'ë°°ì†¡ì—¬ë¶€'];

                    for (let rowIdx = 0; rowIdx < Math.min(20, data.length); rowIdx++) {
                        const row = data[rowIdx];
                        if (!row || row.length === 0) continue;

                        const rowText = row.map(c => String(c || '').trim().toLowerCase()).join(' ');
                        // í•µì‹¬ í‚¤ì›Œë“œê°€ 2ê°œ ì´ìƒ í¬í•¨ëœ í–‰ì„ í—¤ë”ë¡œ ì¸ì‹
                        const matchCount = HEADER_KEYWORDS.filter(kw => rowText.includes(kw)).length;
                        if (matchCount >= 2) {
                            headerRowIdx = rowIdx;
                            headers = row.map(h => String(h || '').trim().toLowerCase());
                            break;
                        }
                    }

                    if (headerRowIdx === -1) {
                        alert('í—¤ë” í–‰ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\nì—‘ì…€ íŒŒì¼ì— "ì†¡ì¥ë²ˆí˜¸", "ìš´ì†¡ì¥ë²ˆí˜¸", "ì£¼ë¬¸ë²ˆí˜¸" ë“±ì˜ ì»¬ëŸ¼ì´ ìˆëŠ”ì§€ í™•ì¸í•´ì£¼ì„¸ìš”.');
                        fileInput.value = '';
                        return;
                    }

                    // ì»¬ëŸ¼ ì¸ë±ìŠ¤ ì°¾ê¸°
                    let invoiceColIdx = -1;      // ì†¡ì¥ë²ˆí˜¸
                    let reprintInvoiceColIdx = -1; // ì¬ì¶œë ¥ìš´ì†¡ì¥ë²ˆí˜¸
                    let pickupColIdx = -1;       // ì§‘í•˜ì—¬ë¶€
                    let orderNoColIdx = -1;      // ì£¼ë¬¸ë²ˆí˜¸
                    let deliveryNoColIdx = -1;   // ë°°ì†¡ë²ˆí˜¸ (ì¶”ê°€ì˜µì…˜)
                    let receiverColIdx = -1;     // ìˆ˜í•˜ì¸(ìˆ˜ë ¹ì¸)
                    let senderColIdx = -1;       // ì†¡í•˜ì¸(ë°œì†¡ì¸)
                    let senderPhoneColIdx = -1;  // ë°œì†¡ì¸ì—°ë½ì²˜
                    let senderAddrColIdx = -1;   // ë°œì†¡ì¸ì£¼ì†Œ

                    for (let i = 0; i < headers.length; i++) {
                        const h = headers[i];
                        // ì¬ì¶œë ¥ìš´ì†¡ì¥ë²ˆí˜¸ (ìš°ì„  í™•ì¸)
                        if (reprintInvoiceColIdx === -1 && h.includes('ì¬ì¶œë ¥') && ['ì†¡ì¥', 'ìš´ì†¡ì¥'].some(k => h.includes(k))) {
                            reprintInvoiceColIdx = i;
                        }
                        // ì†¡ì¥ë²ˆí˜¸ (ë°°ì†¡ë²ˆí˜¸ëŠ” ì†¡ì¥/ìš´ì†¡ì¥ê³¼ í•¨ê»˜ ìˆì„ ë•Œë§Œ)
                        if (invoiceColIdx === -1 && !h.includes('ì¬ì¶œë ¥')) {
                            if (['ì†¡ì¥ë²ˆí˜¸', 'ìš´ì†¡ì¥ë²ˆí˜¸', 'ìš´ì†¡ì¥', 'ì†¡ì¥'].some(k => h.includes(k))) {
                                invoiceColIdx = i;
                            }
                        }
                        // ì§‘í•˜ì—¬ë¶€
                        if (pickupColIdx === -1 && ['ì§‘í•˜ì—¬ë¶€', 'ì§‘í•˜', 'í”½ì—…'].some(k => h.includes(k))) {
                            pickupColIdx = i;
                        }
                        // ì£¼ë¬¸ë²ˆí˜¸
                        if (orderNoColIdx === -1 && ['ì£¼ë¬¸ë²ˆí˜¸', 'ê³ ê°ì£¼ë¬¸ë²ˆí˜¸'].some(k => h.includes(k))) {
                            orderNoColIdx = i;
                        }
                        // ë°°ì†¡ë²ˆí˜¸ (ì¶”ê°€ì˜µì…˜) - ì†¡ì¥ë²ˆí˜¸/ìš´ì†¡ì¥ë²ˆí˜¸ì™€ êµ¬ë¶„
                        if (deliveryNoColIdx === -1 && !['ì†¡ì¥', 'ìš´ì†¡ì¥'].some(k => h.includes(k))) {
                            if (['ì¶”ê°€ì˜µì…˜', 'ë°°ì†¡ë²ˆí˜¸', 'ê³ ê°ë°°ì†¡ë²ˆí˜¸', 'ì£¼ë¬¸ë°°ì†¡ë²ˆí˜¸'].some(k => h.includes(k))) {
                                deliveryNoColIdx = i;
                            }
                        }
                        // ìˆ˜í•˜ì¸(ìˆ˜ë ¹ì¸) - ì£¼ì†Œ, ì—°ë½ì²˜ ì œì™¸
                        if (receiverColIdx === -1 && ['ìˆ˜í•˜ì¸', 'ë°›ëŠ”ë¶„', 'ìˆ˜ë ¹ì¸', 'ìˆ˜ì·¨ì¸'].some(k => h.includes(k)) && !h.includes('ì£¼ì†Œ') && !h.includes('ì—°ë½') && !h.includes('ì „í™”') && !h.includes('íœ´ëŒ€')) {
                            receiverColIdx = i;
                        }
                        // ì†¡í•˜ì¸(ë°œì†¡ì¸) - ì£¼ì†Œ, ì—°ë½ì²˜ ì œì™¸
                        if (senderColIdx === -1 && ['ì†¡í•˜ì¸', 'ë³´ë‚´ëŠ”ë¶„', 'ë°œì†¡ì¸'].some(k => h.includes(k)) && !h.includes('ì£¼ì†Œ') && !h.includes('ì—°ë½') && !h.includes('ì „í™”') && !h.includes('íœ´ëŒ€')) {
                            senderColIdx = i;
                        }
                        // ë°œì†¡ì¸ì—°ë½ì²˜ (ì†¡í•˜ì¸ì—°ë½ì²˜)
                        if (senderPhoneColIdx === -1 && ['ì†¡í•˜ì¸', 'ë³´ë‚´ëŠ”ë¶„', 'ë°œì†¡ì¸'].some(k => h.includes(k)) && ['ì—°ë½', 'ì „í™”', 'íœ´ëŒ€', 'í°', 'hp', 'tel'].some(k => h.toLowerCase().includes(k.toLowerCase()))) {
                            senderPhoneColIdx = i;
                        }
                        // ë°œì†¡ì¸ì£¼ì†Œ (ì†¡í•˜ì¸ì£¼ì†Œ)
                        if (senderAddrColIdx === -1 && ['ì†¡í•˜ì¸', 'ë³´ë‚´ëŠ”ë¶„', 'ë°œì†¡ì¸'].some(k => h.includes(k)) && ['ì£¼ì†Œ', 'ì§€ì—­', 'ì§€ë²ˆ'].some(k => h.includes(k))) {
                            senderAddrColIdx = i;
                        }
                    }

                    if (invoiceColIdx === -1 && reprintInvoiceColIdx === -1) {
                        alert('ì†¡ì¥ë²ˆí˜¸ ì»¬ëŸ¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\nì—‘ì…€ íŒŒì¼ì— "ì†¡ì¥ë²ˆí˜¸", "ìš´ì†¡ì¥ë²ˆí˜¸" ë˜ëŠ” "ì¬ì¶œë ¥ìš´ì†¡ì¥ë²ˆí˜¸" ì»¬ëŸ¼ì´ ìˆëŠ”ì§€ í™•ì¸í•´ì£¼ì„¸ìš”.');
                        fileInput.value = '';
                        return;
                    }

                    // ì§‘í•˜ ì™„ë£Œ ê±´ì´ ìˆëŠ”ì§€ ë¨¼ì € í™•ì¸
                    let hasPickedUpItems = false;
                    let allowUnpickedMatching = false;

                    if (pickupColIdx >= 0) {
                        for (let i = headerRowIdx + 1; i < data.length; i++) {
                            const row = data[i];
                            // ì†¡ì¥ë²ˆí˜¸ê°€ ìˆëŠ” í–‰ë§Œ í™•ì¸
                            let invoiceNo = '';
                            if (reprintInvoiceColIdx >= 0) {
                                invoiceNo = String(row[reprintInvoiceColIdx] || '').trim();
                            }
                            if (!invoiceNo && invoiceColIdx >= 0) {
                                invoiceNo = String(row[invoiceColIdx] || '').trim();
                            }
                            if (!invoiceNo) continue;

                            const pickup = String(row[pickupColIdx] || '').trim().toLowerCase();
                            const isPickedUp = ['â—‹', 'o', 'ì—¬', 'y', 'ì˜ˆ', 'yes', 'true', 'ì™„ë£Œ', '1'].some(v => pickup === v || pickup.includes(v));
                            if (isPickedUp) {
                                hasPickedUpItems = true;
                                break;
                            }
                        }

                        // ì§‘í•˜ì™„ë£Œ ê±´ì´ ì—†ìœ¼ë©´ ì‚¬ìš©ìì—ê²Œ í™•ì¸
                        if (!hasPickedUpItems) {
                            if (confirm('ì§‘í•˜ì™„ë£Œê±´ì´ ì—†ìŠµë‹ˆë‹¤. ë¯¸ì§‘í•˜ê±´ì—ì„œ ì†¡ì¥ì„ ë§¤ì¹­í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                                allowUnpickedMatching = true;
                            } else {
                                fileInput.value = '';
                                return;
                            }
                        }
                    }

                    // ë°ì´í„° ë§¤ì¹­ (í—¤ë” ë‹¤ìŒ í–‰ë¶€í„°)
                    let matchedCount = 0;
                    let skippedCount = 0;  // ì§‘í•˜ ì•ˆëœ ê±´
                    let notMatchedCount = 0;

                    for (let i = headerRowIdx + 1; i < data.length; i++) {
                        const row = data[i];
                        // ì¬ì¶œë ¥ìš´ì†¡ì¥ë²ˆí˜¸ê°€ ìˆìœ¼ë©´ ìš°ì„  ì‚¬ìš©, ì—†ìœ¼ë©´ ì¼ë°˜ ì†¡ì¥ë²ˆí˜¸ ì‚¬ìš©
                        let invoiceNo = '';
                        if (reprintInvoiceColIdx >= 0) {
                            invoiceNo = String(row[reprintInvoiceColIdx] || '').trim();
                        }
                        if (!invoiceNo && invoiceColIdx >= 0) {
                            invoiceNo = String(row[invoiceColIdx] || '').trim();
                        }

                        if (!invoiceNo) continue;  // ì†¡ì¥ë²ˆí˜¸ê°€ ì—†ìœ¼ë©´ ìŠ¤í‚µ

                        // ì§‘í•˜ì—¬ë¶€ í™•ì¸ (ì§‘í•˜ ì™„ë£Œëœ ê²ƒë§Œ ì²˜ë¦¬, ë‹¨ ë¯¸ì§‘í•˜ ë§¤ì¹­ í—ˆìš© ì‹œ ìŠ¤í‚µí•˜ì§€ ì•ŠìŒ)
                        if (pickupColIdx >= 0 && !allowUnpickedMatching) {
                            const pickup = String(row[pickupColIdx] || '').trim().toLowerCase();
                            const isPickedUp = ['â—‹', 'o', 'ì—¬', 'y', 'ì˜ˆ', 'yes', 'true', 'ì™„ë£Œ', '1'].some(v => pickup === v || pickup.includes(v));
                            if (!isPickedUp) {
                                skippedCount++;
                                continue;
                            }
                        }

                        const orderNo = orderNoColIdx >= 0 ? String(row[orderNoColIdx] || '').trim() : '';
                        const deliveryNo = deliveryNoColIdx >= 0 ? String(row[deliveryNoColIdx] || '').trim() : '';
                        const receiverName = receiverColIdx >= 0 ? String(row[receiverColIdx] || '').trim() : '';
                        const senderName = senderColIdx >= 0 ? String(row[senderColIdx] || '').trim() : '';
                        const senderPhone = senderPhoneColIdx >= 0 ? String(row[senderPhoneColIdx] || '').trim() : '';
                        const senderAddr = senderAddrColIdx >= 0 ? String(row[senderAddrColIdx] || '').trim() : '';

                        // ë§¤ì¹­ ì‹œë„
                        let matched = false;
                        for (const order of orderManagementData) {
                            // ì´ë¯¸ ì†¡ì¥ë²ˆí˜¸ê°€ ìˆìœ¼ë©´ ìŠ¤í‚µ
                            if (order.invoiceNo) continue;

                            // 1ìˆœìœ„: ì£¼ë¬¸ë²ˆí˜¸ë¡œ ë§¤ì¹­ (ë°°ì†¡ë²ˆí˜¸ê°€ ìˆìœ¼ë©´ ì¶”ê°€ í™•ì¸)
                            if (orderNo && order.orderNo && order.orderNo === orderNo) {
                                // ë°°ì†¡ë²ˆí˜¸ê°€ ë‘˜ ë‹¤ ìˆìœ¼ë©´ ë°°ì†¡ë²ˆí˜¸ë„ ì¼ì¹˜í•´ì•¼ í•¨
                                if (deliveryNo && order.deliveryNo) {
                                    if (order.deliveryNo === deliveryNo) {
                                        order.invoiceNo = invoiceNo;
                                        order._shipped = true;
                                        matched = true;
                                        matchedCount++;
                                        break;
                                    }
                                    // ë°°ì†¡ë²ˆí˜¸ê°€ ë‹¤ë¥´ë©´ ë‹¤ìŒ ì£¼ë¬¸ìœ¼ë¡œ ê³„ì† ê²€ìƒ‰
                                } else {
                                    // ë°°ì†¡ë²ˆí˜¸ê°€ ì—†ê±°ë‚˜ í•œìª½ë§Œ ìˆìœ¼ë©´ ì£¼ë¬¸ë²ˆí˜¸ë§Œìœ¼ë¡œ ë§¤ì¹­
                                    order.invoiceNo = invoiceNo;
                                    order._shipped = true;
                                    matched = true;
                                    matchedCount++;
                                    break;
                                }
                            }

                            // 2ìˆœìœ„: ì£¼ë¬¸ë²ˆí˜¸ê°€ ì—†ëŠ” ê²½ìš°, ìˆ˜í•˜ì¸ëª… + ë°œì†¡ì¸ëª… + (ë°œì†¡ì¸ì—°ë½ì²˜) ë§¤ì¹­
                            if (!orderNo && receiverName && senderName) {
                                const orderReceiverName = (order.receiverName || '').replace('ë‹˜', '').trim();
                                const orderSenderName = (order.senderName || '').trim();
                                const excelReceiverName = receiverName.replace('ë‹˜', '').trim();
                                const excelSenderName = senderName.replace('ë‹˜', '').trim();

                                if (orderReceiverName === excelReceiverName && orderSenderName === excelSenderName) {
                                    // ë°œì†¡ì¸ì—°ë½ì²˜ê°€ ìˆìœ¼ë©´ ì¶”ê°€ ê²€ì¦
                                    if (senderPhone && order.senderPhone) {
                                        const orderPhone = (order.senderPhone || '').replace(/-/g, '').trim();
                                        const excelPhone = senderPhone.replace(/-/g, '').trim();
                                        if (orderPhone !== excelPhone) {
                                            continue; // ì—°ë½ì²˜ ë¶ˆì¼ì¹˜ì‹œ ë‹¤ìŒ ì£¼ë¬¸ìœ¼ë¡œ
                                        }
                                    }
                                    order.invoiceNo = invoiceNo;
                                    order._shipped = true;
                                    matched = true;
                                    matchedCount++;
                                    break;
                                }
                            }

                            // 3ìˆœìœ„: ë°œì†¡ì¸ì—°ë½ì²˜ + ìˆ˜í•˜ì¸ëª…ìœ¼ë¡œ ë§¤ì¹­ (ì£¼ë¬¸ë²ˆí˜¸, ë°œì†¡ì¸ëª… ì—†ì„ ë•Œ)
                            if (!orderNo && !senderName && senderPhone && receiverName) {
                                const orderReceiverName = (order.receiverName || '').replace('ë‹˜', '').trim();
                                const excelReceiverName = receiverName.replace('ë‹˜', '').trim();
                                const orderPhone = (order.senderPhone || '').replace(/-/g, '').trim();
                                const excelPhone = senderPhone.replace(/-/g, '').trim();

                                if (orderReceiverName === excelReceiverName && orderPhone === excelPhone) {
                                    order.invoiceNo = invoiceNo;
                                    order._shipped = true;
                                    matched = true;
                                    matchedCount++;
                                    break;
                                }
                            }
                        }

                        if (!matched) {
                            notMatchedCount++;
                        }
                    }

                    renderOrderManagement();
                    saveOrderManagementData();

                    // ë””ë²„ê·¸ ì •ë³´
                    console.log('=== ì†¡ì¥ë²ˆí˜¸ ì—…ë¡œë“œ ë””ë²„ê·¸ ===');
                    console.log('í—¤ë” í–‰:', headerRowIdx + 1);
                    console.log('ì»¬ëŸ¼ ì¸ë±ìŠ¤:', {
                        invoiceColIdx,
                        reprintInvoiceColIdx,
                        pickupColIdx,
                        orderNoColIdx,
                        deliveryNoColIdx,
                        receiverColIdx,
                        senderColIdx,
                        senderPhoneColIdx,
                        senderAddrColIdx
                    });
                    console.log('í—¤ë” ë‚´ìš©:', headers);

                    // ì²« 3ê°œ ë°ì´í„° í–‰ ìƒ˜í”Œ ì¶œë ¥
                    console.log('=== ì—…ë¡œë“œ íŒŒì¼ ìƒ˜í”Œ ë°ì´í„° ===');
                    for (let i = headerRowIdx + 1; i < Math.min(headerRowIdx + 4, data.length); i++) {
                        const row = data[i];
                        console.log(`í–‰ ${i+1}:`, {
                            ì†¡ì¥ë²ˆí˜¸: invoiceColIdx >= 0 ? row[invoiceColIdx] : 'N/A',
                            ì¬ì¶œë ¥ì†¡ì¥: reprintInvoiceColIdx >= 0 ? row[reprintInvoiceColIdx] : 'N/A',
                            ì£¼ë¬¸ë²ˆí˜¸: orderNoColIdx >= 0 ? row[orderNoColIdx] : 'N/A',
                            ë°°ì†¡ë²ˆí˜¸: deliveryNoColIdx >= 0 ? row[deliveryNoColIdx] : 'N/A',
                            ìˆ˜í•˜ì¸: receiverColIdx >= 0 ? row[receiverColIdx] : 'N/A',
                            ë°œì†¡ì¸: senderColIdx >= 0 ? row[senderColIdx] : 'N/A',
                            ë°œì†¡ì¸ì—°ë½ì²˜: senderPhoneColIdx >= 0 ? row[senderPhoneColIdx] : 'N/A',
                            ë°œì†¡ì¸ì£¼ì†Œ: senderAddrColIdx >= 0 ? row[senderAddrColIdx] : 'N/A'
                        });
                    }

                    console.log('ì „ì²´ì£¼ë¬¸ê´€ë¦¬ ë°ì´í„° ìˆ˜:', orderManagementData.length);
                    if (orderManagementData.length > 0) {
                        console.log('ì²« ë²ˆì§¸ ì£¼ë¬¸ ë°ì´í„°:', orderManagementData[0]);
                    }

                    let message = `ì†¡ì¥ë²ˆí˜¸ ì—…ë¡œë“œ ì™„ë£Œ: ${matchedCount}ê±´ ë§¤ì¹­`;
                    if (notMatchedCount > 0) {
                        message += `, ${notMatchedCount}ê±´ ë¯¸ë§¤ì¹­`;
                    }
                    if (skippedCount > 0) {
                        message += ` (ì§‘í•˜ ë¯¸ì™„ë£Œ ${skippedCount}ê±´ ì œì™¸)`;
                    }
                    showStatus(orderManagementStatus, message, matchedCount > 0 ? 'success' : 'warning');

                } catch (err) {
                    alert('ì—‘ì…€ íŒŒì¼ì„ ì½ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + err.message);
                }

                fileInput.value = '';  // íŒŒì¼ ì…ë ¥ ì´ˆê¸°í™”
            };

            reader.readAsArrayBuffer(file);
        }

        function saveSkuProducts() {
            // Firebaseì— ì €ì¥ (ê³µí†µ ì„¤ì •)
            database.ref('settings/skuProducts').set(skuProducts);
            // í´ë°±: localStorage
            localStorage.setItem('skuProducts', JSON.stringify(skuProducts));
        }

        function loadSkuProducts() {
            // ë¨¼ì € ê¸°ì¡´ ë°ì´í„° ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹œë„
            migrateOldSkuData();

            const saved = localStorage.getItem('skuProducts');
            if (saved) {
                skuProducts = JSON.parse(saved);
            }
            renderSkuProductsTable();
        }

        function saveVendorMappings() {
            // Firebaseì— ì €ì¥ (ê³µí†µ ì„¤ì •)
            database.ref('settings/vendorMappings').set(vendorMappings)
                .catch(err => console.error('ë°œì£¼ì²˜ ì €ì¥ ì‹¤íŒ¨:', err));
            // í´ë°±: localStorage
            localStorage.setItem('vendorMappings', JSON.stringify(vendorMappings));
            updateVendorSelect();
            renderVendorList();
        }

        function loadVendorMappings() {
            const saved = localStorage.getItem('vendorMappings');
            if (saved) {
                vendorMappings = JSON.parse(saved);
                renderVendorList();
            }
        }

        function saveVendorTemplates() {
            // Firebaseì— ì €ì¥ (ê³µí†µ ì„¤ì •)
            database.ref('settings/vendorTemplates').set(vendorTemplates);
            // í´ë°±: localStorage
            localStorage.setItem('vendorTemplates', JSON.stringify(vendorTemplates));
        }

        function loadVendorTemplates() {
            const saved = localStorage.getItem('vendorTemplates');
            if (saved) {
                vendorTemplates = JSON.parse(saved);
            }
        }

        // ê¸°ì¡´ skuDataë¥¼ ìƒˆ í˜•ì‹ìœ¼ë¡œ ë§ˆì´ê·¸ë ˆì´ì…˜
        function migrateOldSkuData() {
            const oldData = localStorage.getItem('skuData');
            const alreadyMigrated = localStorage.getItem('skuDataMigrated');

            if (oldData && !alreadyMigrated) {
                try {
                    const oldSkuData = JSON.parse(oldData);
                    const skuNameToId = {};

                    // 1. SKU ìƒí’ˆ ì¶”ì¶œ (ì¤‘ë³µ ì œê±°) - íŒë§¤ê°€ ì œì™¸
                    Object.keys(oldSkuData).forEach(vendor => {
                        oldSkuData[vendor].forEach(sku => {
                            if (!skuNameToId[sku.skuName]) {
                                const id = Date.now().toString() + Math.random().toString(36).substr(2, 9);
                                skuProducts.push({
                                    id,
                                    skuName: sku.skuName,
                                    packaging: sku.packaging || '',
                                    composition: sku.composition || []
                                });
                                skuNameToId[sku.skuName] = id;
                            }
                        });
                    });

                    // 2. ê±°ë˜ì²˜ë³„ ë§¤ì¹­ ìƒì„± (originalNameì„ productCodeë¡œ ì‚¬ìš©, íŒë§¤ê°€ í¬í•¨)
                    Object.keys(oldSkuData).forEach(vendor => {
                        vendorMappings[vendor] = [];
                        oldSkuData[vendor].forEach(sku => {
                            vendorMappings[vendor].push({
                                productCode: sku.originalName,
                                skuProductId: skuNameToId[sku.skuName],
                                sellingPrice: sku.sellingPrice || 0
                            });
                        });
                    });

                    // 3. ìƒˆ í˜•ì‹ìœ¼ë¡œ ì €ì¥
                    saveSkuProducts();
                    saveVendorMappings();

                    // 4. ë§ˆì´ê·¸ë ˆì´ì…˜ ì™„ë£Œ í‘œì‹œ
                    localStorage.setItem('skuDataMigrated', 'true');

                    console.log('ê¸°ì¡´ SKU ë°ì´í„°ë¥¼ ìƒˆ í˜•ì‹ìœ¼ë¡œ ë§ˆì´ê·¸ë ˆì´ì…˜ ì™„ë£Œ');
                } catch (err) {
                    console.error('SKU ë°ì´í„° ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹¤íŒ¨:', err);
                }
            }
        }

        function saveCostData() {
            // Firebaseì— ì €ì¥ (ê³µí†µ ì„¤ì •)
            database.ref('settings/partsData').set(partsData);
            database.ref('settings/packagingData').set(packagingData);
            // í´ë°±: localStorage
            localStorage.setItem('partsData', JSON.stringify(partsData));
            localStorage.setItem('packagingData', JSON.stringify(packagingData));
        }

        function loadCostData() {
            const savedParts = localStorage.getItem('partsData');
            const savedPackaging = localStorage.getItem('packagingData');
            if (savedParts) partsData = JSON.parse(savedParts);
            if (savedPackaging) packagingData = JSON.parse(savedPackaging);
        }

        // ==================== ë°œì£¼ì²˜ë³„ ì—‘ì…€ í…œí”Œë¦¿ ====================

        // ì‚¬ìš© ê°€ëŠ¥í•œ ì—‘ì…€ ì»¬ëŸ¼ ì •ì˜
        const AVAILABLE_TEMPLATE_COLUMNS = [
            { key: 'skuName', name: 'SKUìƒí’ˆëª…', default: true },
            { key: 'productName', name: 'ìƒí’ˆëª…', default: false },
            { key: 'productCode', name: 'ìƒí’ˆì½”ë“œ', default: false },
            { key: 'quantity', name: 'ìˆ˜ëŸ‰', default: true },
            { key: 'receiverName', name: 'ìˆ˜ë ¹ì¸', default: true },
            { key: 'receiverPhone', name: 'ìˆ˜ë ¹ì¸ì—°ë½ì²˜', default: true },
            { key: 'receiverAddr', name: 'ìˆ˜ë ¹ì¸ì£¼ì†Œ', default: true },
            { key: 'memo', name: 'ë°°ì†¡ë©”ëª¨', default: true },
            { key: 'orderNo', name: 'ì£¼ë¬¸ë²ˆí˜¸', default: true },
            { key: 'deliveryNo', name: 'ë°°ì†¡ë²ˆí˜¸', default: false },
            { key: 'invoiceNo', name: 'ì†¡ì¥ë²ˆí˜¸', default: false },
            { key: 'senderName', name: 'ë°œì†¡ì¸', default: false },
            { key: 'senderPhone', name: 'ë°œì†¡ì¸ì—°ë½ì²˜', default: false },
            { key: 'senderAddr', name: 'ë°œì†¡ì¸ì£¼ì†Œ', default: false },
            { key: 'releaseDate', name: 'ì¶œê³ ìš”ì²­ì¼', default: false },
            { key: 'vendor', name: 'ë°œì£¼ì²˜', default: false },
            { key: 'registeredDate', name: 'ë“±ë¡ì¼', default: false },
            { key: '__blank1__', name: '(ê³µë°±1)', default: false, isBlank: true },
            { key: '__blank2__', name: '(ê³µë°±2)', default: false, isBlank: true },
            { key: '__blank3__', name: '(ê³µë°±3)', default: false, isBlank: true },
            { key: '__blank4__', name: '(ê³µë°±4)', default: false, isBlank: true },
            { key: '__blank5__', name: '(ê³µë°±5)', default: false, isBlank: true }
        ];

        function updateTemplateVendorSelect() {
            const select = document.getElementById('template-vendor-select');
            if (!select) return;

            const vendors = Object.keys(vendorMappings).sort((a, b) => a.localeCompare(b, 'ko'));
            select.innerHTML = '<option value="">ì„ íƒí•˜ì„¸ìš”...</option>';

            // ê¸°ë³¸ì–‘ì‹ ì˜µì…˜ ì¶”ê°€
            const hasDefaultTemplate = vendorTemplates['__default__'] ? ' (ì„¤ì •ë¨)' : '';
            select.innerHTML += `<option value="__default__">ğŸ“‹ ê¸°ë³¸ì–‘ì‹${hasDefaultTemplate}</option>`;

            // ë°œì£¼ì²˜ë³„ ì˜µì…˜ ì¶”ê°€
            vendors.forEach(vendor => {
                const hasTemplate = vendorTemplates[vendor] ? ' (í…œí”Œë¦¿ ìˆìŒ)' : '';
                select.innerHTML += `<option value="${escapeHtml(vendor)}">${escapeHtml(vendor)}${hasTemplate}</option>`;
            });
        }

        function loadTemplateForVendor() {
            const vendor = document.getElementById('template-vendor-select').value;
            if (!vendor) {
                document.getElementById('template-editor').style.display = 'none';
                return;
            }

            document.getElementById('template-editor').style.display = 'block';

            const isDefault = vendor === '__default__';
            const template = vendorTemplates[vendor] || {
                fileName: isDefault ? 'ë°œì£¼ì„œ' : `${vendor}_ë°œì£¼ì„œ`,
                columns: AVAILABLE_TEMPLATE_COLUMNS.filter(c => c.default).map(c => c.key),
                blankNames: {}
            };

            document.getElementById('template-filename').value = template.fileName || (isDefault ? 'ë°œì£¼ì„œ' : `${vendor}_ë°œì£¼ì„œ`);
            renderTemplateColumns(template.columns || [], template.blankNames || {});
        }

        function renderTemplateColumns(selectedColumns, blankNames = {}) {
            const container = document.getElementById('template-columns');
            container.innerHTML = '';

            // ì„ íƒëœ ì»¬ëŸ¼ ìˆœì„œëŒ€ë¡œ ë¨¼ì € ë Œë”ë§
            const orderedColumns = [];
            selectedColumns.forEach(key => {
                const col = AVAILABLE_TEMPLATE_COLUMNS.find(c => c.key === key);
                if (col) orderedColumns.push({ ...col, checked: true });
            });

            // ì„ íƒë˜ì§€ ì•Šì€ ì»¬ëŸ¼ ì¶”ê°€
            AVAILABLE_TEMPLATE_COLUMNS.forEach(col => {
                if (!selectedColumns.includes(col.key)) {
                    orderedColumns.push({ ...col, checked: false });
                }
            });

            // ë“œë˜ê·¸ ìƒíƒœ ê´€ë¦¬
            let draggedItem = null;

            orderedColumns.forEach((col, index) => {
                const div = document.createElement('div');
                div.className = 'template-column-item';
                div.dataset.key = col.key;
                div.style.cssText = 'display: flex; align-items: center; padding: 8px 12px; background: #fff; border: 1px solid #ddd; border-radius: 4px; margin-bottom: 6px; user-select: none;';

                // ê³µë°± ì»¬ëŸ¼ì€ í—¤ë”ëª… ì…ë ¥ ê°€ëŠ¥
                if (col.isBlank) {
                    const customName = blankNames[col.key] || '';
                    div.innerHTML = `
                        <span class="drag-handle" style="cursor: grab; margin-right: 10px; color: #888; font-size: 16px;">â˜°</span>
                        <input type="checkbox" class="template-col-check" data-key="${col.key}" ${col.checked ? 'checked' : ''} style="margin-right: 10px;">
                        <span style="color: #888; margin-right: 8px; white-space: nowrap;">${col.name}</span>
                        <input type="text" class="template-blank-name" data-key="${col.key}" value="${escapeHtml(customName)}" placeholder="í—¤ë”ëª… ì…ë ¥" style="flex: 1; padding: 4px 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px;">
                    `;
                } else {
                    div.innerHTML = `
                        <span class="drag-handle" style="cursor: grab; margin-right: 10px; color: #888; font-size: 16px;">â˜°</span>
                        <input type="checkbox" class="template-col-check" data-key="${col.key}" ${col.checked ? 'checked' : ''} style="margin-right: 10px;">
                        <span style="flex: 1;">${col.name}</span>
                    `;
                }

                // ë“œë˜ê·¸ í•¸ë“¤ì— ë“œë˜ê·¸ ì´ë²¤íŠ¸ ì„¤ì •
                const handle = div.querySelector('.drag-handle');

                handle.addEventListener('mousedown', (e) => {
                    e.preventDefault();
                    draggedItem = div;
                    div.style.opacity = '0.5';
                    div.style.background = '#e3f2fd';
                });

                div.addEventListener('mouseenter', (e) => {
                    if (draggedItem && draggedItem !== div) {
                        div.style.borderTop = '3px solid #3498db';
                    }
                });

                div.addEventListener('mouseleave', (e) => {
                    div.style.borderTop = '';
                });

                div.addEventListener('mouseup', (e) => {
                    if (draggedItem && draggedItem !== div) {
                        // ë“œë˜ê·¸í•œ ì•„ì´í…œì„ í˜„ì¬ ì•„ì´í…œ ì•ì— ì‚½ì…
                        div.parentNode.insertBefore(draggedItem, div);
                    }
                    div.style.borderTop = '';
                });

                container.appendChild(div);
            });

            // ë§ˆìš°ìŠ¤ì—… ì´ë²¤íŠ¸ë¥¼ documentì—ì„œë„ ì²˜ë¦¬ (ë“œë˜ê·¸ ì¢…ë£Œ)
            const handleMouseUp = () => {
                if (draggedItem) {
                    draggedItem.style.opacity = '1';
                    draggedItem.style.background = '#fff';
                    draggedItem = null;
                    // ëª¨ë“  ì•„ì´í…œì˜ borderTop ì´ˆê¸°í™”
                    container.querySelectorAll('.template-column-item').forEach(item => {
                        item.style.borderTop = '';
                    });
                }
            };

            // ê¸°ì¡´ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì œê±° í›„ ìƒˆë¡œ ë“±ë¡
            document.removeEventListener('mouseup', container._mouseUpHandler);
            container._mouseUpHandler = handleMouseUp;
            document.addEventListener('mouseup', handleMouseUp);
        }

        function saveVendorTemplate() {
            const vendor = document.getElementById('template-vendor-select').value;
            if (!vendor) {
                showStatus(document.getElementById('template-status'), 'ë°œì£¼ì²˜ë¥¼ ì„ íƒí•˜ì„¸ìš”.', 'error');
                return;
            }

            const isDefault = vendor === '__default__';
            const displayName = isDefault ? 'ê¸°ë³¸ì–‘ì‹' : vendor;
            const fileName = document.getElementById('template-filename').value.trim() || (isDefault ? 'ë°œì£¼ì„œ' : `${vendor}_ë°œì£¼ì„œ`);

            // ì²´í¬ëœ ì»¬ëŸ¼ì„ ìˆœì„œëŒ€ë¡œ ìˆ˜ì§‘
            const columns = [];
            document.querySelectorAll('.template-column-item').forEach(item => {
                const checkbox = item.querySelector('.template-col-check');
                if (checkbox && checkbox.checked) {
                    columns.push(checkbox.dataset.key);
                }
            });

            // ê³µë°± ì»¬ëŸ¼ ì´ë¦„ ìˆ˜ì§‘
            const blankNames = {};
            document.querySelectorAll('.template-blank-name').forEach(input => {
                const key = input.dataset.key;
                const name = input.value.trim();
                if (name) {
                    blankNames[key] = name;
                }
            });

            if (columns.length === 0) {
                showStatus(document.getElementById('template-status'), 'ìµœì†Œ 1ê°œ ì´ìƒì˜ ì»¬ëŸ¼ì„ ì„ íƒí•˜ì„¸ìš”.', 'error');
                return;
            }

            vendorTemplates[vendor] = { fileName, columns, blankNames };
            saveVendorTemplates();
            updateTemplateVendorSelect();

            showStatus(document.getElementById('template-status'), `"${displayName}" í…œí”Œë¦¿ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.`, 'success');
        }

        function deleteVendorTemplate() {
            const vendor = document.getElementById('template-vendor-select').value;
            if (!vendor) return;

            const isDefault = vendor === '__default__';
            const displayName = isDefault ? 'ê¸°ë³¸ì–‘ì‹' : vendor;

            if (!vendorTemplates[vendor]) {
                showStatus(document.getElementById('template-status'), 'ì €ì¥ëœ í…œí”Œë¦¿ì´ ì—†ìŠµë‹ˆë‹¤.', 'error');
                return;
            }

            if (!confirm(`"${displayName}" í…œí”Œë¦¿ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;

            delete vendorTemplates[vendor];
            saveVendorTemplates();
            updateTemplateVendorSelect();
            document.getElementById('template-editor').style.display = 'none';
            document.getElementById('template-vendor-select').value = '';

            showStatus(document.getElementById('template-status'), 'í…œí”Œë¦¿ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
        }

        // ë°œì£¼ì²˜ë³„ ì—‘ì…€ ë‹¤ìš´ë¡œë“œ
        function downloadVendorExcel(vendor, data) {
            // ë°œì£¼ì²˜ë³„ í…œí”Œë¦¿ì´ ì—†ìœ¼ë©´ ê¸°ë³¸ì–‘ì‹ ì‚¬ìš©
            let template = vendorTemplates[vendor];
            let usedTemplateName = vendor;

            if (!template || !template.columns || template.columns.length === 0) {
                template = vendorTemplates['__default__'];
                usedTemplateName = 'ê¸°ë³¸ì–‘ì‹';
            }

            if (!template || !template.columns || template.columns.length === 0) {
                alert(`"${vendor}" ë°œì£¼ì²˜ì˜ ì—‘ì…€ í…œí”Œë¦¿ì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.\nê¸°ë³¸ì–‘ì‹ë„ ì„¤ì •ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤.\n\nê±°ë˜ì²˜ë³„ íƒë°°ê´€ë¦¬ì—ì„œ ê¸°ë³¸ì–‘ì‹ ë˜ëŠ” ë°œì£¼ì²˜ë³„ í…œí”Œë¦¿ì„ ë¨¼ì € ì„¤ì •í•´ì£¼ì„¸ìš”.`);
                return false;
            }

            // í—¤ë” ìƒì„± (ê³µë°± ì»¬ëŸ¼ì€ ì‚¬ìš©ì ì§€ì • ì´ë¦„ ë˜ëŠ” ê¸°ë³¸ ì´ë¦„ ì‚¬ìš©)
            const blankNames = template.blankNames || {};
            const headers = template.columns.map(key => {
                const col = AVAILABLE_TEMPLATE_COLUMNS.find(c => c.key === key);
                if (col && col.isBlank) {
                    // ê³µë°± ì»¬ëŸ¼: ì‚¬ìš©ì ì§€ì • ì´ë¦„ì´ ìˆìœ¼ë©´ ì‚¬ìš©, ì—†ìœ¼ë©´ ê¸°ë³¸ ì´ë¦„
                    return blankNames[key] || col.name;
                }
                return col ? col.name : key;
            });

            // ë°ì´í„° ìƒì„± (ê³µë°± ì»¬ëŸ¼ì€ ë¹ˆ ë¬¸ìì—´ ì¶œë ¥)
            const rows = data.map(item => {
                return template.columns.map(key => {
                    // ê³µë°± ì»¬ëŸ¼ì€ í•­ìƒ ë¹ˆ ë¬¸ìì—´
                    const col = AVAILABLE_TEMPLATE_COLUMNS.find(c => c.key === key);
                    if (col && col.isBlank) {
                        return '';
                    }
                    const value = item[key];
                    if (value === undefined || value === null) return '';
                    if (typeof value === 'boolean') return value ? 'ì™„ë£Œ' : '';
                    return String(value);
                });
            });

            const wsData = [headers, ...rows];
            const ws = XLSX.utils.aoa_to_sheet(wsData);

            // ì»¬ëŸ¼ ë„ˆë¹„ ì„¤ì •
            ws['!cols'] = headers.map((h, i) => {
                const key = template.columns[i];
                if (key === 'receiverAddr' || key === 'senderAddr') return { wch: 50 };
                if (key === 'skuName' || key === 'productName') return { wch: 30 };
                return { wch: 15 };
            });

            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'ë°œì£¼ì„œ');

            // ê¸°ë³¸ì–‘ì‹ ì‚¬ìš© ì‹œ ë°œì£¼ì²˜ëª…ì„ íŒŒì¼ëª…ì— ì‚¬ìš©
            let fileName;
            if (usedTemplateName === 'ê¸°ë³¸ì–‘ì‹') {
                fileName = `${vendor}_ë°œì£¼ì„œ_${formatDate(new Date())}.xlsx`;
            } else {
                fileName = `${template.fileName}_${formatDate(new Date())}.xlsx`;
            }
            XLSX.writeFile(wb, fileName);

            return true;
        }

        // ==================== ë‹¬ë ¥ ë° ë°œì£¼ëŸ‰ ê³„ì‚° ====================

        // íŠ¹ì • ë‚ ì§œì˜ ì „ì²´ì£¼ë¬¸ê´€ë¦¬ ì£¼ë¬¸ ê°€ì ¸ì˜¤ê¸° (ëª¨ë“  ì‚¬ìš©ì í†µí•©)
        function getOrdersForDate(dateKey) {
            // ëª¨ë“  ì‚¬ìš©ìì˜ ì£¼ë¬¸ ë°ì´í„° í†µí•©
            let allOrders = [];

            Object.keys(allUsersData).forEach(userId => {
                const userData = allUsersData[userId];
                if (!userData || !userData.orderManagementData) return;

                const userOrders = userData.orderManagementData
                    .filter(item => item.releaseDate === dateKey && !item._shipped)
                    .map(item => {
                        const skuNameClean = (item.skuName || item.productName || '').replace(/ - \d+ê°œ$/, '');
                        let sku = null;
                        if (item._skuProductId) {
                            sku = skuProducts.find(p => p.id === item._skuProductId);
                        }
                        if (!sku && skuNameClean) {
                            sku = skuProducts.find(p => p.skuName === skuNameClean);
                        }
                        return {
                            vendor: item.vendor || '',
                            skuName: skuNameClean,
                            skuData: sku,
                            quantity: parseInt(item.quantity) || 1,
                            originalQuantity: parseInt(item._originalQuantity || item.quantity) || 1,
                            receiverName: item.receiverName || '',
                            _shipped: item._shipped,
                            _userId: userId  // ì‚¬ìš©ì ì •ë³´ ì¶”ê°€
                        };
                    });

                allOrders = allOrders.concat(userOrders);
            });

            return allOrders;
        }

        function renderCalendar() {
            const firstDay = new Date(currentYear, currentMonth, 1);
            const lastDay = new Date(currentYear, currentMonth + 1, 0);
            const prevLastDay = new Date(currentYear, currentMonth, 0);
            const firstDayOfWeek = firstDay.getDay();
            const lastDate = lastDay.getDate();
            const prevLastDate = prevLastDay.getDate();

            document.getElementById('calendar-title').textContent = `${currentYear}ë…„ ${currentMonth + 1}ì›”`;

            const grid = document.getElementById('calendar-grid');
            grid.innerHTML = '';

            const days = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];
            days.forEach((day, index) => {
                const header = document.createElement('div');
                header.className = 'calendar-day-header';
                if (index === 0) header.classList.add('sunday');
                if (index === 6) header.classList.add('saturday');
                header.textContent = day;
                grid.appendChild(header);
            });

            for (let i = firstDayOfWeek - 1; i >= 0; i--) {
                const day = prevLastDate - i;
                const cell = createDayCell(currentYear, currentMonth - 1, day, true);
                grid.appendChild(cell);
            }

            for (let day = 1; day <= lastDate; day++) {
                const cell = createDayCell(currentYear, currentMonth, day, false);
                grid.appendChild(cell);
            }

            const totalCells = grid.children.length - 7;
            const remainingCells = 42 - totalCells;
            for (let day = 1; day <= remainingCells; day++) {
                const cell = createDayCell(currentYear, currentMonth + 1, day, true);
                grid.appendChild(cell);
            }
        }

        function createDayCell(year, month, day, isOtherMonth) {
            const cell = document.createElement('div');
            cell.className = 'calendar-day';

            const date = new Date(year, month, day);
            const dateKey = formatDateKey(date);
            const dayOfWeek = date.getDay();

            if (isOtherMonth) cell.classList.add('other-month');
            if (dayOfWeek === 0) cell.classList.add('sunday');
            if (dayOfWeek === 6) cell.classList.add('saturday');

            const today = new Date();
            if (date.toDateString() === today.toDateString()) {
                cell.classList.add('today');
            }

            const numberDiv = document.createElement('div');
            numberDiv.className = 'calendar-day-number';
            numberDiv.textContent = day;
            cell.appendChild(numberDiv);

            const ordersDiv = document.createElement('div');
            ordersDiv.className = 'calendar-day-orders';

            const allOrders = getOrdersForDate(dateKey);
            if (allOrders.length > 0) {
                const totalQty = allOrders.reduce((sum, o) => sum + o.quantity, 0);
                const shippedCount = allOrders.filter(o => o._shipped).length;

                if (allOrders.length <= 2) {
                    allOrders.forEach(order => {
                        const item = document.createElement('div');
                        item.className = 'calendar-order-item';
                        item.classList.add(order._shipped ? 'shipped' : 'pending');
                        item.textContent = `${order.skuName} x${order.quantity}`;
                        ordersDiv.appendChild(item);
                    });
                } else {
                    const countDiv = document.createElement('div');
                    const statusText = shippedCount === allOrders.length ? ' âœ“' : ` (${shippedCount}/${allOrders.length}ì¶œê³ )`;
                    countDiv.innerHTML = `<span class="calendar-order-count">${allOrders.length}ê±´ (${totalQty}ê°œ)${statusText}</span>`;
                    ordersDiv.appendChild(countDiv);
                }
            }

            cell.appendChild(ordersDiv);
            cell.onclick = () => openDayModal(dateKey);

            return cell;
        }

        function formatDateKey(date) {
            const y = date.getFullYear();
            const m = String(date.getMonth() + 1).padStart(2, '0');
            const d = String(date.getDate()).padStart(2, '0');
            return `${y}-${m}-${d}`;
        }

        function changeMonth(delta) {
            currentMonth += delta;
            if (currentMonth < 0) {
                currentMonth = 11;
                currentYear--;
            } else if (currentMonth > 11) {
                currentMonth = 0;
                currentYear++;
            }
            renderCalendar();
        }
        window.changeMonth = changeMonth;

        function goToToday() {
            currentYear = new Date().getFullYear();
            currentMonth = new Date().getMonth();
            renderCalendar();
        }
        window.goToToday = goToToday;

        function openDayModal(dateKey) {
            selectedDate = dateKey;
            const [year, month, day] = dateKey.split('-');
            document.getElementById('day-modal-title').textContent = `${year}ë…„ ${parseInt(month)}ì›” ${parseInt(day)}ì¼`;
            document.getElementById('day-calculation-result').innerHTML = '';

            renderDayOrders();
            document.getElementById('day-modal').classList.add('show');
        }

        function closeDayModal() {
            document.getElementById('day-modal').classList.remove('show');
            selectedDate = null;
        }
        window.closeDayModal = closeDayModal;

        function renderDayOrders() {
            const container = document.getElementById('day-orders-list');
            const orders = getOrdersForDate(selectedDate);

            if (orders.length === 0) {
                container.innerHTML = '<div class="empty-state" style="padding: 20px;"><div>ë“±ë¡ëœ ë°°ì†¡ì´ ì—†ìŠµë‹ˆë‹¤.</div></div>';
                return;
            }

            const html = orders.map(order => `
                <div class="day-order-item" style="background: ${order._shipped ? '#e8f5e9' : '#fff3e0'};">
                    <div class="order-info">
                        <div class="order-name">${escapeHtml(order.vendor)} - ${escapeHtml(order.receiverName)}</div>
                        <div class="order-sku">${escapeHtml(order.skuName)}</div>
                    </div>
                    <div class="order-qty">${order.quantity}</div>
                    <span class="status-badge ${order._shipped ? 'shipped' : 'not-shipped'}" style="font-size: 11px;">${order._shipped ? 'ì¶œê³ ì™„ë£Œ' : 'ë¯¸ì¶œê³ '}</span>
                </div>
            `).join('');

            container.innerHTML = html;
        }

        function calculateDayOrder() {
            const orders = getOrdersForDate(selectedDate);
            if (orders.length === 0) {
                alert('ê³„ì‚°í•  ë°°ì†¡ì´ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            const result = calculateOrders(orders);
            document.getElementById('day-calculation-result').innerHTML = result;
        }
        window.calculateDayOrder = calculateDayOrder;

        function calculateRangeOrder() {
            const startStr = document.getElementById('range-start').value;
            const endStr = document.getElementById('range-end').value;

            if (!startStr || !endStr) {
                alert('ì‹œì‘ì¼ê³¼ ì¢…ë£Œì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }

            const startDate = new Date(startStr);
            const endDate = new Date(endStr);

            if (startDate > endDate) {
                alert('ì‹œì‘ì¼ì´ ì¢…ë£Œì¼ë³´ë‹¤ ëŠ¦ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            const allOrders = [];
            const current = new Date(startDate);

            while (current <= endDate) {
                const dateKey = formatDateKey(current);
                const dayOrders = getOrdersForDate(dateKey);
                allOrders.push(...dayOrders);
                current.setDate(current.getDate() + 1);
            }

            if (allOrders.length === 0) {
                document.getElementById('range-result').innerHTML = '<div class="status show info">ì„ íƒí•œ ê¸°ê°„ì— ë“±ë¡ëœ ë°°ì†¡ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
                return;
            }

            const result = calculateOrders(allOrders);
            document.getElementById('range-result').innerHTML = result;
        }
        window.calculateRangeOrder = calculateRangeOrder;

        function calculateOrders(orders) {
            const partData = {};
            const packagingCount = {};
            const orderSummary = {};

            orders.forEach(item => {
                const sku = item.skuData;
                const displayQty = item.quantity;  // íƒë°° ê±´ìˆ˜ (í•©í¬ì¥ ì ìš©)
                const calcQty = item.originalQuantity || item.quantity;  // ì‹¤ì œ ì£¼ë¬¸ ìˆ˜ëŸ‰ (ë°œì£¼ëŸ‰ ê³„ì‚°ìš©)

                // ì£¼ë¬¸ ìš”ì•½ (ì‹¤ì œ ì£¼ë¬¸ ìˆ˜ëŸ‰ ê¸°ì¤€)
                const key = `${item.vendor}-${item.skuName}`;
                if (!orderSummary[key]) {
                    orderSummary[key] = { vendor: item.vendor, skuName: item.skuName, quantity: 0, skuData: sku };
                }
                orderSummary[key].quantity += calcQty;

                // í¬ì¥ì¬ ì§‘ê³„ (íƒë°° ê±´ìˆ˜ ê¸°ì¤€ - í•©í¬ì¥ì´ë¯€ë¡œ)
                if (sku && sku.packaging) {
                    if (!packagingCount[sku.packaging]) {
                        packagingCount[sku.packaging] = 0;
                    }
                    packagingCount[sku.packaging] += displayQty;
                }

                // ë¶€ìœ„ë³„ ì§‘ê³„ (ì‹¤ì œ ì£¼ë¬¸ ìˆ˜ëŸ‰ ê¸°ì¤€)
                if (sku && sku.composition && sku.composition.length > 0) {
                    sku.composition.forEach(comp => {
                        const partInfo = partsData[comp.part];
                        const partType = partInfo ? (typeof partInfo === 'number' ? 'weight' : (partInfo.type || 'weight')) : 'weight';
                        const partKey = partType === 'unit' ? `${comp.part}-unit` : `${comp.part}-${comp.weight}g`;

                        if (!partData[partKey]) {
                            partData[partKey] = {
                                part: comp.part,
                                weight: comp.weight,
                                type: partType,
                                totalPacks: 0,
                                totalWeight: 0,
                                totalUnits: 0
                            };
                        }
                        partData[partKey].totalPacks += (comp.quantity || 1) * calcQty;
                        if (partType === 'unit') {
                            partData[partKey].totalUnits += (comp.quantity || 1) * calcQty;
                        } else {
                            partData[partKey].totalWeight += comp.weight * (comp.quantity || 1) * calcQty;
                        }
                    });
                }
            });

            let html = '<div class="result-box"><h3>ğŸ“¦ ë°œì£¼ëŸ‰ ê³„ì‚° ê²°ê³¼</h3>';

            // ì£¼ë¬¸ ìš”ì•½ (í…Œì´ë¸” í˜•ì‹)
            html += '<h4>ì£¼ë¬¸ ëª©ë¡</h4>';
            html += `<table style="width: 100%; border-collapse: collapse; background: #fff; color: #000; font-size: 13px;">
                <thead>
                    <tr style="background: #f5f5f5; border-bottom: 2px solid #ddd;">
                        <th style="padding: 8px 10px; text-align: left; border: 1px solid #ddd;">ê±°ë˜ì²˜</th>
                        <th style="padding: 8px 10px; text-align: left; border: 1px solid #ddd;">ìƒí’ˆëª…</th>
                        <th style="padding: 8px 10px; text-align: center; border: 1px solid #ddd;">ìˆ˜ëŸ‰</th>
                        <th style="padding: 8px 10px; text-align: left; border: 1px solid #ddd;">í¬ì¥&êµ¬ì„±</th>
                    </tr>
                </thead>
                <tbody>`;
            Object.values(orderSummary).forEach(item => {
                let packCompText = '-';
                if (item.skuData) {
                    const sku = item.skuData;
                    const packagingName = sku.packaging || '';
                    const compText = sku.composition && sku.composition.length > 0
                        ? sku.composition.map(c => {
                            const partInfo = partsData[c.part];
                            const type = partInfo ? (typeof partInfo === 'number' ? 'weight' : (partInfo.type || 'weight')) : 'weight';
                            const qty = c.quantity || 1;
                            if (type === 'unit') {
                                return `${c.part}${qty}ê°œ`;
                            } else {
                                return `${c.part}${c.weight}g` + (qty > 1 ? `x${qty}` : '');
                            }
                        }).join(', ')
                        : '';
                    packCompText = packagingName ? `[${packagingName}] ${compText}` : (compText || '-');
                }
                html += `<tr style="border-bottom: 1px solid #eee;">
                    <td style="padding: 8px 10px; border: 1px solid #ddd;">${escapeHtml(item.vendor) || '-'}</td>
                    <td style="padding: 8px 10px; border: 1px solid #ddd;">${escapeHtml(item.skuName) || '-'}</td>
                    <td style="padding: 8px 10px; text-align: center; border: 1px solid #ddd; font-weight: 600;">${item.quantity}ê°œ</td>
                    <td style="padding: 8px 10px; border: 1px solid #ddd; color: #333;">${escapeHtml(packCompText)}</td>
                </tr>`;
            });
            html += '</tbody></table>';

            if (Object.keys(partData).length > 0) {
                // ì¤‘ëŸ‰ ê¸°ë°˜ í’ˆëª© í•„í„°ë§
                const weightItems = Object.values(partData).filter(d => d.type !== 'unit');
                const unitItems = Object.values(partData).filter(d => d.type === 'unit');

                // íŒ¨í‚¹ìˆ˜ëŸ‰, ì´ì¤‘ëŸ‰, ê³µì‚°í’ˆìˆ˜ëŸ‰ì„ ê°™ì€ ì¤„ì— ë°°ì¹˜
                html += '<div style="display: flex; gap: 16px; flex-wrap: wrap; margin-bottom: 16px;">';

                // íŒ¨í‚¹ ìˆ˜ëŸ‰ (ì¤‘ëŸ‰ ê¸°ë°˜)
                if (weightItems.length > 0) {
                    html += '<div style="flex: 1; min-width: 200px;">';
                    html += '<h4 style="margin-bottom: 8px;">íŒ¨í‚¹ ìˆ˜ëŸ‰</h4>';
                    html += `<table style="width: 100%; border-collapse: collapse; background: #fff; color: #000; font-size: 13px;">
                        <thead>
                            <tr style="background: #f5f5f5; border-bottom: 2px solid #ddd;">
                                <th style="padding: 6px 8px; text-align: left; border: 1px solid #ddd;">í’ˆëª©</th>
                                <th style="padding: 6px 8px; text-align: center; border: 1px solid #ddd;">ì¤‘ëŸ‰</th>
                                <th style="padding: 6px 8px; text-align: center; border: 1px solid #ddd;">ìˆ˜ëŸ‰</th>
                            </tr>
                        </thead>
                        <tbody>`;
                    weightItems.forEach(data => {
                        html += `<tr style="border-bottom: 1px solid #eee;">
                            <td style="padding: 6px 8px; border: 1px solid #ddd;">${escapeHtml(data.part)}</td>
                            <td style="padding: 6px 8px; text-align: center; border: 1px solid #ddd;">${data.weight}g</td>
                            <td style="padding: 6px 8px; text-align: center; border: 1px solid #ddd; font-weight: 600;">${data.totalPacks}íŒ©</td>
                        </tr>`;
                    });
                    html += '</tbody></table></div>';

                    // ì´ ì¤‘ëŸ‰
                    const partTotals = {};
                    weightItems.forEach(data => {
                        if (!partTotals[data.part]) partTotals[data.part] = 0;
                        partTotals[data.part] += data.totalWeight;
                    });

                    html += '<div style="flex: 1; min-width: 200px;">';
                    html += '<h4 style="margin-bottom: 8px;">ì´ ì¤‘ëŸ‰</h4>';
                    html += `<table style="width: 100%; border-collapse: collapse; background: #fff; color: #000; font-size: 13px;">
                        <thead>
                            <tr style="background: #f5f5f5; border-bottom: 2px solid #ddd;">
                                <th style="padding: 6px 8px; text-align: left; border: 1px solid #ddd;">í’ˆëª©</th>
                                <th style="padding: 6px 8px; text-align: center; border: 1px solid #ddd;">kg</th>
                                <th style="padding: 6px 8px; text-align: center; border: 1px solid #ddd;">g</th>
                            </tr>
                        </thead>
                        <tbody>`;
                    Object.entries(partTotals).forEach(([part, weight]) => {
                        const kg = weight / 1000;
                        html += `<tr style="border-bottom: 1px solid #eee;">
                            <td style="padding: 6px 8px; border: 1px solid #ddd;">${escapeHtml(part)}</td>
                            <td style="padding: 6px 8px; text-align: center; border: 1px solid #ddd; font-weight: 600;">${kg.toFixed(2)}</td>
                            <td style="padding: 6px 8px; text-align: center; border: 1px solid #ddd;">${weight.toLocaleString()}</td>
                        </tr>`;
                    });
                    html += '</tbody></table></div>';
                }

                // ê³µì‚°í’ˆ (ê°œìˆ˜ ê¸°ë°˜)
                if (unitItems.length > 0) {
                    html += '<div style="flex: 1; min-width: 150px;">';
                    html += '<h4 style="margin-bottom: 8px;">ê³µì‚°í’ˆ ìˆ˜ëŸ‰</h4>';
                    html += `<table style="width: 100%; border-collapse: collapse; background: #fff; color: #000; font-size: 13px;">
                        <thead>
                            <tr style="background: #f5f5f5; border-bottom: 2px solid #ddd;">
                                <th style="padding: 6px 8px; text-align: left; border: 1px solid #ddd;">í’ˆëª©</th>
                                <th style="padding: 6px 8px; text-align: center; border: 1px solid #ddd;">ìˆ˜ëŸ‰</th>
                            </tr>
                        </thead>
                        <tbody>`;
                    unitItems.forEach(data => {
                        html += `<tr style="border-bottom: 1px solid #eee;">
                            <td style="padding: 6px 8px; border: 1px solid #ddd;">${escapeHtml(data.part)}</td>
                            <td style="padding: 6px 8px; text-align: center; border: 1px solid #ddd; font-weight: 600;">${data.totalUnits}ê°œ</td>
                        </tr>`;
                    });
                    html += '</tbody></table></div>';
                }

                html += '</div>';
            }

            // í¬ì¥ì¬
            if (Object.keys(packagingCount).length > 0) {
                html += '<h4>í¬ì¥ì¬</h4>';
                html += `<table style="width: 100%; border-collapse: collapse; background: #fff; color: #000; font-size: 13px; margin-bottom: 16px;">
                    <thead>
                        <tr style="background: #f5f5f5; border-bottom: 2px solid #ddd;">
                            <th style="padding: 8px 10px; text-align: left; border: 1px solid #ddd;">í¬ì¥ì¬</th>
                            <th style="padding: 8px 10px; text-align: center; border: 1px solid #ddd;">ìˆ˜ëŸ‰</th>
                        </tr>
                    </thead>
                    <tbody>`;
                Object.entries(packagingCount).forEach(([packaging, count]) => {
                    html += `<tr style="border-bottom: 1px solid #eee;">
                        <td style="padding: 8px 10px; border: 1px solid #ddd;">${escapeHtml(packaging)}</td>
                        <td style="padding: 8px 10px; text-align: center; border: 1px solid #ddd; font-weight: 600;">${count}ê°œ</td>
                    </tr>`;
                });
                html += '</tbody></table>';
            }

            html += '</div>';
            return html;
        }

        // ë³€í™˜í™•ì • íƒ­ ë°œì£¼ëŸ‰ ê³„ì‚°
        function calculateConfirmedOrders() {
            const selectedData = confirmedData.filter(item => item._selected);

            if (selectedData.length === 0) {
                alert('ë°œì£¼ëŸ‰ì„ ê³„ì‚°í•  í•­ëª©ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }

            // ì„ íƒëœ í•­ëª©ì„ calculateOrders í˜•ì‹ìœ¼ë¡œ ë³€í™˜
            const orders = selectedData.map(item => {
                let sku = null;
                if (item._skuProductId) {
                    sku = skuProducts.find(p => p.id === item._skuProductId);
                }
                if (!sku && item.skuName) {
                    sku = skuProducts.find(p => p.skuName === item.skuName);
                }
                return {
                    vendor: item.vendor || '',
                    skuName: item.skuName || item.productName || '',
                    skuData: sku,
                    quantity: parseInt(item.quantity) || 1,
                    originalQuantity: parseInt(item.quantity) || 1  // ë³€í™˜í™•ì •ì€ ì•„ì§ í•©í¬ì¥ ì „ì´ë¯€ë¡œ ë™ì¼
                };
            });

            const result = calculateOrders(orders);
            document.getElementById('calculation-modal-title').textContent = `ë°œì£¼ëŸ‰ ê³„ì‚° ê²°ê³¼ (${selectedData.length}ê±´ ì„ íƒ)`;
            document.getElementById('calculation-modal-content').innerHTML = result;
            document.getElementById('calculation-modal').classList.add('show');
        }

        // ì „ì²´ì£¼ë¬¸ê´€ë¦¬ íƒ­ ë°œì£¼ëŸ‰ ê³„ì‚°
        function calculateOrderManagementOrders() {
            const selectedData = orderManagementData.filter(item => item._selected);

            if (selectedData.length === 0) {
                alert('ë°œì£¼ëŸ‰ì„ ê³„ì‚°í•  í•­ëª©ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }

            // ì„ íƒëœ í•­ëª©ì„ calculateOrders í˜•ì‹ìœ¼ë¡œ ë³€í™˜
            const orders = selectedData.map(item => {
                // í•©í¬ì¥ ì ìš©ëœ ìƒí’ˆëª…ì—ì„œ ì›ë³¸ ìƒí’ˆëª… ì¶”ì¶œ
                const skuNameClean = (item.skuName || item.productName || '').replace(/ - \d+ê°œ$/, '');
                let sku = null;
                if (item._skuProductId) {
                    sku = skuProducts.find(p => p.id === item._skuProductId);
                }
                if (!sku && skuNameClean) {
                    sku = skuProducts.find(p => p.skuName === skuNameClean);
                }
                return {
                    vendor: item.vendor || '',
                    skuName: skuNameClean,  // ì›ë³¸ ìƒí’ˆëª… ì‚¬ìš©
                    skuData: sku,
                    quantity: parseInt(item.quantity) || 1,  // íƒë°° ê±´ìˆ˜ (í•©í¬ì¥ ì ìš©)
                    originalQuantity: parseInt(item._originalQuantity || item.quantity) || 1  // ì‹¤ì œ ì£¼ë¬¸ ìˆ˜ëŸ‰
                };
            });

            const result = calculateOrders(orders);
            document.getElementById('calculation-modal-title').textContent = `ë°œì£¼ëŸ‰ ê³„ì‚° ê²°ê³¼ (${selectedData.length}ê±´ ì„ íƒ)`;
            document.getElementById('calculation-modal-content').innerHTML = result;
            document.getElementById('calculation-modal').classList.add('show');
        }

        function closeCalculationModal() {
            document.getElementById('calculation-modal').classList.remove('show');
        }
        window.closeCalculationModal = closeCalculationModal;

        // ì „ì²´ì£¼ë¬¸ê´€ë¦¬ ì§‘ê³„ ê¸°ëŠ¥
        let aggregateData = []; // ì§‘ê³„ ê²°ê³¼ ì €ì¥ (ì—‘ì…€ ë‹¤ìš´ë¡œë“œìš©)

        function aggregateOrderManagement() {
            const selectedData = orderManagementData.filter(item => item._selected);

            if (selectedData.length === 0) {
                alert('ì§‘ê³„í•  í•­ëª©ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }

            // ë°œì£¼ì²˜ + SKUìƒí’ˆëª…(í•©í¬ì¥ ì „) + ë‹¨ê°€ ê¸°ì¤€ìœ¼ë¡œ ê·¸ë£¹í™”
            const groups = {};
            selectedData.forEach(item => {
                const vendor = item.vendor || '(ë°œì£¼ì²˜ ì—†ìŒ)';

                // í•©í¬ì¥ í˜•ì‹(ì˜ˆ: "êµ­ê±°ë¦¬300g - 4ê°œ")ì—ì„œ ì›ë³¸ SKUëª… ì¶”ì¶œ
                let skuName = item.skuName || item.productName || '(ìƒí’ˆëª… ì—†ìŒ)';
                skuName = skuName.replace(/ - \d+ê°œ$/, '');

                // ë‹¨ê°€ ê³„ì‚° - í…Œì´ë¸”ê³¼ ë™ì¼í•œ fallback ë¡œì§ ì ìš©
                let unitPrice = parseInt(item._unitPrice) || 0;
                if (!unitPrice) {
                    // 1. ê±°ë˜ì²˜ ë§¤í•‘ì—ì„œ ì°¾ê¸°
                    if (item.vendor && item.productCode && vendorMappings[item.vendor]) {
                        const mapping = vendorMappings[item.vendor].find(m => m.productCode === item.productCode);
                        if (mapping && mapping.sellingPrice) {
                            unitPrice = mapping.sellingPrice;
                        }
                    }
                    // 2. SKU ìƒí’ˆì—ì„œ ì°¾ê¸°
                    if (!unitPrice && item._skuProductId) {
                        const sku = skuProducts.find(p => p.id === item._skuProductId);
                        if (sku && sku.sellingPrice) {
                            unitPrice = sku.sellingPrice;
                        }
                    }
                    // 3. SKUëª…ìœ¼ë¡œ ì°¾ê¸° (í•©í¬ì¥ ì „ ì›ë³¸ëª…ìœ¼ë¡œ)
                    if (!unitPrice && skuName) {
                        const sku = skuProducts.find(p => p.skuName === skuName);
                        if (sku && sku.sellingPrice) {
                            unitPrice = sku.sellingPrice;
                        }
                    }
                }

                // í•©í¬ì¥ ì „ ì›ë˜ ìˆ˜ëŸ‰ ì‚¬ìš©
                const originalQty = parseInt(item._originalQuantity || item.quantity) || 1;

                const key = `${vendor}||${skuName}||${unitPrice}`;
                if (!groups[key]) {
                    groups[key] = {
                        vendor: vendor,
                        skuName: skuName,
                        unitPrice: unitPrice,
                        quantity: 0,
                        totalPrice: 0
                    };
                }
                groups[key].quantity += originalQty;
                groups[key].totalPrice += unitPrice * originalQty;
            });

            // ë°°ì—´ë¡œ ë³€í™˜ í›„ ì •ë ¬ (ë°œì£¼ì²˜ > SKUìƒí’ˆëª… > ë‹¨ê°€)
            aggregateData = Object.values(groups).sort((a, b) => {
                if (a.vendor !== b.vendor) return a.vendor.localeCompare(b.vendor, 'ko');
                if (a.skuName !== b.skuName) return a.skuName.localeCompare(b.skuName, 'ko');
                return a.unitPrice - b.unitPrice;
            });

            // ì´í•©ê³„ ê³„ì‚°
            const grandTotalQty = aggregateData.reduce((sum, item) => sum + item.quantity, 0);
            const grandTotalPrice = aggregateData.reduce((sum, item) => sum + item.totalPrice, 0);

            // í…Œì´ë¸” ìƒì„±
            let html = `
                <table style="width: 100%; border-collapse: collapse; font-size: 13px;">
                    <thead>
                        <tr style="background: #f8f9fa;">
                            <th style="padding: 10px; border: 1px solid #dee2e6; text-align: left;">ë°œì£¼ì²˜</th>
                            <th style="padding: 10px; border: 1px solid #dee2e6; text-align: left;">SKUìƒí’ˆëª…</th>
                            <th style="padding: 10px; border: 1px solid #dee2e6; text-align: right;">ìˆ˜ëŸ‰</th>
                            <th style="padding: 10px; border: 1px solid #dee2e6; text-align: right;">ë‹¨ê°€</th>
                            <th style="padding: 10px; border: 1px solid #dee2e6; text-align: right;">ì´í•©ê³„</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            let currentVendor = null;
            aggregateData.forEach(item => {
                const vendorChanged = item.vendor !== currentVendor;
                currentVendor = item.vendor;

                html += `
                    <tr${vendorChanged ? ' style="border-top: 2px solid #adb5bd;"' : ''}>
                        <td style="padding: 8px; border: 1px solid #dee2e6;">${vendorChanged ? escapeHtml(item.vendor) : ''}</td>
                        <td style="padding: 8px; border: 1px solid #dee2e6;">${escapeHtml(item.skuName)}</td>
                        <td style="padding: 8px; border: 1px solid #dee2e6; text-align: right;">${item.quantity.toLocaleString()}</td>
                        <td style="padding: 8px; border: 1px solid #dee2e6; text-align: right;">${item.unitPrice.toLocaleString()}ì›</td>
                        <td style="padding: 8px; border: 1px solid #dee2e6; text-align: right; font-weight: 600;">${item.totalPrice.toLocaleString()}ì›</td>
                    </tr>
                `;
            });

            html += `
                    </tbody>
                    <tfoot>
                        <tr style="background: #e9ecef; font-weight: 700;">
                            <td colspan="2" style="padding: 10px; border: 1px solid #dee2e6; text-align: center;">í•©ê³„</td>
                            <td style="padding: 10px; border: 1px solid #dee2e6; text-align: right;">${grandTotalQty.toLocaleString()}</td>
                            <td style="padding: 10px; border: 1px solid #dee2e6; text-align: right;">-</td>
                            <td style="padding: 10px; border: 1px solid #dee2e6; text-align: right;">${grandTotalPrice.toLocaleString()}ì›</td>
                        </tr>
                    </tfoot>
                </table>
            `;

            document.getElementById('aggregate-modal-title').textContent = `ì§‘ê³„ ê²°ê³¼ (${selectedData.length}ê±´ ì„ íƒ, ${aggregateData.length}ê°œ ê·¸ë£¹)`;
            document.getElementById('aggregate-modal-content').innerHTML = html;
            document.getElementById('aggregate-modal').classList.add('show');
        }

        function closeAggregateModal() {
            document.getElementById('aggregate-modal').classList.remove('show');
        }
        window.closeAggregateModal = closeAggregateModal;

        function downloadAggregateExcel() {
            if (aggregateData.length === 0) {
                alert('ë‹¤ìš´ë¡œë“œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            const rows = [['ë°œì£¼ì²˜', 'SKUìƒí’ˆëª…', 'ìˆ˜ëŸ‰', 'ë‹¨ê°€', 'ì´í•©ê³„']];
            aggregateData.forEach(item => {
                rows.push([
                    item.vendor,
                    item.skuName,
                    item.quantity,
                    item.unitPrice,
                    item.totalPrice
                ]);
            });

            // í•©ê³„ í–‰ ì¶”ê°€
            const grandTotalQty = aggregateData.reduce((sum, item) => sum + item.quantity, 0);
            const grandTotalPrice = aggregateData.reduce((sum, item) => sum + item.totalPrice, 0);
            rows.push(['í•©ê³„', '', grandTotalQty, '', grandTotalPrice]);

            const ws = XLSX.utils.aoa_to_sheet(rows);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'ì§‘ê³„');

            // ì—´ ë„ˆë¹„ ì„¤ì •
            ws['!cols'] = [
                { wch: 20 }, // ë°œì£¼ì²˜
                { wch: 30 }, // SKUìƒí’ˆëª…
                { wch: 10 }, // ìˆ˜ëŸ‰
                { wch: 12 }, // ë‹¨ê°€
                { wch: 15 }  // ì´í•©ê³„
            ];

            const today = formatDateKey(new Date());
            XLSX.writeFile(wb, `ì§‘ê³„_${today}.xlsx`);
        }
        window.downloadAggregateExcel = downloadAggregateExcel;

        // ==================== í†µí•©ì¡°íšŒ ê¸°ëŠ¥ ====================

        // í†µí•©ì¡°íšŒ ìƒˆë¡œê³ ì¹¨
        function refreshIntegratedView() {
            renderIntegratedView();
        }
        window.refreshIntegratedView = refreshIntegratedView;

        // í†µí•©ì¡°íšŒ ë Œë”ë§
        function renderIntegratedView() {
            const tableContainer = document.getElementById('integrated-table');
            const summaryEl = document.getElementById('integrated-summary');

            // ëª¨ë“  ì‚¬ìš©ìì˜ ì£¼ë¬¸ ë°ì´í„° ìˆ˜ì§‘
            let allOrders = [];
            Object.keys(allUsersData).forEach(userId => {
                const userData = allUsersData[userId];
                if (!userData || !userData.orderManagementData) return;

                userData.orderManagementData.forEach((item, idx) => {
                    allOrders.push({
                        ...item,
                        _userId: userId,
                        _userIdx: idx
                    });
                });
            });

            // í•„í„° ì ìš©
            const userFilter = document.getElementById('integrated-user-filter')?.value || '';
            const dateFrom = document.getElementById('integrated-date-from')?.value || '';
            const dateTo = document.getElementById('integrated-date-to')?.value || '';
            const statusFilter = document.getElementById('integrated-status-filter')?.value || '';

            let filteredOrders = allOrders;

            if (userFilter) {
                filteredOrders = filteredOrders.filter(o => o._userId === userFilter);
            }

            if (dateFrom) {
                filteredOrders = filteredOrders.filter(o => o.releaseDate >= dateFrom);
            }

            if (dateTo) {
                filteredOrders = filteredOrders.filter(o => o.releaseDate <= dateTo);
            }

            if (statusFilter === 'pending') {
                filteredOrders = filteredOrders.filter(o => !o._shipped);
            } else if (statusFilter === 'shipped') {
                filteredOrders = filteredOrders.filter(o => o._shipped);
            }

            // ìš”ì•½ ì •ë³´
            const totalCount = filteredOrders.length;
            const pendingCount = filteredOrders.filter(o => !o._shipped).length;
            const shippedCount = filteredOrders.filter(o => o._shipped).length;

            summaryEl.innerHTML = `
                <div class="summary-item"><span class="summary-value">${totalCount}</span><span class="summary-label">ì „ì²´</span></div>
                <div class="summary-item"><span class="summary-value" style="color: var(--warning-color);">${pendingCount}</span><span class="summary-label">ë¯¸ì¶œê³ </span></div>
                <div class="summary-item"><span class="summary-value" style="color: var(--success-color);">${shippedCount}</span><span class="summary-label">ì¶œê³ ì™„ë£Œ</span></div>
            `;

            if (filteredOrders.length === 0) {
                tableContainer.innerHTML = '<div style="text-align: center; padding: 40px; color: #7f8c8d;">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
                return;
            }

            // ì¶œê³ ìš”ì²­ì¼ ê¸°ì¤€ ì •ë ¬
            filteredOrders.sort((a, b) => {
                if (!a.releaseDate && !b.releaseDate) return 0;
                if (!a.releaseDate) return 1;
                if (!b.releaseDate) return -1;
                return a.releaseDate.localeCompare(b.releaseDate);
            });

            // í…Œì´ë¸” ìƒì„±
            let html = `
                <table style="width: 100%; border-collapse: collapse; font-size: 12px;">
                    <thead style="position: sticky; top: 0; background: white;">
                        <tr style="background: #f8f9fa;">
                            <th style="padding: 8px; border: 1px solid #dee2e6;">ë‹´ë‹¹ì</th>
                            <th style="padding: 8px; border: 1px solid #dee2e6;">ë°œì£¼ì²˜</th>
                            <th style="padding: 8px; border: 1px solid #dee2e6;">ì¶œê³ ìš”ì²­ì¼</th>
                            <th style="padding: 8px; border: 1px solid #dee2e6;">SKUìƒí’ˆëª…</th>
                            <th style="padding: 8px; border: 1px solid #dee2e6;">ìˆ˜ëŸ‰</th>
                            <th style="padding: 8px; border: 1px solid #dee2e6;">ìˆ˜ë ¹ì¸</th>
                            <th style="padding: 8px; border: 1px solid #dee2e6;">ì—°ë½ì²˜</th>
                            <th style="padding: 8px; border: 1px solid #dee2e6;">ì£¼ì†Œ</th>
                            <th style="padding: 8px; border: 1px solid #dee2e6;">ì¶œê³ </th>
                            <th style="padding: 8px; border: 1px solid #dee2e6;">ê²°ì œ</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            filteredOrders.forEach(item => {
                const isShipped = item._shipped;
                const rowStyle = isShipped ? 'background: #f5f5f5; color: #999;' : '';

                html += `
                    <tr style="${rowStyle}">
                        <td style="padding: 6px 8px; border: 1px solid #dee2e6;"><span style="background: #e3f2fd; padding: 2px 6px; border-radius: 3px; font-size: 11px;">${escapeHtml(item._userId)}</span></td>
                        <td style="padding: 6px 8px; border: 1px solid #dee2e6;">${escapeHtml(item.vendor || '-')}</td>
                        <td style="padding: 6px 8px; border: 1px solid #dee2e6;">${item.releaseDate || '-'}</td>
                        <td style="padding: 6px 8px; border: 1px solid #dee2e6;">${escapeHtml(item.skuName || item.productName || '-')}</td>
                        <td style="padding: 6px 8px; border: 1px solid #dee2e6; text-align: center;">${item.quantity || 1}</td>
                        <td style="padding: 6px 8px; border: 1px solid #dee2e6;">${escapeHtml(item.receiverName || '-')}</td>
                        <td style="padding: 6px 8px; border: 1px solid #dee2e6;">${escapeHtml(item.receiverPhone || '-')}</td>
                        <td style="padding: 6px 8px; border: 1px solid #dee2e6; max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${escapeHtml(item.receiverAddr || '-')}</td>
                        <td style="padding: 6px 8px; border: 1px solid #dee2e6; text-align: center;"><span class="status-badge ${isShipped ? 'shipped' : 'pending'}">${isShipped ? 'ì™„ë£Œ' : 'ëŒ€ê¸°'}</span></td>
                        <td style="padding: 6px 8px; border: 1px solid #dee2e6; text-align: center;"><span class="status-badge ${item._paid ? 'paid' : 'unpaid'}">${item._paid ? 'ì™„ë£Œ' : 'ëŒ€ê¸°'}</span></td>
                    </tr>
                `;
            });

            html += '</tbody></table>';
            tableContainer.innerHTML = html;
        }

        // í†µí•©ì¡°íšŒ í•„í„° ì ìš©
        function applyIntegratedFilters() {
            renderIntegratedView();
        }
        window.applyIntegratedFilters = applyIntegratedFilters;

        // í†µí•©ì¡°íšŒ ì—‘ì…€ ë‹¤ìš´ë¡œë“œ
        function downloadIntegratedExcel() {
            let allOrders = [];
            Object.keys(allUsersData).forEach(userId => {
                const userData = allUsersData[userId];
                if (!userData || !userData.orderManagementData) return;

                userData.orderManagementData.forEach(item => {
                    allOrders.push({
                        ...item,
                        _userId: userId
                    });
                });
            });

            if (allOrders.length === 0) {
                alert('ë‹¤ìš´ë¡œë“œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            const rows = [['ë‹´ë‹¹ì', 'ë°œì£¼ì²˜', 'ì¶œê³ ìš”ì²­ì¼', 'SKUìƒí’ˆëª…', 'ìˆ˜ëŸ‰', 'ìˆ˜ë ¹ì¸', 'ì—°ë½ì²˜', 'ì£¼ì†Œ', 'ì¶œê³ ìƒíƒœ', 'ê²°ì œìƒíƒœ']];
            allOrders.forEach(item => {
                rows.push([
                    item._userId,
                    item.vendor || '',
                    item.releaseDate || '',
                    item.skuName || item.productName || '',
                    item.quantity || 1,
                    item.receiverName || '',
                    item.receiverPhone || '',
                    item.receiverAddr || '',
                    item._shipped ? 'ì™„ë£Œ' : 'ëŒ€ê¸°',
                    item._paid ? 'ì™„ë£Œ' : 'ëŒ€ê¸°'
                ]);
            });

            const ws = XLSX.utils.aoa_to_sheet(rows);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'í†µí•©ì¡°íšŒ');

            const today = formatDateKey(new Date());
            XLSX.writeFile(wb, `í†µí•©ì¡°íšŒ_${today}.xlsx`);
        }
        window.downloadIntegratedExcel = downloadIntegratedExcel;

        // í†µí•© ì§‘ê³„
        function aggregateIntegratedView() {
            let allOrders = [];
            Object.keys(allUsersData).forEach(userId => {
                const userData = allUsersData[userId];
                if (!userData || !userData.orderManagementData) return;

                userData.orderManagementData.forEach(item => {
                    allOrders.push({
                        ...item,
                        _userId: userId
                    });
                });
            });

            if (allOrders.length === 0) {
                alert('ì§‘ê³„í•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            // ì§‘ê³„ (ë°œì£¼ì²˜ + SKUìƒí’ˆëª… + ë‹¨ê°€)
            const groups = {};
            allOrders.forEach(item => {
                const vendor = item.vendor || '(ë°œì£¼ì²˜ ì—†ìŒ)';
                let skuName = item.skuName || item.productName || '(ìƒí’ˆëª… ì—†ìŒ)';
                skuName = skuName.replace(/ - \d+ê°œ$/, '');

                let unitPrice = parseInt(item._unitPrice) || 0;
                if (!unitPrice) {
                    if (item.vendor && item.productCode && vendorMappings[item.vendor]) {
                        const mapping = vendorMappings[item.vendor].find(m => m.productCode === item.productCode);
                        if (mapping && mapping.sellingPrice) unitPrice = mapping.sellingPrice;
                    }
                    if (!unitPrice && item._skuProductId) {
                        const sku = skuProducts.find(p => p.id === item._skuProductId);
                        if (sku && sku.sellingPrice) unitPrice = sku.sellingPrice;
                    }
                }

                const originalQty = parseInt(item._originalQuantity || item.quantity) || 1;
                const key = `${vendor}||${skuName}||${unitPrice}`;

                if (!groups[key]) {
                    groups[key] = { vendor, skuName, unitPrice, quantity: 0, totalPrice: 0 };
                }
                groups[key].quantity += originalQty;
                groups[key].totalPrice += unitPrice * originalQty;
            });

            const aggregated = Object.values(groups).sort((a, b) => {
                if (a.vendor !== b.vendor) return a.vendor.localeCompare(b.vendor, 'ko');
                return a.skuName.localeCompare(b.skuName, 'ko');
            });

            // ëª¨ë‹¬ í‘œì‹œ (aggregate-modal ì¬ì‚¬ìš©)
            aggregateData = aggregated;
            const grandTotalQty = aggregated.reduce((sum, item) => sum + item.quantity, 0);
            const grandTotalPrice = aggregated.reduce((sum, item) => sum + item.totalPrice, 0);

            let html = `
                <table style="width: 100%; border-collapse: collapse; font-size: 13px;">
                    <thead>
                        <tr style="background: #f8f9fa;">
                            <th style="padding: 10px; border: 1px solid #dee2e6; text-align: left;">ë°œì£¼ì²˜</th>
                            <th style="padding: 10px; border: 1px solid #dee2e6; text-align: left;">SKUìƒí’ˆëª…</th>
                            <th style="padding: 10px; border: 1px solid #dee2e6; text-align: right;">ìˆ˜ëŸ‰</th>
                            <th style="padding: 10px; border: 1px solid #dee2e6; text-align: right;">ë‹¨ê°€</th>
                            <th style="padding: 10px; border: 1px solid #dee2e6; text-align: right;">ì´í•©ê³„</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            let currentVendor = null;
            aggregated.forEach(item => {
                const vendorChanged = item.vendor !== currentVendor;
                currentVendor = item.vendor;
                html += `
                    <tr${vendorChanged ? ' style="border-top: 2px solid #adb5bd;"' : ''}>
                        <td style="padding: 8px; border: 1px solid #dee2e6;">${vendorChanged ? escapeHtml(item.vendor) : ''}</td>
                        <td style="padding: 8px; border: 1px solid #dee2e6;">${escapeHtml(item.skuName)}</td>
                        <td style="padding: 8px; border: 1px solid #dee2e6; text-align: right;">${item.quantity.toLocaleString()}</td>
                        <td style="padding: 8px; border: 1px solid #dee2e6; text-align: right;">${item.unitPrice.toLocaleString()}ì›</td>
                        <td style="padding: 8px; border: 1px solid #dee2e6; text-align: right; font-weight: 600;">${item.totalPrice.toLocaleString()}ì›</td>
                    </tr>
                `;
            });

            html += `
                    </tbody>
                    <tfoot>
                        <tr style="background: #e9ecef; font-weight: 700;">
                            <td colspan="2" style="padding: 10px; border: 1px solid #dee2e6; text-align: center;">í•©ê³„</td>
                            <td style="padding: 10px; border: 1px solid #dee2e6; text-align: right;">${grandTotalQty.toLocaleString()}</td>
                            <td style="padding: 10px; border: 1px solid #dee2e6; text-align: right;">-</td>
                            <td style="padding: 10px; border: 1px solid #dee2e6; text-align: right;">${grandTotalPrice.toLocaleString()}ì›</td>
                        </tr>
                    </tfoot>
                </table>
            `;

            document.getElementById('aggregate-modal-title').textContent = `í†µí•© ì§‘ê³„ ê²°ê³¼ (${allOrders.length}ê±´, ${aggregated.length}ê°œ ê·¸ë£¹)`;
            document.getElementById('aggregate-modal-content').innerHTML = html;
            document.getElementById('aggregate-modal').classList.add('show');
        }
        window.aggregateIntegratedView = aggregateIntegratedView;

        // ìœ í‹¸ë¦¬í‹°
        function showStatus(element, message, type) {
            element.textContent = message;
            element.className = `status show ${type}`;
            setTimeout(() => element.classList.remove('show'), 5000);
        }

        function showLoading(show) {
            loading.classList.toggle('show', show);
        }
    </script>
</body>
</html>
